name: "Source Build"
on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  build:
    strategy:
      matrix:
        build_bf: [false]
        build_zarr: [true]
    name: Build OMERO from source
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: ome/action-ice@v1
      - name: Install and run flake8
        run: |
          pip install flake8
          flake8 .
      - name: install dependencies
        run: |
          sudo apt-get install -y git maven wget
      - name: Build Bio-Formats
        if: matrix.build_bf
        run: |
          git clone https://github.com/ome/bioformats /tmp/bioformats --depth 1
          cd /tmp/bioformats
          mvn install -DskipTests
      - name: Build ZarrReader
        if: matrix.build_zarr
        run: |
          git clone -b dependency-updates https://github.com/dgault/ZarrReader /tmp/ZarrReader
          cd /tmp/ZarrReader
          mvn install -DskipTests
      - name: Build OMERO
        run: ./build.py
      - name: Rebuild
        run: ./build.py clean && ./build.py
