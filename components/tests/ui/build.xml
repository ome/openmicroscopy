<?xml version="1.0" encoding="utf-8"?>
<project name="ui-scripts" default="install" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# Copyright 2012-3 Glencoe Software, Inc. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore, josh at glencoesoftware.com
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-->
    <description>
        The from-a-distance automated operations on OMERO client UIs
        that are performed by Robot Framework. At present this build
        file simply compiles the Java source for custom script
        keywords.
    </description>

    <macrodef name="run_py">
        <attribute name="failonerror" default="true"/>
        <element name="args" implicit="true"/>
        <sequential>
            <exec executable="python" failonerror="@{failonerror}">
                <args/>
            </exec>
        </sequential>
    </macrodef>

    <!-- reports for the web tests. -->
    <property name="reports.web" value="${basedir}/target/reports/web"/>

    <!-- reports for the insight tests. -->
    <property name="reports.insight" value="${basedir}/target/reports/insight"/>


    <property name="main.class" value="NONE"/>

    <property name="import.dir" value="${basedir}/../../antlib/resources"/>

    <property name="target.dir" value="${basedir}/../../../target/repository"/>

    <import file="${import.dir}/global.xml"/>
    <import file="${import.dir}/lifecycle.xml"/>

   <!-- compile the unit tests under library/java/test -->
    <target name="test-compile" description=""/>

    <!--  run the web and insight tests -->
    <target name="ui-test-all" unless="env.NOPYTHON" depends="clean">
        <antcall target="ui-test-insight" inheritRefs="true" inheritAll="true"/>
        <antcall target="ui-test-web" inheritRefs="true" inheritAll="true"/>
    </target>

    <!--  run the insight tests -->
    <target name="ui-test-insight">
        <mkdir dir="${reports.insight}" />
        <run_py>
            <env key="PYTHONPATH" path="test:build/lib:${basedir}/../target/lib/python:${env.PYTHONPATH}"/>
            <env key="CLASSPATH" path="${lib.dir}/repository/*:${target.dir}/*"/>
            <arg file="${basedir}/run.py"/>
            <arg value="-t"/>
            <arg value="insight"/>
            <arg value="--outputdir"/>
            <arg value="${reports.insight}"/>
            <arg value="${basedir}/testcases/insight/"/>
        </run_py>
    </target>

    <!--  run the web tests -->
    <target name="ui-test-web">
        <antcall target="web-firefox" inheritRefs="true" inheritAll="true"/>
        <antcall target="web-chrome" inheritRefs="true" inheritAll="true"/>
    </target>

   <!-- test with firefox -->
    <target name="web-firefox">
        <mkdir dir="${reports.web}/firefox" />
        <run_py>
            <env key="PYTHONPATH" path="test:build/lib:${basedir}/../target/lib/python:${env.PYTHONPATH}"/>
            <arg file="${basedir}/run.py"/>
            <arg value="-t"/>
            <arg value="web"/>
            <arg value="-d"/>
            <arg value="${reports.web}/firefox"/>
            <arg value="${basedir}/testcases/web/"/>
        </run_py>
    </target>

    <!-- test with chrome This requires the chrome driver to be installed-->
    <target name="web-chrome"> 
        <mkdir dir="${reports.web}/chrome" />
        <run_py>
            <env key="PYTHONPATH" path="test:build/lib:${basedir}/../target/lib/python:${env.PYTHONPATH}"/>
            <arg file="${basedir}/run.py"/>
            <arg value="-t"/>
            <arg value="web"/>
            <arg value="-v"/>
            <arg value="browser:chrome"/>
            <arg value="-o"/>
            <arg value="${reports.web}/chrome"/>
            <arg value="${basedir}/testcases/web/"/>
        </run_py>
    </target>
   <!-- delete the reports directory -->
    <target name="tests-clean" depends="clean">
    <delete dir="${basedir}/target"/>
    </target>
</project>
