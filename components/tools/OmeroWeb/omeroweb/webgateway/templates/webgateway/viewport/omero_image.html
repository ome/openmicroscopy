{% extends "webgateway/core_html.html" %}
{% load i18n %}

{% comment %}
<!--
 omero_image - django html template

 Copyright (c) 2007-2014 Glencoe Software, Inc. All rights reserved.

 This software is distributed under the terms described by the LICENCE file
 you can find at the root of the distribution bundle, which states you are
 free to use it only for non commercial purposes.
 If the file is missing please request a copy by contacting
 jason@glencoesoftware.com.
-->
{% endcomment %}



{% block link %}

    <!-- Make the width fit the mobile viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    {% for href in extra_css %}
    <link rel="stylesheet" type="text/css" href="{{ href }}" />
    {% endfor %}
    
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.viewport.css" %}" media="all" />
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.gs_slider.css" %}" media="all" />
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/base.css" %}" media="all" />
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.snippet_header_logo.css" %}" media="all" />
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.postit.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.rangewidget.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "3rdparty/farbtastic/farbtastic.css" %}" media="all" />
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.colorbtn.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "3rdparty/JQuerySpinBtn/JQuerySpinBtn.css" %}" />
    <link rel="stylesheet" type="text/css" href="{% static "3rdparty/jquery-ui-1.8.19/jquery-ui-1.8.19.custom.css" %}" media="all" />
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/omero_image.css" %}" media="all" />
    <link rel="stylesheet" type="text/css" href="{% static "3rdparty/panojs/panojs.css" %}" media="all" />
<!--[if lte IE 9]>
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.iehacks.css" %}" media="all" />
<![endif]-->

{% endblock %}

{% block script %}

    {% for src in extra_js %}
    <script type="text/javascript" src="{{ src }}"></script>
    {% endfor %}
    
    <script type="text/javascript" src="{% static "3rdparty/jquery-1.7.2.js" %}"></script>
    
    <script type="text/javascript" src="{% static "webgateway/js/ome.popup.js" %}"></script>
    
	<script type="text/javascript" src="{% static "3rdparty/aop.js" %}"></script>

	<script type="text/javascript" src="{% static "webgateway/js/ome.gs_utils.js" %}"></script>
	<script type="text/javascript" src="{% static "webgateway/js/ome.viewportImage.js" %}"></script>
	<script type="text/javascript" src="{% static "webgateway/js/ome.gs_slider.js" %}"></script>
	<script type="text/javascript" src="{% static "webgateway/js/ome.viewport.js" %}"></script>
	
    <script type="text/javascript" src="{% static "3rdparty/jquery-ui-1.8.19/ui/jquery-ui.js" %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.smartdialog.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/JQuerySpinBtn/JQuerySpinBtn.js" %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.colorbtn.js" %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.postit.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/jquery.selectboxes.js" %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.rangewidget.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/farbtastic/farbtastic.js" %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.gs_utils.js" %}"></script>
    <!-- for display of ROIs over the image -->
    <script type="text/javascript" src="{% static "webgateway/js/ome.roidisplay.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/raphael/raphael-min.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/raphael/scale.raphael.js" %}"></script>

    <!-- big images -->

    <script type="text/javascript" src="{% static "3rdparty/panojs/extjs/ext-core.js" %}"></script>    
    <script type="text/javascript" src="{% static "3rdparty/panojs/utils.js" %}"></script>    
    <script type="text/javascript" src="{% static "3rdparty/panojs/PanoJS.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/panojs/controls.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/panojs/pyramid_Bisque.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/panojs/pyramid_imgcnv.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/panojs/pyramid_Zoomify.js" %}"></script>        
    <script type="text/javascript" src="{% static "3rdparty/panojs/control_thumbnail.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/panojs/control_info.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/panojs/control_svg.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/panojs/control_roi.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/jquery.mousewheel.js" %}"></script>
    
{% endblock %}


{% block title %}
    {{ image.getName }}
{% endblock %}


{% block head %}
    {% block header_content %}
      <div id="header"></div>
    {% endblock %}
    {% block header_menu %}
    {% endblock %}
{% endblock %}


{% block body %}

{% block full_body %}
<script type="text/javascript">
  /* <![CDATA[ */

  /**
   * The viewport object holds the image browsing viewport that has all the logic for connecting to
   * the supporting ajax server.
   */
  var viewport;
  var on_batchCopyRDefs = false;

  /**
   * Zoom input box change event handler.
   */
  function zoomCheck (i) {
    var percent = parseFloat($(i).attr('value').replace(/%/, ''));
    if (isNaN(percent)) {
      percent = 100;
    }
    /* Zoom window */
    viewport.setZoom(percent);
  }

  function hidePicker () {
    $(".picker").get(0) && $(".picker").get(0).hide_picker && $(".picker").get(0).hide_picker();
    /*$('.picker-selected').html('&nbsp;');*/
  }

  /**
   * Bound to the window resize, calculates the viewport size and top tool box positions.
   */
  var calcResize = function () {
    var dim = { height: $(window).height(),
                width: $(window).width()};

    var ts_visible = $('.figure-box').length && $('.figure-box').css('display') != "none";
    var zl = $('#z-axis-legend');
    var tl = $('#t-axis-legend');
    /* Resize the viewport */
    $.extend(dim, viewport.self.offset());

    var h = dim.height - dim.top - 33 - (ts_visible?$('.figure-box').height():0);
    var w = dim.width - dim.left  - zl.width() - {% block vpRightMargin %}0{% endblock %};

    /* The following is needed as a hack for IE */
    //TEMP CHANGE, causing extra step of tiling
    //viewport.viewport.height(10);

    viewport.self
      .height(h - tl.height())
      .width(w);
    viewport.refresh(true);


    //ts_visible &&
    $('.figure-box')
      .width(dim.width - dim.left - {% block fbCloseBtnWidth %}20{% endblock %} + zl.width())
      .css('top',viewport.self.height()+15+tl.height());

    zl.css('top', h/2 - (zl.height()/2));
    tl.css({top: h-tl.height()+15, left: (w/2)+dim.left - (tl.width()/2)});
  };

  var getMetadata = function () {
    return viewport.getMetadata();
  }

  var showChannelWindowHelp = function () {
    if (!gs_loadBlockUI (showChannelWindowHelp)) {
      return false;
    }
    $.blockUI({
      timeout: 0,
      message: $('#channel-window-help'),
{% if image.canAnnotate %}
      css: {width: '60%', left: '20%', top: '20%'}
{% else %}
      css: {width: '50%', left: '25%', top: '20%'}
{% endif %}
    });
    $('.blockMsg').attr('title','Click to close').click($.unblockUI);
    $('.blockOverlay').attr('title','Click to close').click($.unblockUI);
    return false;
  }

  var rdChanSelHelper = function (e) {
    if (!$('#rd-wblitz-rmodel').get(0).checked && viewport.getProjection() != 'split') {
      // Grey model selected and not in 'split' view, select a single channel active
      var t = $('[id^=rd-wblitz-ch]').filter(':checked');
      if (t.size() > 1) {
        if (e.checked) {
          t.filter('[id!='+e.id+']:checked').attr('checked', false);
        } else {
          t.filter(':checked').not(':first').attr('checked', false);
        }
      } else if (t.size() == 0) {
        $('[id^=rd-wblitz-ch]:first').attr('checked', true)
      }
    }
    return false;
  }

  /**
   * Gets called when an image is initially loaded.
   * This is the place to sync everything; rendering model, quality, channel buttons, etc.
   */
  var _refresh_cb = function (ev, viewport) {
    /* Sync inputs with initial values */

    $('#wblitz-rmodel').attr('checked', !viewport.isGreyModel());
    $('#wblitz-invaxis').attr('checked', viewport.loadedImg.rdefs.invertAxis);
    //$('#rd-wblitz-rmodel').attr('checked', !viewport.isGreyModel());

    var q = viewport.getQuality();
    if (q) {
      var qr = $('#wblitz-quality > [value="+q.toFixed(1)+"]');
      if (qr.length) {
        qr.attr('selected','selected');
      }
    }

    /* Prepare the channels box and the rendering definition for the channels */
    var box = $('#wblitz-channels-box');
    var channels = viewport.getChannels();
    box.empty();
    for (i=0; i<channels.length; i++) {
      box.append('<button id="wblitz-ch'+i+'"\
                 class="squared' + (channels[i].active?' pressed':'') + '"\
                 style="background-color: #'+channels[i].color+'"\
                 title="'+channels[i].label+'"\
                 onclick="viewport.toggleChannel('+i+')">'+channels[i].label+'</button>');

    }

    // disable 'split' view for single channel images.
    if (channels.length < 2) {
      $("input[value='split']").attr('disabled', 'disabled');
    }

    /* Image details */
    var tmp = getMetadata();
    $('#wblitz-image-name').html(tmp.imageName);
    $('#wblitz-image-description-content').html(tmp.imageDescription.replace(/\n/g, '<br />'));
    $('#wblitz-image-author').html(tmp.imageAuthor);
    $('#wblitz-image-pub').html(tmp.projectName);
    $('#wblitz-image-pubid').html(tmp.projectId);
    $('#wblitz-image-timestamp').html(tmp.imageTimestamp);

    $("#bulk-annotations").hide();
    $("#bulk-annotations").next().hide();
    if (tmp.wellId) {
        // Load bulk annotations for plate
        var onAnnotations = function(result) {
            if (result.data && result.data.rows) {
                var table = $("#bulk-annotations").show().next().show().children("table");
                for (var col in result.data.columns) {
                    var label = result.data.columns[col];
                    var value = '';
                    for (var row in result.data.rows) {
                        value += result.data.rows[row][col] + '<br />';
                    }
                    var row = $('<tr><td class="title"></td><td></td></tr>');
                    row.addClass(col % 2 == 1 ? 'odd' : 'even');
                    $('td:first-child', row).html(label + ":&nbsp;");
                    $('td:last-child', row).html(value);
                    table.append(row);
                }
            }
        };
        $.getJSON('{% url 'webgateway_object_table_query' 'Plate.wells' 999 %}'.replace('999', tmp.wellId) +
            '?query=Well-' + tmp.wellId +
            '&callback=?',
             onAnnotations);
        $.getJSON('{% url 'webgateway_object_table_query' 'Screen.plateLinks.child.wells' 999 %}'.replace('999', tmp.wellId) +
            '?query=Well-' + tmp.wellId +
            '&callback=?',
             onAnnotations);
    }

    {% block xtra_metadata %}{% endblock %}

    /*$('#wblitz-shortname').attr('title', tmp.imageName).html(gs_text_trim(tmp.imageName, 15, true));*/

    tmp = viewport.getSizes();
    $('#wblitz-image-width').html(tmp.width);
    $('#wblitz-image-height').html(tmp.height);
    $('#wblitz-image-z-count').html(tmp.z);
    $('#wblitz-image-t-count').html(tmp.t);
    tmp = viewport.getPixelSizes();
    $('#wblitz-image-pixel-size-x').html(tmp.x==0?'-':(tmp.x.lengthformat()));
    $('#wblitz-image-pixel-size-y').html(tmp.y==0?'-':(tmp.y.lengthformat()));
    $('#wblitz-image-pixel-size-z').html(tmp.z==0?'-':(tmp.z.lengthformat()));

    /* Fill in the Rendering Details box */

    $(".picker").unbind('prepared').unbind('showing').unbind('hiding');
    $('#rdef-postit ul').not('ul:last-child').remove();

    var template = '<tr class="$cls">'
      + '<td><input id="rd-wblitz-ch$idx0" type="checkbox" onchange="rdChanSelHelper(this)" $act></td>'
      + '<td>$cwl</td>'
      + '<td><button id="wblitz-ch$idx0-color" class="picker squarred">&nbsp;</button></td>'
      + '<td class="picker-selected">&nbsp;</td></tr>'
      + '<tr class="$cls rdef-window">'
        + '<td colspan="5"><div id="wblitz-ch$idx0-cw" class="rangewidget"></div></td>'
        +'</tr>'
      + '<tr class="$cls rdef-window">'
        + '<td colspan="5"><div class="rangeslider" id="wblitz-ch$idx0-cwslider"></div></td>'
        + '</tr>';

    tmp = $('#rdef-postit table tr:first');
    tmp.siblings().remove();
    for (i=channels.length-1; i>=0; i--) {
      tmp.after(template
      .replace(/\$act/g, channels[i].active?'checked':'')
      .replace(/\$idx0/g, i) // Channel Index, 0 based
      .replace(/\$idx1/g, i+1) // Channel Index, 1 based
      .replace(/\$cwl/g, channels[i].label) // Wavelength
      .replace(/\$cls/g, i/2!=parseInt(i/2)?'even':'odd') // class
      );
      $('#wblitz-ch'+(i)+'-cw').rangewidget({
	min: channels[i].window.min,
	max: channels[i].window.max,
        template: '<span class="min">min: $min</span> $start - $end <span class="max">max: $max</span>',
        lblStart: '',
        lblEnd: ''});
      $('#wblitz-ch'+i+'-cwslider').slider({
        range: true,
        min: Math.min(channels[i].window.min, channels[i].window.start+1),  // range may extend outside min/max pixel
        max: Math.max(channels[i].window.max, channels[i].window.end-1),
        values: [ channels[i].window.start+1, channels[i].window.end-1 ],
        slide: function(event, ui) {
          $('#wblitz-ch'+$(event.target).data('channel-idx')+'-cw-start').val(ui.values[0]).change();
          $('#wblitz-ch'+$(event.target).data('channel-idx')+'-cw-end').val(ui.values[1]).change();
        }
        }).data('channel-idx', i);
      cb = function (i) {
        return function (e) {
          var new_start = e.target.value,
              $sl = $('#wblitz-ch'+i+'-cwslider'),
              end = $sl.slider('values')[1]
              min = $sl.slider( "option", "min" );
          $sl.slider('values', 0, Math.min(new_start, end));    // ensure start < end
          $sl.slider( "option", "min", Math.min(min, new_start) );   // extend range if needed
          show_change($('#wblitz-ch'+i+'-cw-start').get(0), channels[i].window.start, 'changed');
        };
      }
      $('#wblitz-ch'+i+'-cw-start').val(channels[i].window.start).unbind('change').bind('change', cb(i));
      cb = function (i) {
        return function (e) {
          var new_end = e.target.value,
              $sl = $('#wblitz-ch'+i+'-cwslider'),
              start = $sl.slider('values')[0]
              max = $sl.slider( "option", "max" );
          $sl.slider('values', 1, Math.max(new_end, start));    // ensure end > start
          $sl.slider( "option", "max", Math.max(max, new_end) );   // extend range if needed
          show_change($('#wblitz-ch'+i+'-cw-end').get(0), channels[i].window.end, 'changed');
        };
      }
      $('#wblitz-ch'+i+'-cw-end').val(channels[i].window.end).unbind('change').bind('change', cb(i));
    }


    /* Prepare color picker buttons */
    $(".picker")
      .colorbtn()
      .bind('showing', function () {
          var t = $(this).parents('.postit');
          var offset = t.offset();
          offset.left += t.width();
          $('#cbpicker-box').css(offset);
          $('.picker-selected').html('&nbsp;');
          $(this).parent().siblings('.picker-selected').html('&gt;');
      })
      .bind('hiding', function () {$(this).parent().siblings('.picker-selected').html('&nbsp;')})
      .bind('prepared', function () {
        zindex_automator('.postit', 210, $('#cbpicker-box'));
      })
      .bind('changed', function () {
          $("#rd-wblitz-rmodel").attr('checked', true);     // if we're updating color - show color (not greyscale)
        $(this).parents('tr:first').next().find('.ui-slider-range').css('background-color', $(this).css('background-color'));
      });

    projectionChange(null,null, true);

    modelChange();
    syncRDCW();
        
    $('#wblitz-workarea > .box > div.row').show();
  };

  /**
   * Set the projection based on the clicked element name.
   */
  var setProjection = function (obj) {
    viewport.setProjection($(obj).attr('value'));
  };
          
  /**
   * Checks the currently selected rendering projection and applies interface customizations as needed.
   * Bound to the viewport projectionChange event.
   */
  var projectionChange = function (ev, obj, nosync) {
    var p = viewport.getProjection();
    if (p) {
      $('[name="wblitz-proj"]').parent().removeClass('selected');
      $('[name="wblitz-proj"][value='+p+']').click().parent().addClass('selected');
//    if (p) {
//      var pr = $('#wblitz-proj > [value='+p+']');
//      if (pr.length) {
//        pr.attr('selected','selected');
//      }
      if (p != 'normal') {
        editLinePlot(false);
      }
      // disable line-plot for max projection, split-view etc
      $('#wblitz-lp-enable').attr('disabled', p != 'normal');
      //$('#wblitz-channels-box button').attr('disabled', p == 'split');
      var disable_intmax = (viewport.loadedImg.rdefs.invertAxis || viewport.getSizes().z < 2);
      $('[name="wblitz-proj"][value=intmax]').attr('disabled', disable_intmax);
    }
    
    //nosync || syncRDCW();
  };

  /**
   * Checks the currently selected rendering model and applies interface customizations as needed.
   * Bound to the viewport modelChange event.
   */
  var modelChange = function (ev, obj) {
    var btns = $('button[id^=wblitz-ch]').not('[id$=color]');
    if (viewport.isGreyModel()) {
      btns.addClass('forcegrey');
    } else {
      btns.removeClass('forcegrey');
    }
    $('#wblitz-rmodel').attr('checked', !viewport.isGreyModel());
    //$('#rd-wblitz-rmodel').attr('checked', !viewport.isGreyModel());
    //syncRDCW();
  };

  /**
   *
   */
  var channelChange = function (ev, obj, idx, ch) {
    if (ch.active) {
      $('#wblitz-ch'+idx).addClass('pressed');
    } else {
      $('#wblitz-ch'+idx).removeClass('pressed');
    }
    //var t = $('#rd-wblitz-ch'+idx).get(0);
    //if (t != undefined) t.checked=ch.active;
    $('#wblitz-ch'+idx).css('background-color', ch.color).attr('title', ch.label);
  };

  /**
   *
   */
  var linePlotChange = function (ev, show) {
    if (show) {
      if (!viewport.hasLinePlot()) {
        viewport.startPickPos();
      }
      var lp = viewport.getLinePlot();
      $('#wblitz-lp-axis').html(lp.isHorizontal() ? 'Y': 'X');
      $('#wblitz-lp-enable').attr('checked', 'checked');
      $('#wblitz-lp-editpos').val(lp.position).show();
      $('#wblitz-lp-wrap').show();
      $('#wblitz-lp-btn').html('apply');
      $('#wblitz-lp-axis-select').selectOptions(lp.isHorizontal() ? 'h': 'v');
    } else {
      viewport.stopPickPos();
      $('#wblitz-lp-enable').attr('checked', null);
      $('#wblitz-lp-wrap').hide();
      $('#wblitz-lp-cur').html('');
    }
  }

  var editLinePlot = function (show) {
    if (show) {
      viewport.prepareLinePlot($('#wblitz-lp-axis-select option[selected]').val() || 'h');
    } else {
      viewport.hidePlot();
    }
    linePlotChange(null, show);
  }

  var prepLinePlot = function (val) {
    viewport.prepareLinePlot(val);
    $('#wblitz-lp-axis').html(viewport.getLinePlot().isHorizontal() ? 'Y': 'X');
  }

  var showLinePlot = function () {
    viewport.loadPlot(parseInt($('#wblitz-lp-editpos').val()));
    $('#wblitz-lp-cur').html('showing: ' + (viewport.getLinePlot().isHorizontal() ? 'Y': 'X') + ' = ' + parseInt($('#wblitz-lp-editpos').val()));
  }

  /**
   *
   */
  var imageChange = function (ev, obj) {
    $('#wblitz-t-curr').html(viewport.getTPos());
    $('#wblitz-z-curr').html(viewport.getZPos());
    $('#wblitz-t-count').html(viewport.getTCount());
    $('#wblitz-z-count').html(viewport.getZCount());

    if(viewport.loadedImg.rdefs.invertAxis) {
      $('#z-axis-legend').attr('src', '{% static "webgateway/img/t_axis_revert.gif" %}');
      $('#t-axis-legend').attr('src', '{% static "webgateway/img/z_axis_revert.gif" %}');
    } else {
      $('#z-axis-legend').attr('src', '{% static "webgateway/img/z_axis.gif" %}');
      $('#t-axis-legend').attr('src', '{% static "webgateway/img/t_axis.gif" %}');
    };

    if (viewport.hasLinePlot() || $('#wblitz-lp-enable').attr('checked')) {
      viewport.refreshPlot();
    }
  };
  
  /**
  *     ROI load & table methods 
  */

  var refresh_rois = function () {
      // re-plots the ROIs (if currently shown) for new Z and T position
      if (viewport.viewportimg.get(0).refresh_rois) {
          var theT = viewport.getTPos();
          var theZ = viewport.getZPos();
          viewport.viewportimg.get(0).refresh_rois(theZ, theT);
      }
  }
  var show_rois = function () {
      var theT = viewport.getTPos();
        var theZ = viewport.getZPos();
        
      {% if image %}
        // if the ROI plugin has not been initialised (method not available...) init and load ROIs...
      if (!viewport.viewportimg.get(0).show_rois) {
          var options = {'width':{{ image.getSizeX }}, 
                     'height':{{ image.getSizeY }},
                     'json_url':'{% url 'webgateway_get_rois_json' image.id %}'};
          if (viewport.loadedImg.tiles) {
              options['tiles'] = true;
              options['canvas_name'] = 'roi_canvas_big';
          }
          viewport.viewportimg.roi_display(options);
          viewport.viewportimg.get(0).setRoiZoom(viewport.viewportimg.get(0).getZoom());
      }
      {% endif %}
      
      // Show postit. Table will be built on callback from loading
      $("#roi_table_postit").show();

      // loads ROIs (if needed) and shows. 
    viewport.viewportimg.get(0).show_rois(theZ, theT);
  }
  
  
  var hide_rois = function() {
      // hides the display of ROIs. 
      if (viewport.viewportimg.get(0).hide_rois) {
          viewport.viewportimg.get(0).hide_rois();
      }
      $("#roi_table_postit").hide();
  }
  
  var NOZT = "";
  // builds an html table of ROI data. All collapsed.
  var build_roi_table = function() {
      var $roi_table = $("#roi_small_table");
      var json = viewport.viewportimg.get(0).get_roi_json();
      
      $roi_table.find('tbody').remove();
      
      // give users a small selection of colours for lines on roi_thumbnails
      var colours = {'red':'#f00', 'white':'#fff', 'black':'#000', 'blue':'#00f', 'green':'#0f0', 'yellow':'#ff0'}
      var color_picker = "";
      for (var c in colours) {
          color_picker += "<div class='color_picker_option' color='" + colours[c] + "' style='background: " + colours[c] + "'> </div>";
      }
      var toggle_roi_thumbs = "<input type='checkbox' id='toggle_roi_thumbs' title='Show ROI Previews' />";
      var toggle_shape_text = "<input type='checkbox' id='toggle_shape_text' checked='true' title='Show/Hide ROI text labels' />";
      
      // thead for whole table:
      var roi_html = "<thead id='roi_table_head'><tr>";
      roi_html += "<th></th>";
      roi_html += "<th></th>"; // first shape (count)
      roi_html += "<th>ID</th>";
      roi_html += "<th>Z</th>"; // no Z for ROI
      roi_html += "<th>T</th>"; // no T for ROI
      roi_html += "<th>" + toggle_shape_text + " Text</th>";
      roi_html += "<th title='Pick colour of ROI outlines'><div style='white-space:nowrap;'>" + toggle_roi_thumbs + "Preview</div>"+ color_picker + "</th>";
      roi_html += "</tr></thead>";
      $roi_table.append($(roi_html));
      
      get_shape_icon_src = function(type, klass) {
          var shape_icons = {'Line':'line16.png', 'Ellipse':'ellipse16.png', 'Polygon':'polygon16.png', 'Rectangle':'rectangle16.png',
            'Point':'point16.png', 'Label':'text16.png', 'PolyLine':'line16.png'}
          if (type in shape_icons) {
              return "<img class='"+ klass +"' src='{% static 'webgateway/img/' %}" + shape_icons[type] + "' />";
          }
          return "";
      }
      var truncate_length = 30;
      truncate_text = function(text_string) {
          if (text_string.length < truncate_length)
              return text_string
          return text_string.substring(0,truncate_length) + "...";
      }
      // populate table. Cols are: ID, Z, T, Shape, text
      for (var r=0; r<json.length; r++) {
          var roi = json[r];
          var shapes = roi['shapes'];
          
          // thumbnail of roi - display small & popup full-size
          var line_color = 'f00';   // store current line color, used when we 'show' thumbs to get url. 
          var roiThumbHtml = "<img src='' id='"+ roi['id'] +"_roi_thumb' color='"+ line_color +"' width=50 height=33 class='roi_thumb'>";
          
          // process the shapes first - note first shape & text
          var roiIcon = null;
          var roiText = "";
          var minT = maxT = minZ = maxZ = null;
          var shapesHtml = '<tbody>';
          var shape = null;
          var text, tRange, zRange;
          for (var s=0; s<shapes.length; s++) {
              shape = shapes[s];
              // Handle cases where the shape is on all sections or all
              // timepoints.
              if (typeof shape.theT === "undefined") {
                  tRange = NOZT;
              } else {
                  if (minT === null || minT > shape.theT) minT = shape.theT;
                  if (maxT === null || maxT < shape.theT) maxT = shape.theT;
              }
              if (typeof shape.theZ === "undefined") {
                  zRange = NOZT;
              } else {
                  if (minZ === null || minZ > shape.theZ) minZ = shape.theZ;
                  if (maxZ === null || maxZ < shape.theZ) maxZ = shape.theZ;
              }
              if (shape['textValue'] != null) {
                  text = shape['textValue']
                  if (shapes.length == 1) roiText = text;
              } else text = "";
              var indent = " &nbsp&nbsp&nbsp&nbsp";    // hack to add "indent", but not if shape is only-child
              if (shapes.length == 1) {
                  indent = " &nbsp";
              }
              var shapeThumbHtml = "<img src='' id='"+ shape['id'] +"_shape_thumb' color='"+ line_color +"' width=50 height=33 class='roi_thumb shape_thumb'>";
              
              shapesHtml += "<tr id='"+shape['id']+"_shape' class='shape_row'>";
              // clicking on any cell of a shape 'shape_cell' selects it
              shapesHtml += "<td></td>";
              shapesHtml += "<td class='shape_cell icon'>" + indent + get_shape_icon_src(shape['type'], 'shape_icon') + "</td>";
              shapesHtml += "<td class='shape_cell'>" + shape['id'] + "</td>"
              var theZ =
                  typeof shape.theZ === "undefined"? NOZT : shape.theZ + 1;
              shapesHtml += "<td class='shape_cell'>" + theZ + "</td>";
              var theT =
                  typeof shape.theT === "undefined"? NOZT : shape.theT + 1;
              shapesHtml += "<td class='shape_cell'>" + theT + "</td>";
              shapesHtml += "<td class='shape_cell shape_text' title=\""+ text +"\"><p>"+ truncate_text(text) + "</p></td>";
              shapesHtml += "<td class='shape_cell'>" + shapeThumbHtml + "</td>";
              shapesHtml += "</tr>";
              if (roiIcon == null) roiIcon = shape['type'];
              else if (roiIcon != shape['type']) roiIcon = "";    // mixture of shapes - show no icon
          }
          if (roiText == null) roiText = "";
          shapesHtml += '</tbody>';
          
          // new tbody for each ROI
          if (tRange != NOZT) tRange = "" + (minZ+1) + ((maxZ != minZ) && ("-"+(maxZ+1)) || (""));
          if (zRange != NOZT) zRange = "" + (minT+1) + ((maxT != minT) && ("-"+(maxT+1)) || (""));
          var roi_html = "<thead><tr class='roi_row'>";
          roi_html += "<th><img class='expand_arrow' src='{% static "webgateway/img/arrowRight_grey.png" %}' /></th>";
          roi_html += "<th align='left'> &nbsp"+ get_shape_icon_src(roiIcon, 'roi_icon') + " (" + shapes.length + ")</th>"; // first shape (count)
          roi_html += "<th>" + roi['id'] + "</th>";
          roi_html += "<th style='white-space: nowrap'> "+ tRange +" </th>"; // no Z for ROI
          roi_html += "<th style='white-space: nowrap'> "+ zRange +" </th>"; // no T for ROI
          roi_html += "<th class='shape_text' title=\""+ roiText +"\"><p>"+ truncate_text(roiText) +"</p></th>";
          roi_html += "<th>"+ roiThumbHtml +"</th>";
          roi_html += "</tr></thead>";
          
          var tbody = $(shapesHtml);
          if (shapes.length > 1) {
              $roi_table.append($(roi_html));      // add the roi thead
          } else {
              tbody.addClass('only_child');
          }
          $roi_table.append(tbody);    // add the tbody
          
          // now bind mouseover
          var $roi_thumb_popup = $('#roi_thumb_popup');
          $('.roi_thumb').hover(function(e) {
              $roi_thumb_popup.attr('src', $(this).attr('src')).show();
          }, function(e){
              $roi_thumb_popup.hide();
          })
            .hide();    // don't show thumbs initially
          $('.roi_thumb').mousemove(function(e) {
                $roi_thumb_popup.css({ 'left': e.pageX+5, 'top': e.pageY+5 })
          });
      }
  }
  
  // bound to call-back on roi plugin when ROIs loaded
  var handle_rois_loaded = function(e) {
      $("#rois_loading_message").hide();
      build_roi_table();
      var $roi_table = $("#roi_small_table");
      $roi_table.find('tbody').hide();  // hides the shapes
      $roi_table.find('tbody.only_child').show();

  }
  
  // bound to clicks on shapes in the viewer
    var handle_shape_selection = function(e, shape_id) {
        var $roi_table = $("#roi_small_table");
        // show the rows
        var $row = $("#"+shape_id+"_shape");
        $roi_table.find('tbody').children().children().css('background-color', '');// all rows white...
        $row.children().css('background-color', '#d0d0ff');      // ...show this row blue
        $row.parent().show();   // show this 'tbody' set of shapes
        var arrow_src = '{% static "webgateway/img/arrowDown_grey.png" %}';
        $row.parent().prev('thead').find('img.expand_arrow').attr('src', arrow_src);
    }
    
    // update src of roi_thumbnails, based on colour. If 'null', set no src and hide thumbs
    var update_roi_thumbs = function(line_color) {
        // we set visibility based on 'toggle_roi_thumbs' checkbox
        var vis = ($("#toggle_roi_thumbs").is(":checked"));
        var update_thumbs = function() {
            var $thmb = $(this);
            if (vis) {
                if ((typeof line_color == 'undefined') || (line_color == null)) {
                    // update src based on color attribute
                    line_color = $thmb.attr('color');
                } else {
                    $thmb.attr('color', line_color);
                }
                var thmb_id = parseInt($thmb.attr('id'));
                var thmb_src = "{% url 'webgateway.views.render_roi_thumbnail' 0 %}"+ thmb_id +"/?color=" + line_color;
                if ($thmb.hasClass('shape_thumb')) {
                    thmb_src = "{% url 'webgateway.views.render_shape_thumbnail' 0 %}"+ thmb_id +"/?color=" + line_color;
                }
                $thmb.attr('src', thmb_src);
                $thmb.show();
            } else {
                // hide thumb and remove src (don't load thumbs)
                $thmb.attr('src', '');
                $thmb.hide();
            }2
        }
        $('.roi_thumb').each(update_thumbs);
        //$('.shape_thumb').each(update_thumbs);
    }

  var linePlotPos = function (ev, obj) {
    $('#wblitz-lp-editpos').val(obj);
    showLinePlot();
  };

  function resetRDCW() {
    viewport.reset_channels();
    syncRDCW();
  }

  function syncRDCW() {
    var cb;
    var channels = viewport.getChannels();
    for (i=0; i<channels.length; i++) {
      $('#rd-wblitz-ch'+i).get(0).checked = channels[i].active;
      $('#wblitz-ch'+i+'-cwslider .ui-slider-range').css('background-color', toRGB(channels[i].color));
      var w = channels[i].window;
      $('#wblitz-ch'+i+'-cwslider')
          .slider( "option", "min", Math.min(w.min, w.start) )   // extend range if needed
          .slider( "option", "max", Math.max(w.max, w.end) );
      $('#wblitz-ch'+i+'-color').css('background-color', toRGB(channels[i].color));//$('#wblitz-ch'+i).css('background-color'));
      $('#wblitz-ch'+i+'-cw-start').val(channels[i].window.start).change();
      $('#wblitz-ch'+i+'-cw-end').val(channels[i].window.end).change();
    }
    hidePicker();
    $('#rdef-undo-btn').attr('disabled',viewport.has_channels_undo()?'':'true');
    $('#rdef-redo-btn').attr('disabled',viewport.has_channels_redo()?'':'true');
    //$('#rdef-default-btn').attr('disabled',viewport.has_channels_undo()?'':'true');
    $('#rd-wblitz-rmodel').attr('checked', !viewport.isGreyModel());
  }

  function undoRDCW () {
    viewport.undo_channels();
    syncRDCW();
  }

  function redoRDCW () {
    if (on_batchCopyRDefs) {
      return batchCopyRDefs_action('cancel');
    }
    viewport.redo_channels();
    syncRDCW();
  }

  function applyRDCW(final) {
    if (on_batchCopyRDefs) {
      return batchCopyRDefs_action('ok');
    }
    viewport.setModel($('#rd-wblitz-rmodel').get(0).checked?'c':'g');
    for (var i=0; i<viewport.getCCount(); i++) {
      viewport.setChannelActive(i, $('#rd-wblitz-ch'+i).get(0).checked, true);
      viewport.setChannelColor(i, $('#wblitz-ch'+i+'-color').css('background-color'), true);
      var noreload = ((i+1) < viewport.getCCount());    // prevent reload, except on the last loop
      viewport.setChannelWindow(i, $('#wblitz-ch'+i+'-cw-start').get(0).value, $('#wblitz-ch'+i+'-cw-end').get(0).value, noreload);
    }

    if (final) {
      viewport.forget_bookmark_channels();
      $('#rdef-postit').hide();
    }
    viewport.save_channels();
    syncRDCW();
  }

  function show_image_link() {
    var link = location.href;
    if (location.search.length > 0) {
      link = location.href.split(location.search)[0];   // handle trailing #
    }
    link = link.replace(/(.*?\/)\d+(?:\/\d+)?(?:\/)#?$/,'$1');
    link = link + viewport.getCurrentImgUrlPath() +'?'+ viewport.getQuery(true);
    $('#curr-link input').attr('value', link);
    return false;
  }

  function show_tooltip(self, ttid) {
    var pos = $(self).parents('div').offset();
    pos.top += $(self).parents('div').height();
    pos.left += 10;
    var tooltip = $('#' + ttid);
    $('.popped').not(tooltip).removeClass('popped');
    tooltip.css(pos)
    .toggleClass('popped');
    if (tooltip.is('.popped')) {
      var ww = $(window).width() -5;
      if ((pos.left + tooltip.width()) > ww) {
        pos.left -= (pos.left + tooltip.width()) - ww;
        tooltip.css(pos);
      }
      if (tooltip.offset().top + tooltip.height() >= $('#footer').offset().top) {
        pos.top -= tooltip.height() + 20;
        tooltip.css(pos);
      }
      var auto = $('#' + ttid).find('.autoselect').get(0);
      if (auto) {
        auto.focus();
        auto.select();
      }
    }
  }

  function show_change(obj, val, klass) {
    if (obj.value != val) {
      $(obj).addClass(klass);
    } else {
      $(obj).removeClass(klass);
    }
  }

  function zindex_automator (klass, basez, wspace) {
    if (!wspace) {
      wspace = $(klass);
    }
    var sorter = function (a,b) {
      return parseInt(a.css('z-index'))-parseInt(b.css('z-index'));
    };
    var tofront = function (e) {
      var self = this;
      var z = basez;
      var objs = new Array();
      $(klass).each(function () {
        this != self && objs.push($(this));
      });
      $.each(objs.sort(sorter), function () {
        this.css('z-index', z);
        z++;
      });
      $(self).css('z-index', z);
    };
    $.each(wspace, function () {
      $(this).bind('opening', tofront);
      $(this).bind('mousedown', tofront);
    });
  }

  function setImageDefaults (obj, callback, skip_apply) {
    if (!skip_apply) applyRDCW();
    var old = $(obj).html();
    gs_modalJson('{{ viewport_server }}/saveImgRDef/'+viewport.loadedImg.id+'/?'+viewport.getQuery(true),
                 {},
                 function(success, rv) {
                    $(obj).html(old).attr('disabled', false);
                    if (!(success && rv)) {
                        alert('Setting image defaults failed.');
                    }
                    if (window.opener && window.opener.OME.refreshThumbnails) {
                        window.opener.OME.refreshThumbnails({{ image.id }});
                    }
                  });
    return false;
  }

{% if image.canAnnotate %}
  function resetImageDefaults (obj) {
    var msg = '<h2>Resetting rendering settings</h2><ul><li>This will reset the image rendering settings to their original state at time of import.</li></ul>';
    var url = '{{ viewport_server }}/resetImgRDef/'+viewport.loadedImg.id+'/';
    gs_choiceModalJson(msg, [
        {label: 'ok', url: url, data: {full: true}},
        {label: 'cancel'}
      ],
      function(success, rv) {
        if (!rv) {
          alert('Reset image defaults failed.');
        } else {
          viewport.load(viewport.loadedImg.id, viewport.loadedImg.current.dataset_id);
        }
        if (window.opener && window.opener.OME.refreshThumbnails) {
            window.opener.OME.refreshThumbnails({{ image.id }});
        }
      },
      {css: {width: '50%', left: '25%'}}
    );
    return false;
  }

{% endif %}


  /* ]]> */
</script>
    <div id="channel-window-help" style="display: none;">
{% comment %}
      <h2>Setting the Default Image Display Settings:</h2>
      <p>You can use the "Rendering Details" dialog box to change the default settings for viewing this image.</p>
      <p>To change the color displayed for a channel, click on the color box at the right, which opens the "Choose Color" dialog box. You can choose the color using the interactive features at the top.  Hex color codes can be input in the text box.  Preset colors can be selected at the bottom.  Changes take effect when you click "Apply".</p>
      <p>To change the color intensity, drag the slider buttons for the individual channels to the left or right.  This changes the values that are used for the minimum and maximum displays settings. Changes take effect when you click "Apply".</p>
      <p>Once the image is displayed correctly, click "Save Settings". The image thumbnail, the image in the "Mini Viewer", and the image in the "Full Viewer" will now use these display settings.  Clicking the "Reset" button will reset the display settings to the most recently saved settings.</p>
      <p>Viewers will be able to adjust display settings for viewing images, but not save them.</p>
      {% endcomment %}
      <h2>Changing  the Image Display Settings:</h2>
      <p>You can use the "Rendering Details" dialog box to change the settings for viewing this image.</p>
      <p>To change the color displayed for a channel, click on the color box at the right, which opens the "Choose Color" dialog box. You can choose the color using the interactive features at the top.  Hex color codes can be input in the text box.  Preset colors can be selected at the bottom.  Changes take effect when you click "Apply".</p>
      <p>To change the color intensity, drag the slider buttons for the individual channels to the left or right.  This changes the values that are used for the minimum and maximum displays settings. Changes take effect when you click "Apply".</p>
    </div>
 
    <!-- Floating boxes come on top -->
    <div id="curr-link" class="tooltipbox">
      <table cellspacing="0">
        <tr>
          <td>
            Link to this page:
          </td>
          <td class="left">
            <img class="popclose" src="{% static "webgateway/img/close.gif" %}" alt="close" />
          </td>
        </tr>
        <tr>
          <td><input class="autoselect" type="text" size="40" value="" /></td>
        </tr>
      </table>
    </div>

    <img id="roi_thumb_popup" style="border: solid #bbb 1px"/>
    <div id="roi_table_postit" class="postit">
        <h1>ROIs</h1>
        <div id='rois_loading_message'>Loading ROI data...</div>
        <div id='roi_table_div'>
            <table id='roi_small_table' cellpadding='0' cellspacing='0'></table>
        </div>
    </div>
    
    <div id="metadata-postit" class="postit">
      <h1>Image Information</h1>
      <h3 class="can-collapse">Basic Information</h3>
      <div>
        <table cellspacing="0">
          <tr class="odd"><td class="title">Image name:&nbsp;</td><td id="wblitz-image-name"></td></tr>
          <tr class="even"><td class="title">Owner:&nbsp;</td><td id="wblitz-image-author"></td></tr>
          <!--
          <tr class="odd"><td class="title">Publication:&nbsp;</td><td id="wblitz-image-pub"></td></tr>
          <tr class="even"><td class="title">Publication ID:&nbsp;</td><td id="wblitz-image-pubid"></td></tr>
          <tr class="odd"><td class="title">Created on:&nbsp;</td><td id="wblitz-image-timestamp"></td></tr>
          -->
        </table>
      </div>
      <h3 class="can-collapse"> Dimensions </h3>
      <div class="dimensions">
        <table cellspacing="0">
          <tr>
            <th colspan="2" width="50%">Image Size</th>
            <th colspan="2">Pixel Size</th>
          </tr>
          <tr class="odd">
            <td class="title">X:&nbsp;</td><td><span id="wblitz-image-width"></span>px</td>
            <td class="title">X:&nbsp;</td><td><span id="wblitz-image-pixel-size-x"></span></td>
          </tr>
          <tr class="even">
            <td class="title">Y:&nbsp;</td><td><span id="wblitz-image-height"></span>px</td>
            <td class="title">Y:&nbsp;</td><td><span id="wblitz-image-pixel-size-y"></span></td>
          </tr>
          <tr class="odd">
            <td class="title">Z:&nbsp;</td><td><span id="wblitz-image-z-count"></span></td>
            <td class="title">Z:&nbsp;</td><td><span id="wblitz-image-pixel-size-z"></span></td>
          </tr>
          <tr class="even">
            <td class="title">T:&nbsp;</td><td><span id="wblitz-image-t-count"></span></td>
            <td colspan="2"></td>
          </tr>
        </table>
      </div>

      <h3 class="can-collapse" id="bulk-annotations" style="display: none;">Bulk Annotations</h3>
      <div style="display: none;">
		<table cellspacing="0">
		</table>
      </div>

      <!--<h3 class="can-collapse defclose"> Legend </h3>
      <div id="wblitz-image-description"><span id="wblitz-image-description-content"></span></div>-->
    </div>

    <div id="rdef-postit" class="postit" style="width: 480px">
      <h1> Rendering Details </h1>
        <div id="rdef-active-area">
        <a id="rdef-postit-help" href="#" onclick="return showChannelWindowHelp();"><img src="{% static "webgateway/img/question.png" %}" alt="Show help on channel window ranges" /></a>
        <label for="rd-wblitz-rmodel">Render as Color</label>
        <input id="rd-wblitz-rmodel" type="checkbox" onchange="return rdChanSelHelper(this);" />
        <table cellspacing="0">
          <tr>
            <th>Visible</th>
            <th>Wavelength</th>
            <th>Color</th>
            <th></th>
          </tr>
        </table>
      </div>
      <ul>
        <li class="buttonbar">
        {% block save_rdef %}
        {% if image.canAnnotate and not blitzcon.getShareId %}
          <button id="rdef-reset-btn" class="editor" onclick="return resetImageDefaults(this)" title="Returns the image settings to their original state at time of import.">reset</button>
          {% if image.canAnnotate %}<button id="rdef-setdef-btn" class="editor" onclick="return setImageDefaults(this)" title="Applies and saves the current settings as default.">save</button>{% endif %}
          
        {% endif %}
        {% endblock save_rdef %}
        <button id="rdef-default-btn" onclick="return resetRDCW();" title="Returns to the saved settings.">default</button><button id="rdef-undo-btn" onclick="return undoRDCW();" title="Returns to the settings as they were before clicking apply.">undo</button><button id="rdef-redo-btn" onclick="return redoRDCW();" title="Returns to the settings as they were before clicking undo.">redo</button><button id="rdef-apply-btn" onclick="return applyRDCW();" title="Applies the current settings to the open image.">apply</button>
        </li>
        {% block batch_copy %}
        {% if dataset.canOwnerWrite %}
        <!--<li class="buttonbar"> 
            <button id="rdef-batchcopy-btn" class="editor" onclick="return batchCopyRDefs(this);" title="Offers options to apply current settings to other images in your manuscript.">Apply to others</button> 
        </li>-->
        {% endif %}
        {% endblock batch_copy %}
      </ul>

    </div>

    <!-- End floating boxes -->
    <div id="wblitz">
      <div id="wblitz-workarea">
      <!-- Top Toolbox -->
        <!-- Zoom -->
        <div class="box">
            <h1>Viewing Options</h1>
          <div class="even row">
              <!-- multiselect hidden for big images in jquery-plugin-viewportImage.js -->
            <div class="multiselect selected">
              Normal
              <input type="radio" value="normal" name="wblitz-proj" onclick="return setProjection(this);" />
            </div>
            <div class="multiselect">
              Max Intensity
              <input type="radio" value="intmax" name="wblitz-proj" onclick="return setProjection(this);" />
            </div>
            <div class="multiselect">
              Split Channel
              <input type="radio" value="split" name="wblitz-proj" onclick="return setProjection(this);" />
            </div>
            <!--select id="wblitz-proj" onchange="viewport.setProjection(this.item(this.selectedIndex).value);">
              <option value="normal">Normal</option>
              <option value="intmax">Maximum Intensity</option>
              <option value="split">Split Channel</option>
            </select-->
          </div>
          <div class="odd row">
            <label for="wblitz-quality" class="odd">Quality</label>
            <!-- br /><input type="radio" name="wblitz-quality" value="1.0"> High</input>
            <br /><input type="radio" name="wblitz-quality" value="0.9" checked="checked"> Normal</input>
            <br /><input type="radio" name="wblitz-quality" value="0.5"> Low</input -->
            <select id="wblitz-quality" onchange="viewport.setQuality(this.item(this.selectedIndex).value);">
              <option value="1.0">High</option>
              <option value="0.9" selected="selected">Normal</option>
              <option value="0.5">Low</option>
            </select>
          </div>
          <div class="even row">
            <label for="wblitz-zoom">Zoom (%)</label><br />
            <input type="text" class="spin-button" id="wblitz-zoom" value="100" onchange="zoomCheck(this)" size="5" />
            <button id="full-size"
                    title="Actual size"
                    onclick="viewport.setZoom(100)" ></button>
            <button id="full-screen"
                    title="Zoom image to fit"
                    onclick="viewport.setZoomToFit()"></button>
          </div>
          <div class="odd row">
            <label for="wblitz-lp-enable">Line Plot</label> <input id="wblitz-lp-enable" type="checkbox" onclick="editLinePlot(this.checked)" />
            <div id="wblitz-lp-wrap" style="display: none">
              <div>Axis: 
                <select id="wblitz-lp-axis-select" onchange="prepLinePlot(this.options[this.options.selectedIndex].value)">
                  <option value="h" selected="selected">Horizontal</option>
                  <option value="v">Vertical</option>
                </select>
              </div>
              <span id="wblitz-lp-axis"></span> =
              <input type="text" id="wblitz-lp-editpos" size="4" />
              <button id="wblitz-lp-btn" onclick="showLinePlot()"></button>
              <div id="wblitz-lp-cur"></div>
            </div>
          </div>
          <h1>Rendering Details</h1>
          <div class="odd row">
            <label for="wblitz-channels-box">Channels</label> - <a href="#" onclick="$('#rdef-postit').toggle(); return false;">Edit</a><br />
            <span id="wblitz-channels-box"></span>
          </div>
          <div class="even row">
            <label for="wblitz-rmodel">Color</label>
            <input id="wblitz-rmodel" type="checkbox" onclick="viewport.setModel(this.checked?'c':'g');" />
	    {% comment %}<!-- #8766 {% if not blitzcon.isAnonymous and image.canWrite %}
	    <br />
            <label for="wblitz-invaxis">Invert Z/T Axis</label>
            <input id="wblitz-invaxis" type="checkbox" onchange="viewport.setInvertedAxis(this.checked);" />
	    {% endif %}-->{% endcomment %}
            <br />
            <label>Rendering Settings</label><br />
            <button class="btn silver btn_text copy_rdef" title="Copy Rendering Settings">
                <span>Copy</span>
            </button>

            <button class="btn silver btn_text paste_rdef" title="Paste Rendering Settings">
                <span>Paste</span>
            </button>
          </div>
            <h1>Current Image</h1>
          <div class="even row">
            <span style="font-size: 0.9em">
            <!--<span id="wblitz-shortname" style="white-space: nowrap;"></span><br />-->
            Z: <span id="wblitz-z-curr">?</span>/<span id="wblitz-z-count">?</span> |
            T: <span id="wblitz-t-curr">1</span>/<span id="wblitz-t-count">1</span>
            </span>
          </div>
          <div class="odd row">
            <a href="#" onclick="$('#metadata-postit').toggle(); return false;">Image Information</a><br />
          </div>
          <div class="even row">
                      <a href="#" onmouseover="this.href=viewport.getUrl('img_detail')"
                      onclick="show_image_link();
                        show_tooltip(this, 'curr-link'); return false;">
                Image Link
            </a><br />
          </div>
{% block roi_buttons %}
          <div id="roi_controls">
                <h1>ROI Count: {{ roiCount }}</h1>
                {% ifnotequal roiCount 0 %}
                    <a href="#" onclick="show_rois(); return false;">Show ROIs</a> |
                    <a href="#" onclick="hide_rois(); return false;">Hide</a>
                {% endifnotequal %}
          </div>
{% endblock roi_buttons %}
          {% block current_image_tools %}{% endblock %}
        </div>
            
        <!-- Image Viewport -->
        <div id="weblitz-viewport"></div>
        <img id="z-axis-legend" src="{% static "webgateway/img/z_axis.gif" %}" />
        <img id="t-axis-legend" src="{% static "webgateway/img/t_axis.gif" %}" />
        <div class="figure-box-holder">
        </div>
      </div>
    </div>
    <div id="footer">
    {% block footer_content %}
      &copy; 2007-{{ build_year }} Glencoe Software Inc. All rights reserved.
    {% endblock %}
    </div>
{% endblock full_body %}

<script type="text/javascript">
  /* <![CDATA[ */
  $(document).ready(function () {
    $.ajaxSettings.cache = false;
  });
{% block content_script %}

  var gs_static_location_prefix='{% static "" %}';

  $(document).ready(function () {
    /* Prepare the viewport */
    
    
    viewport = $.WeblitzViewport($('#weblitz-viewport'), '{{ viewport_server }}',{% block viewport_opts %}{'mediaroot': '{{ STATIC_URL }}' }{% endblock %});
    viewport.bind('imageLoad', _refresh_cb);

    /* Prepare the Zoom spin button */
    $("INPUT.spin-button").SpinButton({min:0});

    /* Bind zoom changes to the zoom button */
    viewport.bind('zoom', function(e, percent) {
      $("#wblitz-zoom").attr('value', ''+percent /*+'%'*/);
      $(".popped").removeClass('popped');
    });

    /* Bind projection changes */
    viewport.bind('projectionChange', projectionChange);
    /* Bind model changes */
    viewport.bind('modelChange', modelChange);
    /* Bind channel changes */
    viewport.bind('channelChange', channelChange);
    /* Bind image changes */
    viewport.bind('imageChange', imageChange);
    /* Bind line plot changes */
    viewport.bind('linePlotChange', linePlotChange);
    /* Bind line plot position pick */
    viewport.bind('linePlotPos', linePlotPos);

    /* Prepare pop tools */
    $(".popover > h1")
      .prepend('<div class="drop-img drop-left"></div><div class="drop-img drop-right"></div>')
      .click(function () {
        var this_popped = $(this).parent().is('.popped');
        $(".popped").removeClass('popped');
        if (this_popped) {
          $(this).parent().removeClass('popped');
        } else {
          $(this).parent().addClass('popped');
        }
        return false;
      });

    $(".popclose").click(function () {
      $(".popped").removeClass('popped');
    });

    $("#weblitz-viewport").click(function () {
      $(".popped").removeClass('popped');
      return false;
    })
    .bind("imageChange", function () {
      $(".popped").removeClass('popped');
    });

//    var pprep = function (t) {
//    return function () {
    /* Prepare the post-its */
    var layout_pos = $("#header").offset(); //$("#weblitz-viewport").offset();
    $(".postit").each(function () {
      if (this.id == 'metadata-postit') {
        $(this).postit({noResize: false, resizeTarget: '#wblitz-image-description'});//.css($("#weblitz-viewport-vp").offset());
      } else if (this.id == 'roi_table_postit') {
          $(this).postit({noResize: true})
            .css(layout_pos);
      } else {
        layout_pos.left += 20;
        layout_pos.top += 20;
        $(this).postit({noResize: true})
          .css(layout_pos);
      }
    });
    var legend_open = function () {
      var d = $(this);
      d.unbind('opening', legend_open);
      /* Calculate the size for legend post-it */
      var h = $('#weblitz-viewport-vp').height();
      var w = ($('#weblitz-viewport-vp').width() - h) /2;
      d.css('width', Math.max(w, 250));
      if (d.height() > h) {
        d.css('height', h);
      }
      d.trigger('jqResize');
    };
    $("#legend-postit").bind('opening', legend_open);

    zindex_automator('.postit', 210);

    /* Make (kind of) sure that closing the rendering defs window closes an eventually opened color picker */
    $("#rdef-postit").bind('closed',
      function () {
                    hidePicker();
                    /* viewport.back_to_bookmarked_channels();*/
                    //syncRDCW();
                  })
      .bind('opening', function () { syncRDCW(); viewport.bookmark_channels()});

    $('.can-collapse').click(function () {
      $(this).toggleClass('closed').next().slideToggle();
    });

    $('.can-collapse.defclose').each(function () {
      $(this).removeClass('defclose').toggleClass('closed').next().hide();
    });
//    };
//    setTimeout ( pprep(this), 1000);

    /* Load the selected image into the viewport */
    var did = '{{ dataset.id }}';
    viewport.setQuality('0.9');
    viewport.load({{ image.id }}, did.length ? parseInt(did) : null, location.search);

    /* Bind actions needed on window resize */
    $(window).resize(calcResize);

    $('input[name=wblitz-quality]').click(function () {
      viewport.setQuality(this.value);
    });
    
    viewport.bind('imageChange', refresh_rois);
    viewport.bind('instant_zoom', function(e, percent) {
        if (viewport.viewportimg.get(0).setRoiZoom) {
            viewport.viewportimg.get(0).setRoiZoom(percent);
        }
    });

    var copy_paste_rdef_url = "{% url 'webgateway.views.copy_image_rdef_json' %}";
    $(".btn.copy_rdef").click(function() {
        // copy the current rendering settings to the 'session'
        $.getJSON(copy_paste_rdef_url + "?"+ viewport.getQuery(true) + "&imageId=" + viewport.loadedImg.id);
    });

    $(".btn.paste_rdef").click(function() {
        $.getJSON(copy_paste_rdef_url + "?toids={{ image.id }}", function(data){
          // refresh UI
          viewport.load({{ image.id }});
          // update thumbnails
          if (window.opener && window.opener.OME.refreshThumbnails) {
            window.opener.OME.refreshThumbnails({{ image.id }});
          }
        });
    });
    
    var toggle_th = function($roiThead) {
        $roiThead.next().toggle(0, function(){
            var vis = $roiThead.next().is(':visible');
            var arrow_src = '{% static "webgateway/img/arrowRight_grey.png" %}';
            if (vis) {
                arrow_src = '{% static "webgateway/img/arrowDown_grey.png" %}';
            }
            $roiThead.find('img.expand_arrow').attr('src', arrow_src);
        });
    }
    
    var handleShapeRowClick = function($shapeRow){
        var shape_id = parseInt($shapeRow.attr('id'));      // E.g. id='123_shape'
        var selected_xy = viewport.viewportimg.get(0).set_selected_shape(shape_id);
        var vpb = viewport.viewportimg.get(0).getBigImageContainer();
        if (vpb!= null && viewport.loadedImg.tiles) {
            var scale = vpb.currentScale();
            vpb.recenter({x:selected_xy['x']*scale ,y:selected_xy['y']*scale}, true, true);
        }
        var z = $shapeRow.find('td:nth-child(4)').text();
        if (z != NOZT) {
            viewport.setZPos(parseInt(z));
        }
        var t = $shapeRow.find('td:nth-child(5)').text();
        if (t != NOZT) {
            viewport.setTPos(parseInt(t));
        }
    }
    
    $("#roi_small_table").click(function(event) {
        var $target = $(event.target);
        if ($target.attr('id') == "toggle_roi_thumbs") {
            update_roi_thumbs();
            return true;
        } else if ($target.hasClass('color_picker_option')) {
            // change the colour of lines drawn on roi_thumbs
            var line_color = $target.attr('color').substring(1);  // '#f00' -> 'f00'
            update_roi_thumbs(line_color);
        } else if ($target.attr('id') == "toggle_shape_text") {
            var show_labels = ($("#toggle_shape_text").is( ":checked" ));
            viewport.viewportimg.get(0).show_labels(show_labels);
            return true;
        } else if ($target.hasClass('shape_cell')) {
            // a shape td click selects the shape.
            var $shapeRow = $target.parent();
            handleShapeRowClick($shapeRow);
        } else if ($target.parent().hasClass('shape_cell')) {
            // a shape <p> click selects the shape.
            var $shapeRow = $target.parent().parent();
            handleShapeRowClick($shapeRow);
        } else if ($target.hasClass('shape_icon')) {
            // need to get to the row
            var $shapeRow = $target.parent().parent();
            handleShapeRowClick($shapeRow);
        } else if ($target.get(0).nodeName.toLowerCase() == 'th'){
            // a ROI (th) click toggles the ROI-shapes 'tbody' below
            if ($target.parent().hasClass('roi_row')) {
                var $roiThead = $target.parent().parent();
                toggle_th($roiThead);
            }
        } else if ($target.parent().get(0).nodeName.toLowerCase() == "th"){
            // a ROI (th <p>) click toggles the ROI-shapes 'tbody' below
            if ($target.parent().parent().hasClass('roi_row')) {
                var $roiThead = $target.parent().parent().parent();
                toggle_th($roiThead);
            }
        } else if ($target.hasClass('expand_arrow') || $target.hasClass('roi_icon')) {
            // clicked on the arrow - need to get the (th)
            var $roiThead = $target.parent().parent().parent();
            toggle_th($roiThead);
        } else if ($target.hasClass('roi_thumb')) {
            // roi thumbnail may be in thead/tr/td (ROI - toggle shapes) or tbody/tr/td (shape - update viewer)
            var $tableRow = $target.parent().parent();
            var nodeName = $tableRow.parent().get(0).nodeName.toLowerCase();
            if (nodeName == 'tbody') {
                handleShapeRowClick($tableRow);
            }
            else if (nodeName == 'thead') {
                toggle_th($tableRow.parent());
            }
        }
        return false;
    });
    
    
    // we can bind events to viewportimg for roi_display-plugin to trigger (plugin not created yet)
    viewport.viewportimg.bind("shape_click", handle_shape_selection);
    viewport.viewportimg.bind("rois_loaded", handle_rois_loaded);
    
    /* And we're done! */

{% block initial_resize %}
    /* Set Window Initial Size */
    //if ($(document).width() < 1024 || $(document).height() < 768) 
    //  window.resizeTo(1024,768);
{% endblock %}
    calcResize();
    gs_script_location_prefix="{% static "webgateway/" %}";
  });
{% endblock content_script %}
  /* ]]> */
</script>


{% endblock %}
