{% extends "webadmin/base.html" %}
{% load i18n %}

{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% block title %}{% trans "My account" %}{% endblock %}

{% block link %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "webgateway/css/ome.table.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% static "3rdparty/jquery.tablesorter/jquery.tablesorter.css" %}" type="text/css" media="screen"/>
    
    <!--[if lte IE 8]>
        <link rel="stylesheet" type="text/css" href="/static/webgateway/css/ome.table_ie.css" />
    <![endif]-->
    
    
{% endblock %}

{% block script %}
    {{ block.super }}

    <script type="text/javascript" src="{% static "3rdparty/jquery.tablesorter/jquery.tablesorter.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/jquery.quicksearch.js" %}"></script>
    <script type="text/javascript" src="{% static "webclient/javascript/jquery.form.js" %}"></script>
    
    <script type="text/javascript">
    
    $(document).ready(function () {
        $("#groupTable").tablesorter( {
            //sortList: [[1,0]]
            headers: {0: { sorter: 'digit' } }
            } );
        $('input#id_search').quicksearch('table#groupTable tbody tr', {
            'delay': 300,
            'loader': 'span.loading'
        });
        
        {% if edit_mode %}
        $('#save_thumb').click(function() {
            var x1 = $('#x1').val();
            var y1 = $('#y1').val();
            var x2 = $('#x2').val();
            var y2 = $('#y2').val();
            var w = $('#w').val();
            var h = $('#h').val();
            if(x1=="" || y1=="" || x2=="" || y2=="" || w=="" || h==""){
                alert("You must make a selection first");
                return false;
            }else{
                return true;
            }
        });
        {% endif %}
    }); 

    </script>
    
    <script>
        $(function() {
            $( "#admin" ).tabs();
        });
    </script>
    
    
    <script>
        // increase the default animation speed to exaggerate the effect
        $.fx.speeds._default = 1000;
        $(function() {
            $( "#password_change_dialog" ).dialog({
                autoOpen: false,
                draggable: false,
                resizable: false,
                closeOnEscape: true,
                modal: false,
                dialogClass: 'reddit',
                buttons: {
                    "OK": function() {
                        // simply submit the form (AJAX handling set-up above)
                        $("#change_password_form").submit();
                    },
                    "Cancel": function() {
                        $( this ).dialog( "close" );
                    }
                },
                position: { 
                    my: 'left center',
                    at: 'right center',
                    of: $('#change_password'),
                    collision: "flip",
                    offset: "10 0"
                }
            });
            
            $( "#change_password" ).click(function() {
                // clear fields
                var $pw_form = $("#change_password_form");
                $("div.error", $pw_form).text("");
                $("input[name='password']", $pw_form).val("");
                $("input[name='confirmation']", $pw_form).val("");
                $("input[name='old_password']", $pw_form).val("");
                // show dialog
                $( "#password_change_dialog" ).dialog( "open" );
                return false;
            });
            $("#password_cancel").click(function() {
                $( "#password_change_dialog" ).dialog( "close" );
                return false;
            });
            
            $("#password_change_message").hide();
            $("#change_password_form").ajaxForm({
                beforeSubmit: function(data) {
                    // check that both new passwords match, fields aren't empty etc.
                    var $pw_form = $("#change_password_form");
                    var new_pw = $("input[name='password']", $pw_form).val();
                    var conf_pw = $("input[name='confirmation']", $pw_form).val();
                    var old_pw = $("input[name='old_password']", $pw_form).val();
                    if ($.trim(new_pw).length==0 || $.trim(conf_pw).length==0 || $.trim(old_pw).length==0) {
                        $("div.error", $pw_form).text("All fields must be filled in.");
                        return false;
                    }
                    if (new_pw != conf_pw) {
                        $("div.error", $pw_form).text("New passwords don't match.");
                        return false;
                    }
                    if (new_pw == old_pw) {
                        $("div.error", $pw_form).text("New password is the same as Old password");
                        return false;
                    }
                    if ($.trim(new_pw).length<3 || $.trim(conf_pw).length<3 || $.trim(old_pw).length==0) {
                        $("div.error", $pw_form).text("Passwords should be at least 3 characters long.");
                        return false;
                    }
                    $( "#password_change_dialog" ).dialog( "close" );
                },
                success: function(html) {
                    $("#password_change_message").html(html).show().delay(3000).fadeOut(2000);
                }
            });

        });
    </script>
    
    
{% endblock %}




{% block center_details %}
   
<div id="admin">
    
    <ul id="settings_tabs">
        <li id="personal_settings_tab"><a href="#personal_settings" title="Personal Settings">Profile</a></li>

        <li id="group_settings_tab"><a href="#groups_settings" title="Groups Settings">Groups</a></li>

        <li id="drivespace_settings_tab"><a href="#drivespace_settings" title="Drivespace">Drivespace</a></li>
    </ul>
     
     <!-- Personal Settings -->
    <div id="personal_settings" class="settings_content">

        <h1>Personal Settings</h1>

       <form class="standard_form" action="{% url wamyaccount "save" %}" method="POST">

           <div id="avatar">
               <img src="{% url wamyphoto %}" class="imgzoom"/>                 
               <a class="btn btn_text silver" href="{% url wamanageavatar ome.eventContext.userId %}">
                   <span>Change</span>
               </a> 

               {% if myaccount.hasAvatar %} 
               <a class="btn btn_text silver" href="{% url wamanageavatar ome.eventContext.userId "deletephoto" %}">
                   <span>Delete</span>
               </a>
               {% endif %}
            </div>



           <div id="personal_details">

               {% for field in form %}
                      {{ field.label_tag }}
                   <!-- Commented out until this can sit inside the label -->
                   <!--{% if field.field.required %}*{% endif %} -->
                   {{ field }}
                   {% if field.errors %}{{ field.errors }}{% endif %}
                   {{ field.help_text|safe }}
               {% endfor %}

               {% if ldapAuth %}
               LDAP: {{ ldapAuth }}
               {% else %}

               <div id="password">

                   <div id="password_change">
                       <label>Password:</label>
                       <a class="btn btn_text silver" id="change_password">
                           <span>Change  Password</span>
                       </a>
                   </div>

                   <span id="password_change_message"></span>
               </div>
               {% endif %}


               <input type="submit" value="{% trans 'Save' %}" />
             </div>

       </form>


           <!-- hidden dialog for password change -->
           <div id="password_change_dialog" title="Change Password">
               <h1>{% trans "Change Password" %}</h1>

               <p>{% trans "Fields marked with an asterisk (*) are mandatory." %}</p>
               <br/>

               <form id="change_password_form" action="{% url wamanagechangepasswordid ome.eventContext.userId %}" method="POST">

                   <table>
                       <tbody>
                           {% for field in password_form %}
                           <tr>
                               <td class="form">{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                               <td class="input">{{ field }}</td>
                               <td>{{ field.help_text|safe }}</td>
                           </tr>
                           {% endfor %}

                           <tr><td colspan="3">
                               <div class="error"></div>
                           </td></tr>
                       </tbody>
                   </table>
               </form>
           </div>
        

    </div>
    

    <div id="groups_settings" class="settings_content">

       <h1 style="padding: 20px">{% trans "Owned Groups" %}</h1>
        
        <div class="one_column_header">
            <form class="search filtersearch" id="filtersearch" action="#">
                <input type="text" id="id_search" value="">
                <input type="submit" value="Go" />
                <span class="loading">
                    <img class="loader" alt="Loading" src="{% static "webgateway/img/spinner.gif" %}">
                </span>
            </form>
            
        </div>
  
        <table id="dataTable" class="tablesorter tablesorter_basic"> 
            <thead> 
                <tr> 
                    <th>{% trans "Name" %}</th> 
                    <th>{% trans "Permissions" %}</th> 
                    <th>{% trans "Description" %}</th>
                    <th >{% trans "Settings" %}</th>
                </tr> 
            </thead> 
            <tbody>
            {% for dict in ownedGroups %}
                <tr>
                    <td><strong>{{ dict.group.name }}</strong></td>
                    <td>{{ dict.permissions }} ({{ dict.group.details.permissions }})</td>
                    <td>{{ dict.group.description|default_if_none:"-"|truncatewords:"5" }}</td>
                    <td class="table_settings">
                        {% if not dict.locked %}
                            <a href="{% url wamanagegroupownerid "edit" dict.group.id %}" alt="Edit Group" title="Edit Group" class="btn silver btn_edit">
                            <span></span>
                        </a>
                        {% endif %}                    
                    </td>
                </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>

    
    
    <div id="drivespace_settings" class="settings_content">
        
        <h1 style="padding: 20px">Drive Space</h1>
    </div>

</div>
{% endblock %}
