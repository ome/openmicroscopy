{% extends "webadmin/base.html" %}
{% load i18n %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% block link %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "webadmin/css/picklist.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% static '3rdparty/jquery.chosen/chosen.css' %}" type="text/css" media="screen"/>
    
    <link rel="stylesheet" href="{% static 'webadmin/css/chosen.css' %}" type="text/css" media="screen"/>
    
{% endblock %}

{% block title %}
    {% if eid %}
        {% trans "Edit scientist" %}
    {% else %}
        {% trans "Add scientist" %}
    {% endif %}

{% endblock %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "webclient/javascript/jquery.form.js" %}"></script>
    <script type="text/javascript" src="{% static '3rdparty/jquery.chosen/chosen.jquery.js' %}"></script>
    <script type="text/javascript" src="{% static '3rdparty/jquery.selectboxes.js' %}"></script>
    
    <script type="text/javascript">
    $(document).ready(function() 
    {
        var highlightDefault = function() {
            dv = $('#id_default_group').val();
            if (dv.length > 0 && dv!== "0"){
                selected = $.grep($('#id_other_groups').data('chosen').results_data, function(item){
                    return item.value == dv;
                });
                $("#id_other_groups_chzn_c_"+selected[0].array_index).addClass('search-choice-default').find("a").first().attr('rel');
                $('#id_default_group').val(selected[0].value);
                $("#default_group_name").text(selected[0].html)
            } else {
                $('#id_default_group').val("");
                $("#default_group_name").text("Nothing selected");
            }
        }

        var selectDefaultGroup = function(evt) {
            evt.stopPropagation();
            var target = $(evt.target).hasClass("search-choice") ? $(evt.target) : $(evt.target).parents(".search-choice").first();
            $(".chzn-choices li.search-choice").removeClass('search-choice-default');
            choice_id = $(evt.currentTarget).addClass('search-choice-default').find("a").first().attr('rel');
            selected = $.grep($('#id_other_groups').data('chosen').results_data, function(item){
                return item.array_index == choice_id;
            })[0];
            $("#id_default_group").selectOptions(selected.value, true);
            $("#default_group_name").text(selected.html);
        };

        $("#id_other_groups").chosen().change(function(evt, data) {
            if (data && data.deselected) {
                if (data.deselected === "0") {
                    $("input[name='administrator']").attr('checked', false);
                }
                $df = $('#id_default_group')
                if ($df.val() === data.deselected){
                    $("#id_default_group").selectOptions("", true);
                    $("#default_group_name").text("Nothing selected");
                } 
            } else if (data && data.selected) {
                if (data.selected === "0") {
                    $("input[name='administrator']").attr('checked', true);
                }
                $("li.search-choice").click(selectDefaultGroup);
            }
        });

        $("input[name='administrator']").click( function(evt) {
            evt.stopPropagation();
            if($("input[name='administrator']").is(':checked')) {
                $('#id_other_groups option[value=0]').prop('selected', true);
            } else {
                $('#id_other_groups option[value=0]').prop('selected', false);
            }
            $("#id_other_groups").trigger("liszt:updated");
            $("li.search-choice").click(selectDefaultGroup);
            highlightDefault();
        });

        $("li.search-choice").click(function(evt) {
            evt.stopPropagation();
            selectDefaultGroup(evt);
        });
        highlightDefault();
        
        
        // code for Change Password dialog - NB this is duplicated in myaccount.html. 
        $( "#password_change_dialog" ).dialog({
            autoOpen: false,
            draggable: false,
            resizable: false,
            closeOnEscape: true,
            modal: false,
            dialogClass: 'reddit',
            buttons: {
                "OK": function() {
                    // simply submit the form (AJAX handling set-up above)
                    $("#change_password_form").submit();
                },
                "Cancel": function() {
                    $( this ).dialog( "close" );
                }
            },
            position: { 
                my: 'left center',
                at: 'right center',
                of: $('#change_password'),
                collision: "flip",
                offset: "10 0"
            }
        });
        
        $( "#change_password" ).click(function() {
            // clear fields
            var $pw_form = $("#change_password_form");
            $("div.error", $pw_form).text("");
            $("input[name='password']", $pw_form).val("");
            $("input[name='confirmation']", $pw_form).val("");
            $("input[name='old_password']", $pw_form).val("");
            // show dialog
            $( "#password_change_dialog" ).dialog( "open" );
            return false;
        });
        $("#password_cancel").click(function() {
            $( "#password_change_dialog" ).dialog( "close" );
            return false;
        });
        
        $("#password_change_message").hide();
        $("#change_password_form").ajaxForm({
            beforeSubmit: function(data) {
                // check that both new passwords match, fields aren't empty etc.
                var $pw_form = $("#change_password_form");
                var new_pw = $("input[name='password']", $pw_form).val();
                var conf_pw = $("input[name='confirmation']", $pw_form).val();
                var old_pw = $("input[name='old_password']", $pw_form).val();
                if ($.trim(new_pw).length==0 || $.trim(conf_pw).length==0 || $.trim(old_pw).length==0) {
                    $("div.error", $pw_form).text("All fields must be filled in.");
                    return false;
                }
                if (new_pw != conf_pw) {
                    $("div.error", $pw_form).text("New passwords don't match.");
                    return false;
                }
                if (new_pw == old_pw) {
                    $("div.error", $pw_form).text("New password is the same as Old password");
                    return false;
                }
                if ($.trim(new_pw).length<3 || $.trim(conf_pw).length<3 || $.trim(old_pw).length==0) {
                    $("div.error", $pw_form).text("Passwords should be at least 3 characters long.");
                    return false;
                }
                $( "#password_change_dialog" ).dialog( "close" );
            },
            success: function(html) {
                $("#password_change_message").html(html).show().delay(3000).fadeOut(2000);
            }
        });

    });
    
    </script>

{% endblock %}

{% block center_details %}

{{ block.super }}

<div class="one_column_content">
{% if eid %}
    <h1>{% trans "Edit scientist" %}</h1>
{% else %}
    <h1>{% trans "Add scientist" %}</h1>
{% endif %}

<h1><a href="{% url waexperimenters %}" style="position:relative; top:-38px; float:right" title="Go Back to Experimenters">Cancel</a></h1>

<p>{% trans "Fields marked with an asterisk (*) are mandatory." %}</p>
<br/>

{% if eid %}
    <!-- We are editing existing user -->
    <form action="{% url wamanageexperimenterid "save" eid %}" method="POST" class="standard_form">
        
        {% if ldapAuth %}
        <label>LDAP:</label> {{ ldapAuth }} <br />
        {% else %}

        <div id="password">

            <div id="password_change">
                <label>Password</label>
                <a class="btn btn_text silver" id="change_password">
                    <span>Change User's Password</span>
                </a>
            </div>

            <span id="password_change_message" class="error">Message here</span>
        </div>
        {% endif %}
        
{% else %}
    <!-- We are creating new user -->
    <form action="{% url wamanageexperimenterid "create" %}" method="POST" class="standard_form">
{% endif %}

        
        {{ form.omename.label_tag }} {% if form.omename.field.required %}*{% endif %} {{ form.omename }} <br />
        {{ form.password.label_tag }} {% if form.password.field.required %}*{% endif %} {{ form.password }} <br />
        {{ form.confirmation.label_tag }} {% if form.confirmation.field.required %}*{% endif %} {{ form.confirmation }} <br />
        <br />
        {{ form.first_name.label_tag }} {% if form.first_name.field.required %}*{% endif %} {{ form.first_name }} <br />
        {{ form.middle_name.label_tag }} {% if form.middle_name.field.required %}*{% endif %} {{ form.middle_name }} <br />
        {{ form.last_name.label_tag }} {% if form.last_name.field.required %}*{% endif %} {{ form.last_name }} <br />
        <br />
        {{ form.email.label_tag }} {% if form.email.field.required %}*{% endif %} {{ form.email }} <br />
        {{ form.institution.label_tag }} {% if form.institution.field.required %}*{% endif %} {{ form.institution }} <br />
        <br />
        {{ form.administrator.label_tag }} {% if form.administrator.field.required %}*{% endif %} {{ form.administrator }} <br />
        {{ form.active.label_tag }} {% if form.active.field.required %}*{% endif %} {{ form.active }} <br />
        
        <br />
        {{ form.default_group.label_tag }}*{{ form.default_group }}
        <span id="default_group_name">Nothing selected</span>
        <br />
        {{ form.other_groups.label_tag }}*
        {{ form.other_groups }}
        {% if form.other_groups.errors %}{{ form.other_groups.errors }}{% endif %}
        {% if form.default_group.errors %}{{ form.default_group.errors }}{% endif %}
        
        <br />
        
        <input type="submit" value="{% trans 'Save' %}" />
        
</form>

{% if eid %}
<!-- hidden dialog for password change - This is almost duplicated in myaccount.html-->
<div id="password_change_dialog" title="Change Password">

    <form id="change_password_form" action="{% url wamanagechangepasswordid eid %}" method="POST">

        <table>
            <tbody>
                <tr>
                    <td class="form"><label for"id_old_password">Admin Password</label></td>
                    <td class="input">{{ password_form.old_password }}</td>
                </tr>
                <tr>
                    <td class="form">{{ password_form.password.label_tag }}{% if password_form.password.required %}*{% endif %}</td>
                    <td class="input">{{ password_form.password }}</td>
                </tr>
                <tr>
                    <td class="form">{{ password_form.confirmation.label_tag }}{% if password_form.confirmation.required %}*{% endif %}</td>
                    <td class="input">{{ password_form.confirmation }}</td>
                </tr>

                <tr><td colspan="3">
                    <div class="error"></div>
                </td></tr>
            </tbody>
        </table>
    </form>
</div>
{% endif %}

</div>


{% endblock %}

