{% extends "webadmin/base.html" %}
{% load i18n %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% block link %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "webadmin/css/picklist.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% static '3rdparty/jquery.chosen/chosen.css' %}" type="text/css" media="screen"/>
    
    <link rel="stylesheet" href="{% static 'webadmin/css/chosen.css' %}" type="text/css" media="screen"/>
    
{% endblock %}

{% block title %}
    {% if eid %}
        {% trans "Edit scientist" %}
    {% else %}
        {% trans "Add scientist" %}
    {% endif %}

{% endblock %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "3rdparty/jquery-1.7.2.js" %}"></script>
    <script type="text/javascript" src="{% static '3rdparty/jquery.chosen/chosen.jquery.js' %}"></script>
    <script type="text/javascript" src="{% static '3rdparty/jquery.selectboxes.js' %}"></script>
    
    <script type="text/javascript">
    $(document).ready(function() 
    {
        var highlightDefault = function() {
            dv = $('#id_default_group').val();
            if (dv.length > 0 && dv!== "0"){
                selected = $.grep($('#id_other_groups').data('chosen').results_data, function(item){
                    return item.value == dv;
                });
                $("#id_other_groups_chzn_c_"+selected[0].array_index).addClass('search-choice-default').find("a").first().attr('rel');
                $('#id_default_group').val(selected[0].value);
                $("#default_group_name").text(selected[0].html)
            } else {
                $('#id_default_group').val("");
                $("#default_group_name").text("Nothing selected");
            }
        }

        var selectDefaultGroup = function(evt) {
            evt.stopPropagation();
            var target = $(evt.target).hasClass("search-choice") ? $(evt.target) : $(evt.target).parents(".search-choice").first();
            $(".chzn-choices li.search-choice").removeClass('search-choice-default');
            choice_id = $(evt.currentTarget).addClass('search-choice-default').find("a").first().attr('rel');
            selected = $.grep($('#id_other_groups').data('chosen').results_data, function(item){
                return item.array_index == choice_id;
            })[0];
            $("#id_default_group").selectOptions(selected.value, true);
            $("#default_group_name").text(selected.html);
        };

        $("#id_other_groups").chosen().change(function(evt, data) {
            if (data && data.deselected) {
                if (data.deselected === "0") {
                    $("input[name='administrator']").attr('checked', false);
                }
                $df = $('#id_default_group')
                if ($df.val() === data.deselected){
                    $("#id_default_group").selectOptions("", true);
                    $("#default_group_name").text("Nothing selected");
                } 
            } else if (data && data.selected) {
                if (data.selected === "0") {
                    $("input[name='administrator']").attr('checked', true);
                }
                $("li.search-choice").click(selectDefaultGroup);
            }
        });

        $("input[name='administrator']").click( function(evt) {
            evt.stopPropagation();
            if($("input[name='administrator']").is(':checked')) {
                $('#id_other_groups option[value=0]').prop('selected', true);
            } else {
                $('#id_other_groups option[value=0]').prop('selected', false);
            }
            $("#id_other_groups").trigger("liszt:updated");
            $("li.search-choice").click(selectDefaultGroup);
            highlightDefault();
        });

        $("li.search-choice").click(function(evt) {
            evt.stopPropagation();
            selectDefaultGroup(evt);
        });
        highlightDefault();
    });
    
    </script>

{% endblock %}

{% block center_details %}

{{ block.super }}

<div class="one_column_content">
{% if eid %}
    <h1><a href="{% url waexperimenters %}">BACK</a> {% trans "Edit scientist" %}</h1>
{% else %}
    <h1><a href="{% url waexperimenters %}">BACK</a> {% trans "Add scientist" %}</h1>
{% endif %}

<p>{% trans "Fields marked with an asterisk (*) are mandatory." %}</p>
<br/>

{% if eid %}
    <form action="{% url wamanageexperimenterid "save" eid %}" method="POST" class="standard_form">
{% else %}
    <form action="{% url wamanageexperimenterid "create" %}" method="POST" class="standard_form">
{% endif %}

        {% if ldapAuth %}
        <label>LDAP:</label> {{ ldapAuth }} <br />
        {% else %}
            {% if eid %}
            <label>Password</label>
            <a href="{% url wamanagechangepasswordid eid %}" class="btn btn_text silver"><span>Change Password</span></a>
            {% endif %}
            <br />
        {% endif %}
        
        {% for field in form %}
        
        {% ifnotequal field.label_tag form.default_group.label_tag %}{% ifnotequal field.label_tag form.other_groups.label_tag %}
        
        {{ field.label_tag }}{% if field.field.required %}*{% endif %}
        {{ field }}
        {% if field.errors %}{{ field.errors }}{% endif %}{{ field.help_text|safe }}
        <br />
        {% endifnotequal %}{% endifnotequal %}
        
        {% endfor %}
        
        <br />
        {{ form.default_group.label_tag }}*{{ form.default_group }}
        <span id="default_group_name">Nothing selected</span>
        <br />
        {{ form.other_groups.label_tag }}*
        {{ form.other_groups }}
        {% if form.other_groups.errors %}{{ form.other_groups.errors }}{% endif %}
        {% if form.default_group.errors %}{{ form.default_group.errors }}{% endif %}
        
        <br />
        
        <input type="submit" value="{% trans 'Save' %}" />
        
</form>

</div>


{% endblock %}

