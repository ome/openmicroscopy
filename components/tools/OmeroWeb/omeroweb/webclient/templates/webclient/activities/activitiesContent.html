{% load i18n %}
{% load common_filters %}

<html>

{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}


<body>


<div id='activities_content'>
    <div id="sizeOfJobs" style="display:none">{{ sizeOfJobs }}</div>
    <div id="inprogress" style="display:none">{{ inprogress }}</div>
    <div id="new_results" style="display:none">{{ new_results }}</div>
    {% if new_errors %}<div id="new_errors" style="display:none">True</div>{% endif %}
    <div id="failure" style="display:none">{{ failure }}</div>

    <table id="jobsTable" width="100%" cellpadding="6" cellspacing="0" border="0">

        <tbody>
            {% ifequal sizeOfJobs 0 %}
                <tr><td><span>No Activities</span></td></tr>
            {% endifequal %}






            {% for j in jobs %}
                <!-- Chgrp jobs -->
                {% ifequal j.job_type "chgrp" %}
                    <tr id="{{ j.id }}" class="{% if j.new %}new_result{% endif %}{% ifequal j.status 'in progress' %} in_progress{% endifequal %}" >
                        <td width="25px">
                            {% ifequal j.status "in progress" %}<img class="icon" src="{% static "webgateway/img/spinner.gif" %}" />
                            {% else %}
                                {% if j.error %}
                                    <img alt="Failed to run script properly" src="{% static "webgateway/img/failed.png" %}" />
                                {% else %}
                                    <img class="icon" src="{% static "webgateway/img/success.png" %}" />
                                {% endif %}
                            {% endifequal %}
                        </td>
                        <td class="script_description" colspan='2'>
                            <span class="activity_title">
                                Move to Group '{{ j.group }}'
                            </span>
                            <span class="message">
                                {% ifequal j.status "in progress" %}
                                    Moving {{ j.dtype }}{{ j.obj_ids|pluralize }} to Group '{{ j.group }}'...
                                {% else %}
                                    {% ifequal j.status "finished" %}
                                        {{ j.dtype }}{{ j.obj_ids|pluralize }} moved to Group '{{ j.group }}'
                                        <a href="{% url webindex %}?show={% for o in j.obj_ids %}{{ j.dtype|lower }}-{{ o }}{% if not forloop.last %}|{% endif %}{% endfor %}">
                                            Show {{ j.dtype }}{{ j.obj_ids|pluralize }}
                                        </a>
                                    {% endifequal %}
                                    {% if j.report %}
                                        <div class="chgrp_error">
                                            {{ j.report|truncateafter:"30" }}
                                            <a href="#" title="Click to Open in new Window"> More...</a>
                                            <div style="display:none">{{ j.report|linebreaksbr }}</div>
                                        </div>
                                    {% endif %}
                                {% endifequal %}
                                {% if j.split_filesets %}
                                    Multi-image filesets cannot be split into 2 groups.

                                    {% for fs in j.split_filesets %}
                                    <div>
                                        You tried to move <strong>{{ fs.attempted_iids|length }}</strong>
                                        image{{ fs.attempted_iids|pluralize}} from a fileset,
                                        leaving <strong>{{ fs.blocking_iids|length }}</strong>.
                                    </div>
                                    {% with MAX_SHOWN=3 %}
                                    <div style="border: 1px solid #87ABD2; float: left">
                                        {% for iid in fs.attempted_iids|slice:":3" %}
                                            <a href="{% url webindex %}?show=image-{{ iid }}">
                                                <img src="{% url render_thumbnail_resize 96 iid %}" class="fileset_image"/>
                                            </a>
                                        {% endfor %}
                                        {% if fs.attempted_iids|length > MAX_SHOWN %}
                                            <div style="height:35px; float: left; line-height:65px"> ... </div>
                                        {% endif %}
                                    </div>
                                    <div style="border: 1px solid #87ABD2; float: left; margin-left:35px">
                                        {% for iid in fs.blocking_iids|slice:":3" %}
                                            <a href="{% url webindex %}?show=image-{{ iid }}">
                                                <img src="{% url render_thumbnail_resize 96 iid %}" class="fileset_image"/>
                                            </a>
                                        {% endfor %}
                                        {% if fs.blocking_iids|length > MAX_SHOWN %}
                                            <div style="height:35px; float: left; line-height:65px"> ... </div>
                                        {% endif %}
                                    </div>
                                    <div style="clear:both"></div>
                                    {% endwith %}
                                    {% endfor %}
                                    <div style="float:right">
                                        <a href="{{ j.objs_url }}">
                                            <button class="btn silver" style="padding: 2px"
                                                title="Browse to the {{ j.dtype }}{{ j.obj_ids|pluralize }} you tried to move">
                                                REFRESH
                                            </button>
                                        </a>
    <button class="btn silver chgrp_move_all" style="padding: 2px"
        title="Repeat the move, including ALL images from the Fileset"
        url="{% url chgrp %}?group_id={{ j.to_group_id }}&{{ j.dtype }}={{ j.obj_ids|join:',' }}&fileset={{ j.fsIds|join:'&fileset='}}"
        >
        MOVE ALL
    </button>
                                    </div>
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                {% endifequal %}


                <!-- Delete jobs -->
                {% ifequal j.job_type "delete" %}
                    <tr id="{{ j.id }}" class="{% if j.new %}new_result{% endif %}{% ifequal j.status 'in progress' %} in_progress{% endifequal %}">
                        <td class="activities_state">
                            {% ifequal j.status "in progress" %}
                                <img alt="Deleting" src="{% static "webgateway/img/spinner.gif" %}" />
                            {% else %}
                                {% if j.error %}
                                    <div class='script_error' title="{{ j.error }}">
                                        <img src="{% static "webgateway/img/failed.png" %}" />
                                    </div>
                                {% else %}
                                    {% if j.split_filesets %}
                                        <img title="Fileset Delete Failed" src="{% static "webgateway/img/failed.png" %}" />
                                    {% else %}
                                        <img alt="Success" src="{% static "webgateway/img/success.png" %}" />
                                    {% endif %}
                                {% endif %}
                            {% endifequal %}
                        </td>
                        <td class="script_description" colspan="2">
                            {% if j.delmany %}
                                <span class="activity_title">
                                    Delete {{ j.delmany }} {{ j.dtype }}s
                                </span>
                                <span class="message">
                                {% for iid in j.did %}
                                    {% ifequal j.status "failed" %}
                                        {{ j.dtype }} {{ iid }},
                                    {% else %}
                                        {{ j.dtype }} {{ iid }},
                                    {% endifequal %}
                                {% endfor %}
                                </span>
                            {% else %}
                                <span class="activity_title">
                                    Delete {{ j.dtype }}
                                </span>
                                <span class="message">
                                {% ifequal j.status "failed" %}
                                    {{ j.dtype }} {{ j.did }}
                                {% else %}
                                    {{ j.dtype }} {{ j.did }}
                                {% endifequal %}
                                </span>
                            {% endif %}

                            {% if j.split_filesets %}
                            <span class="message">
                                Deleting part of a multi-image fileset is not allowed.<br/>
                                Delete ALL or None of the images in a fileset.
                                {% for fs in j.split_filesets %}
                                <div>
                                    You tried to delete <strong>{{ fs.attempted_iids|length }}</strong> image{{ fs.attempted_iids|pluralize}}
                                    in a fileset, leaving <strong>{{ fs.blocking_iids|length }}</strong>.
                                </div>
                                {% with MAX_SHOWN=3 %}
                                    <div style="border: 1px solid #87ABD2; float: left">
                                        {% for iid in fs.attempted_iids|slice:":3" %}
                                            <a href="{% url webindex %}?show=image-{{ iid }}">
                                                <img src="{% url render_thumbnail_resize 96 iid %}" class="fileset_image"/>
                                            </a>
                                        {% endfor %}
                                        {% if fs.attempted_iids|length > MAX_SHOWN %}
                                            <div style="height:35px; float: left; line-height:65px"> ... </div>
                                        {% endif %}
                                    </div>
                                    <div style="border: 1px solid #87ABD2; float: left; margin-left:35px">
                                        {% for iid in fs.blocking_iids|slice:":3" %}
                                            <a href="{% url webindex %}?show=image-{{ iid }}">
                                                <img src="{% url render_thumbnail_resize 96 iid %}" class="fileset_image"/>
                                            </a>
                                        {% endfor %}
                                        {% if fs.blocking_iids|length > MAX_SHOWN %}
                                            <div style="height:35px; float: left; line-height:65px"> ... </div>
                                        {% endif %}
                                    </div>
                                    <div style="clear:both"></div>
                                {% endwith %}
                                {% endfor %}
                                <div style="float:right">
                                    <a href="{{ j.objs_url }}">
                                        <button class="btn silver" style="padding: 2px"
                                            title="Browse to the {{ j.dtype }}{{ j.obj_ids|pluralize }} you tried to delete">
                                            REFRESH
                                        </button>
                                    </a>
                                </div>
                            </span>
                            {% endif %}

                            <div class="results">
                                {% if j.dreport %}Error: ({{ j.dreport }}){% endif %}
                            </div>
                        </td>
                    </tr>
                {% endifequal %}




                <!-- Status -->
                {% ifequal j.job_type "script" %}
                    <tr id="{{ j.id }}" class="script{% if j.new %} new_result{% endif %}{% ifequal j.status 'in progress' %} in_progress{% endifequal %}">
						
						<!-- State -->
                        <td class="activities_state">
                            {% ifequal j.status "in progress" %}
								<img alt="Running Script" src="{% static "webgateway/img/spinner.gif" %}" />
                            
							{% else %} 
								{% if j.error %} 
                                <div class='script_error' title="{{ j.error }}">
                                    <img alt="Failed to run script properly" src="{% static "webgateway/img/failed.png" %}" />
								
									
                                    {% comment %}
                                    <!-- Don't allow submitting now. TODO: launch submit page -->
                                    <img src="{% static "webclient/image/info16.png" %}"/>
                                    <input type='submit' title="Send Error as Feeback to the OME team" jobKey="{{ j.key }}"
                                    {% if j.error_sent %}
                                        value='Thank you' disabled='true'
                                    {% else %}
                                        value='Submit Feedback'
                                    {% endif %} />
                                    {% endcomment %}
									
                                </div>
								{% else %}
								<img alt="Success" src="{% static "webgateway/img/success.png" %}" />
	                            {% endif %}
								
                            {% endifequal %}
                        </td>
						
						
						
						<!-- General Script Info -->
                        <td class="script_description">
                            <span class="activity_title">{{ j.job_name }}</span>
                            <span class="message">{{ j.Message }}</span>
                        </td>
						
						
						<!-- I need to put this back in -->
						<!--{{ j.start_time|date:"H:i" }}-->
						
						<!-- Out until there is a better way of displaying -->
						<!--<span class="status">{{ j.status }}</span>-->
						
						
						
						
						<!-- Result of script -->
                        <td class="results">
                            

							<!-- Drop Down -->
                            {% for k,v in j.results.iteritems %}
                                <div>
                                    {% if v.type and v.id %}
									    
										{% comment %}
											{% if v.name %} 
												{{ v.name|truncatebefor:"30" }} {% else %} {{ v.type }} ID: {{ v.id }}
											{% endif %}
                                        {% endcomment %}
										
										    <ul class="menu_btns silver">
												
												<!-- Browser to file in tree -->
                                                {% if v.browse_url %}
                                                    <li class="btn_folder">
														<a href='{{ v.browse_url }}' class='browse' title="Navigate to {{ v.type }} in the main window">
                                                        	Go to {% ifequal v.type "FileAnnotation" %} Attachment {% else %} {{ v.type }} {% endifequal %}
														</a>
													</li>
                                                {% endif %}
												
													
                                                {% ifequal v.type "FileAnnotation" %}
												
													<!-- Download -->
                                                    <li class="btn_download">
														<a href="{% url download_annotation v.id %}" title="Download File">Download</a>
													</li>
                                                    
													{% if v.fileId %}
														<!-- View File Type -->
                                                        <li class="btn_filetype">
															<a href="#" onClick="return OME.openPopup('{% url get_original_file v.fileId %}');"
															    title="Show file in new window">View {{ v.fileType }}</a>
														</li>
                                                    {% endif %}
												{% else %}
												
                                                    {% ifequal v.type "Image" %}
														<!-- View Image -->
                                                        <li class="btn_view">
															<a href="#" onClick="return OME.openPopup('{% url webgateway.views.full_viewer v.id %}');" title="Open Image in Viewer">View Image</a>
														</li>
                                                    {% endifequal %}
													
                                                {% endifequal %}


                                                <!-- add stderr and stdout to first result only -->
                                                {% if forloop.first %}
                                                    {% if j.stderr %}
                                                        
														<!-- View error -->
														<li class="btn_view_error">
															<a href="#" onClick="return OME.openPopup('{% url get_original_file j.stderr %}');"
                                                            title="Show error produced by the script">Error</a>
														</li>
                                                    {% endif %}
													
                                                    {% if j.stdout %}
                                                        
														<!-- More Information -->
														<li class="btn_info">
															<a href="#" onClick="return OME.openPopup('{% url get_original_file j.stdout %}');" 
                                                            title="Show additional info generated by the script">Info</a>
														</li>
                                                    {% endif %}
                                                {% endif %}
												
												<!-- No need to clear from the list
												<li class="btn_trash">
													<a href="#" title="Remove from List" id="{{ j.key }}" class="remove" title="Show additional info generated by the script">
                                                    	Delete
                                                	</a>
												</li>
												-->
												
                                            </ul>
                                        </span>
                                    {% else %}
                                        <!-- Handle rtypes (already unwrapped) -->
                                        <span title="Script Result: '{{ k }}'">
                                        {{ v }}
                                        </span>
                                    {% endif %}
                                </div>
                            {% endfor %}


                            <!-- if there were no results items, we have to display info and error here -->
                            {% if not j.results %}
							<ul class="menu_btns silver">
                                <li class="btn_view_error" style='float:left'>
                                    {% if j.stderr %}<a href="#" onClick="return OME.openPopup('{% url get_original_file j.stderr %}');"
                                        title="Show error produced by the script">Error</a>{% endif %}
                                </li>
								
                                <li class="btn_info">
                                    {% if j.stdout %}<a href="#" onClick="return OME.openPopup('{% url get_original_file j.stdout %}');"
                                        title="Show additional info generated by the script">Info</a>{% endif %}
                                </li>
							</ul>
							{% endif %}
							
                        </td>
						
						
						
						
						<!-- Time -->
                    </tr>
                {% endifequal %}
            {% endfor %}
        </tbody>
    </table>

</div>

</body>
</html>
