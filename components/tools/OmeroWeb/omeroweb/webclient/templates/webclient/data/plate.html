{% load i18n %}



{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

    
    <link rel="stylesheet" type="text/css" href="{% static "webgateway/css/ome.plateview.css"|add:url_suffix %}" media="all" />
    
    <script type="text/javascript" src="{% static "webgateway/js/ome.plateview.js"|add:url_suffix %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.viewportImage.js"|add:url_suffix %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.gs_slider.js"|add:url_suffix %}"></script>
    <script type="text/javascript" src="{% static "webgateway/js/ome.gs_utils.js"|add:url_suffix %}"></script>

    <script type="text/javascript">

        function changeField(field) {
            var datatree = $.jstree.reference('#dataTree');
            var $container = $("#content_details");

            var containerType = $container.data('type');
            var containerId = $container.data('id');
            var containerPath = $container.data('path');
            containerPath = JSON.parse(containerPath);
            var containerNode = datatree.find_omepath(containerPath);

            if (!containerNode) {
                console.log('WARNING: Had to guess container');
                containerNode = OME.getTreeBestGuess(containerType, containerId);
            }

            // Set the field for that node in the tree and reload the tree section
            datatree.set_field(containerNode, field);

            // Reselect the same node to trigger update
            datatree.deselect_all(true);
            datatree.select_node(containerNode);

            return false;
        }

        var primaryIndex = -1;
        var handleClickSelection = function(event, target, elementsSelector) {
            
            var $clickedImage = target || $(event.target);
            
            var thumbs = $(elementsSelector);
            var selIndex = thumbs.index($clickedImage);

            if (event && event.shiftKey ) {
                if ( primaryIndex == -1 ) {
                    primaryIndex = selIndex;
                    $clickedImage.parent().addClass("ui-selected");
                    return;
                }
                
                // select range
                var start = Math.min(primaryIndex,selIndex);
                var end = Math.max(primaryIndex,selIndex);
                
                thumbs.slice(start, end+1).parent().addClass("ui-selected");
                
            }
            else if (event && event.metaKey) {
                if ( primaryIndex == -1 ) {
                    primaryIndex = selIndex;
                }
                
                if($clickedImage.parent().hasClass("ui-selected")) {
                    $clickedImage.parent().removeClass("ui-selected");
                } else {
                    $clickedImage.parent().addClass("ui-selected");
                }
            }
            else {
                thumbs.parent().removeClass("ui-selected");
                $clickedImage.parent().addClass("ui-selected");
                primaryIndex = selIndex;
            }
        }
        
        $(document).ready(function() {

            // Drag to resize #wellImagesContainer bottom panel
            $(".verticalDragHandle").draggable({ axis: "y" })
            .bind("dragstart", function(event, ui) {
                var wellImgs_h = $("#wellImagesContainer").height();
                $(this).data({'dragstart': ui.offset.top, 'wellImgs_h': wellImgs_h});
            })
            .bind("drag", function(event, ui) {
                var dy = ui.offset.top - $(this).data('dragstart');
                var newH = $(this).data('wellImgs_h') - dy;
                $("#wellImagesContainer").css('height', newH + 'px');
                $("#spwContainer").css('bottom', newH + 'px');
            }).
            bind("dragstop", function(event, ui) {
                // Save the current size
                var dy = ui.offset.top - $(this).data('dragstart');
                var newH = $(this).data('wellImgs_h') - dy;
                $('body').data('well_images_panel_height', newH);
            });
            // If height has previously been set, apply this...
            var newH = $('body').data('well_images_panel_height') || 150;
            $("#wellImagesContainer").css('height', newH + 'px');
            $("#spwContainer").css('bottom', newH + 'px');
            $("#wellImagesDragHandle").css('bottom', (newH + 7) + 'px');

            // Resize SPW thumbnails
            var spw_thumb_size = $('body').data('spw_thumb_size') || 64;
            function setSpwThumbSize(size) {
                // Since we don't want to remove previous class (don't know it),
                // just set new class
                // if well is small, offset the hover label
                var cls = size < 30 ? 'wellLabelOffset ' : '';
                cls += 'wellSize' + size;
                $("#spw>table").prop('class', cls);
            }
            $("#thumb_size_slider").slider({
                max: 130,
                min: 10,
                value: spw_thumb_size,
                slide: function(event, ui) {
                    setSpwThumbSize(ui.value);
                },
                stop: function(event, ui) {
                    $('body').data('spw_thumb_size', ui.value);
                }
            });
            // Resize Images in Well
            var well_images_size = $('body').data('well_images_size') || 64;
            $("#wellImages").prop('class', 'fillSpace wellSize' + well_images_size);
            $("#wellImages_size_slider").slider({
                max: 130,
                min: 30,
                value: well_images_size,
                slide: function(event, ui) {
                    $("#wellImages").prop('class', 'fillSpace wellSize' + ui.value);
                },
                stop: function(event, ui) {
                    $('body').data('well_images_size', ui.value);
                }
            });

            // Trigger Well Images selected (to update right panel)
            var triggerWellImagesSelection = function() {
                var selected_objs = $("#wellImages li.ui-selected").map(function(){
                    return {'id': 'image-' + this.getAttribute('data-imageId')};
                });
                $("body")
                    .data("selected_objects.ome", selected_objs)
                    .trigger("selection_change.ome");
            }
            // Handle click on Wellsample Images
            $( '#wellImages' ).on( "click", "img", function(event) {
                // Update 'ui-selected' on images, handling shift-click etc
                handleClickSelection(event, undefined, "#wellImages img");
                triggerWellImagesSelection();
            });
            // Drag selection on WellSample images
            $('#wellImages').selectable({
                filter: 'li',
                distance: 2,
                stop: function(){
                    triggerWellImagesSelection();
                }
            });

            var syncTreeSelection = function(selected, idx, perms) {
                // De-select 'Run' from tree, silent 'true' so we don't trigger clear of centre panel
                var datatree = $.jstree.reference('#dataTree');
                // Update the buttons in the jstree as if nothing selected.
                if (buttonsShowHide) {
                    buttonsShowHide([], datatree);
                }
                // Calls to ome.webclient.actions.js
                OME.well_selection_changed(selected, idx, perms);
            };

            var staticurl = WEBCLIENT.URLS.static_webgateway;
            var wpv = $.WeblitzPlateview($('#spw'), {baseurl: '{{ baseurl }}',
                                                     width: spw_thumb_size,
                                                     staticurl: staticurl,
                                                     useParentPrefix: false});
            var $selected;
            // delegated click and dblclick handlers for wells
            $( '#spw' ).on( "click", "td.well img", function(event) {
                handleClickSelection(event, undefined, "#spw td.well img");
                var $selected = $('td.ui-selected', wpv.self);
                syncTreeSelection($selected, {{ index }}, '{{ manager.getPermsCss }}');
                showImagesInWell();
            });
            $( '#spw' ).on( "dblclick", "td.well img", function(event) {
                OME.openPopup("{% url 'web_image_viewer' 0 %}".replace('/0/', "/"+$(this).attr('id').split("-")[1]+"/" ));
            });

            wpv.self.selectable({
                filter: 'td.well',
                distance: 2,
                stop: function(){  
                    var $selected = $('td.ui-selected', this);
                    syncTreeSelection($selected, {{ index }}, '{{ manager.getPermsCss }}');
                    showImagesInWell();
                },
                start: function(){
                }
            });
            {% if select_wells %}
                wpv.self.bind('_resetLoaded', function(){
                    var sel_well_ids = [{{ select_wells }}],
                        well_id, $well
                        selected_wells = $("");
                    for (var s=0;s<sel_well_ids.length;s++){
                        well_id = sel_well_ids[s];
                        if (typeof well_id === "number") {
                            $well = $("#well-"+well_id);
                            if ($well.length > 0) {
                                selected_wells = selected_wells.add($well);
                            }
                        }
                    }
                    if (selected_wells.length > 0) {
                        handleClickSelection(undefined, selected_wells.children("img"), "#spw td.well img");
                        $selected = $('td.ui-selected', wpv.self);
                        syncTreeSelection($selected, {{ index }}, '{{ manager.getPermsCss }}');
                    }
                });
            {% endif %}

            // Need to apply correct thumb size once loaded
            wpv.self.bind('_resetLoaded', function(){
                setSpwThumbSize(spw_thumb_size);
            });

            wpv.load({{ manager.getPlateId }}, {{ index }});


            var imagesInWellVisible = true;
            $("#showWellImages").click(function(){
                imagesInWellVisible = !imagesInWellVisible;
                showImagesInWell();
            });

            var showImagesInWell = function() {
                var $table = $("#wellImages table");
                if (!imagesInWellVisible) {
                    $table.empty();
                    return;
                }
                var $selected = $('td.ui-selected', wpv.self);
                $table.empty();
                $selected.each(function(i, w){
                    var wellId = w.id.split('-')[1];
                    var label = $(w).children('.wellLabel').text();
                    // create placeholders for each Well
                    $table.append("<tr id='wellImages-" + wellId + "'><td class='wellImagesLabel'><h1>" + label + "</h1></td></tr>");
                    var url = "{% url 'webgateway' %}well/" + wellId + "/children/";
                    $.getJSON(url, function(data){
                        var html = data.reduce(function(html, w){
                            return html + '<li title="' + w.name + '" data-imageId="' + w.id + '"><img src="' + w.thumb_url + '" /></li>';
                        }, "");
                        $('#wellImages-' + wellId).append("<td><ul>" + html + "</ul></tr>");
                    });
                });
            }
        });

    </script>

    <style type="text/css">
        #content_details .fillSpace {
            position: absolute;
            left: 0px;
            right: 0px;
            overflow: auto;
        }
        .wellImages {
            border-top: solid 1px #bbb;
        }
        .wellImages img {
            margin: 2px;
        }
        #wellImages li {
            display: inline-block;
        }
        #wellImages ul,  #wellImages h1{
            margin: 5px;
        }
        #wellImages .ui-selected {
            background-color: #87ABD2;
        }
        .wellImagesLabel {
            width: 30px;
            vertical-align: middle;
        }
        #wellImages td {
            border-bottom: solid #bbb 1px;
        }
    </style>
    
    <!--content-->
<!-- We add/remove class .showWellImages to #content_details expose #wellImages panel -->
<div class='fillSpace' style="top: 0px; height: 29px">
    <div id="fields">
        <form action="" method="POST" class="align_left">
        <table>
          <tbody>
            {% for field in form_well_index %}
            <tr><th>{{ field.label_tag }}</th><td class="input">{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}{{ field.help_text|safe }}</td></tr>
            {% endfor %}
            <div id="well_index" style="display:none">{{ index }}</div>
          </tbody>
        </table>
        </form>
        <div id="toolbar" class="toolbar_noborder">
            <button style="margin: -4px 8px;" id="showWellImages">Hide Images in Well</button>
        </div>
    </div>
</div>
<div id="spwContainer" class='fillSpace' style="top: 29px; bottom: 150px">

    <!-- Scrollable container for spw -->
    <div class='fillSpace' style='top: 0; bottom: 25px'>
        <div id="spw"></div>
    </div>
    <div class='fillSpace' style='bottom: 0; height: 25px; border-top: solid 1px #ddd; background: #EFF1F4' >
        <!-- Slider -->
        <div style="position: absolute; right: 10px; bottom: 0; width: 200px; height: 25px">
            <div id="thumb_size_slider" class="thumb_size_slider" title="Zoom Plate"></div>
        </div>
    </div>
</div>
<div id="wellImagesDragHandle" class='fillSpace' style="bottom: 150px; overflow: visible">
    <div class="verticalDragHandle"></div>
</div>
<div id="wellImagesContainer" class="wellImages fillSpace" style="bottom: 0px; height: 150px">
    <div class='fillSpace toolbarBg' style='top: 0; height: 25px; border-bottom: solid 1px #ddd' >

    </div>
    <!-- Scrollable container for wellImages -->
    <div id="wellImages" class='fillSpace' style='top: 25px; bottom: 25px'>
        <table style="width: 100%"></table>
    </div>
    <div class='fillSpace' style='bottom: 0; height: 25px; border-top: solid 1px #ddd; background: #EFF1F4' >
        <!-- Slider -->
        <div style="position: absolute; right: 10px; bottom: 0px; width: 200px; height: 25px">
            <div id="wellImages_size_slider" class="thumb_size_slider" title="Zoom Plate"></div>
        </div>
    </div>
</div>   
