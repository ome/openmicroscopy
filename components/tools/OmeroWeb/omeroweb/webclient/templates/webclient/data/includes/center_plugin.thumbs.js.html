{% comment %}
/**
  Copyright (C) 2012-2016 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
{% endcomment %}

<script>
/**
 * This script is included in the main containers.html page as well as the container_tags.html and public.html pages,
 * adding itself as a selection listener to the jsTree in each case.
 * It loads appropriate data into the middle panel on selection changes in the jsTree.
 * For the main containers.html page, it also responds to switching between 'plugins'
**/

$(document).ready(function() {

    // Update of centre panel

    /*
    When should the panel update

    1) The image selection has changed (update)
    2) The container selection has changed (refresh)
    3) Something has been deleted or moved out (remove)
    4) Something has been added (refresh)
    */

    var inst = $.jstree.reference('#dataTree');
    var parentNode;     // the currently selected node

    // Start listening for Node Loading events on the tree...
    // If a node loads and it's selected, update_thumbs...
    $("#dataTree").on('load_node.jstree', function(event, data){
        if (data.node.state.selected) {
            update_thumbnails_panel(event, data);
        }
    });

    // This is called directly by various jstree plugins
    // E.g. omecut_plugin.js as well as the jstree in containers.html
    window.update_thumbnails_panel = function(event, data) {

        // Get the current selection
        var selected = inst.get_selected(true);

        // if we're refreshing thumbnail(s) then update thumbVersion in tree first...
        if ((event.type === "refreshThumbnails" || event.type === "refreshThumb")
                && selected.length > 0) {
            var parentNode
            if (selected[0].type === "image") {
                parentNode = inst.get_node(inst.get_parent(selected[0]));
            } else {
                parentNode = inst.get_node(selected[0]);
            }
            parentNode.children.forEach(function(ch){
                ch = inst.get_node(ch);
                if (event.type === "refreshThumbnails" ||
                    (event.type === "refreshThumb" && ch.data.obj.id === data.imageId)) {
                    ch.data.obj.thumbVersion = getRandom();
                }
            })
        }

        // React entry point exported from bundle.js, built with webpack
        renderCentrePanel.default(inst, selected);
        return;
    }

    // Update thumbnails when we switch between plugins
    $('#center_panel_chooser').on('center_plugin_changed.ome', update_thumbnails_panel);

    var getRandom = function() {
        return (Math.random() + "").slice(2);
    }

});

</script>
