{% extends "webclient/base/base_container.html" %}
{% load i18n %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% comment %}
<!--
  This page is the 'home page' of the 3-column data layout for webclient.
  It loads the tree in the left panel. This is then used to load data into the middle and right panels (via AJAX)
  using functions in the actions.js file.
  E.g. On selection change: loadOtherPanels() calls loadMetadataPanel()
-->
{% endcomment %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "3rdparty/jquery-ui-1.8.19/external/jquery.cookie.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/jquery.hotkeys.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/jquery.jstree/jquery.jstree.js" %}"></script>   
    <script type="text/javascript" src="{% static "webclient/javascript/ome.webclient.actions.js" %}"></script>
    <script type="text/javascript">
        String.prototype.capitalize = function() {
            return this.charAt(0).toUpperCase() + this.slice(1);
        }
        
        var handleChgrp = function() {
            $("#chgrp-form").dialog('open');
        }

        var handleNewContainer = function(container_type) {
            
            $("#new_container_type").text(container_type.capitalize());
            var $f = $("#new-container-form");
            var new_container_name = $("input[name='name']", $f).val("");     // clear fields
            var new_container_desc = $("textarea[name='description']", $f).val("");
            $("#new-container-form").dialog('open');
        }

        var handleDelete = function() {
            var selected = $.jstree._focused().get_selected();

            var del_form = $( "#delete-dialog-form" );
            del_form.dialog( "open" );
            // clear previous stuff from form
            $.removeData(del_form, "clicked_button");
            $("#delete_contents_form").show();
            del_form.unbind("dialogclose");
            del_form.find("input[type='checkbox']").attr('checked', false);

            // set up form - process all the objects for data-types and children
            var ajax_data = new Array();
            var q = false;
            var dtypes = {};
            selected.each(function (i) {
                ajax_data[i] = $(this).attr('id').replace("-","=");
                var dtype = $(this).attr('rel');
                if (dtype in dtypes) dtypes[dtype] += 1;
                else dtypes[dtype] = 1;
                if (!q && $(this).attr('rel').indexOf('image')<0) q = true;
            });
            var type_strings = [];
            for (var key in dtypes) {
                type_strings.push(key.capitalize() + (dtypes[key]>1 && "s" || ""));
            }
            var type_str = type_strings.join(" & ");    // For delete dialog: E.g. 'Project & Datasets'
            $("#delete_type").text(type_str);
            if (!q) $("#delete_contents_form").hide();  // don't ask about deleting contents

            // callback when delete dialog is closed
            del_form.bind("dialogclose", function(event, ui) {
                if (del_form.data("clicked_button") == "Yes") {
                    var delete_anns = $("#delete_anns").attr('checked');
                    var delete_content = $("#delete_content").attr('checked');
                    if (delete_content) ajax_data[ajax_data.length] = 'child=on';
                    if (delete_anns) ajax_data[ajax_data.length] = 'anns=on';
                    url = '{% url manage_action_containers "deletemany" %}'
                    $.ajax({
                        async : false,
                        url: url,
                        data : ajax_data.join("&"),
                        dataType: "json",
                        type: "POST",
                        success: function(r){
                            if(eval(r.bad)) {
                                  $.jstree.rollback(data.rlbk);
                                  alert(r.errs);
                              } else {
                                  $("#dataTree").jstree('remove', selected);
                                  refreshActivities();
                              }
                        },
                        error: function(response) {
                            $.jstree.rollback(data.rlbk);
                            alert("Internal server error. Cannot remove object.");
                        }
                    });
                }
            });
        }

        var remove_nodes = function(tree, selected) {
            if (selected.length>0) {
                var images = selected.filter('li[id|=image]');
                var datasets = selected.filter('li[id|=dataset]');
                var removeTxt = "Remove ";
                if (images.length > 0) {
                    removeTxt += images.length + " Image" + ((images.length>1) && "s from their" || " from its") +" Dataset";
                    if (datasets.length > 0) removeTxt += " and<br/>"
                }
                if (datasets.length > 0) {
                    removeTxt += datasets.length + " Dataset" + ((datasets.length>1) && "s from their" || " from its") +" Project";
                }
                removeTxt += "?"
                var confirm_remove = confirm_dialog(removeTxt,
                    function() {
                        if (confirm_remove.data('clicked_button') == "OK") {
                            if (images.length > 0) tree.move_node(images,$("li#orphaned-0"))
                            if (datasets.length > 0) tree.move_node(datasets, $("li#experimenter-0"));
                        }
                    },
                    "Remove item"+ ((selected.length>1) && "s" || "") + "?"
                );
            }
        }

        // Stuff to do on load...
        $(function() 
            {
                $("#left_panel_tabs").tabs({
                    select: function(event, ui) {
                        var url = $.data(ui.tab, 'load.tabs');
                        if( url ) {
                            location.href = url;
                            return false;
                        }
                        return true;
                    }
                });

                // Handle creation of new Project, Dataset or Screen...
                $("#new-container-form").dialog({
                    autoOpen: false,
                    resizable: true,
                    height: 270,
                    width:420,
                    modal: true,
                    buttons: {
                        "OK": function() {
                             createNewContainer();
                             $( this ).dialog( "close" );
                        },
                        "Cancel": function() {
                            $( this ).dialog( "close" );
                        }
                    }
                });
                // same code is called from closing dialog or 'submit' of form
                $("#new-container-form").submit(function() {
                    $("#new-container-form").dialog( "close" );
                    createNewContainer();
                    return false;
                });
                var createNewContainer = function() {
                    var cont_type = $("#new_container_type").text().toLowerCase();  // E.g. 'project'
                    var $f = $("#new-container-form");
                    var new_container_name = $("input[name='name']", $f).val();
                    var new_container_desc = $("textarea[name='description']", $f).val();
                    if ($.trim(new_container_name).length == 0) {
                        alert("Please enter a Name");
                        return;
                    }
                    // if "project" is selected, createDataset under it
                    var selected = $.jstree._focused().get_selected();
                    if(selected.length==1 && selected.attr("rel") == "project" && cont_type == "dataset") {
                        url = '{% url manage_action_containers "addnewcontainer" %}project/'+selected.attr("id").split("-")[1]+'/';
                    // otherwise create an orphan of "folder_type" ('project', 'dataset', 'screen' etc. )
                    } else { url = '{% url manage_action_containers "addnewcontainer" %}'; }

                    $.ajax({
                        url: url,
                        //data: $new_cont_form.serialize();
                        data: {
                            "name" : new_container_name,
                            "folder_type" : cont_type,
                            "description" : new_container_desc
                        },
                        dataType: "json",
                        type: "POST",
                        success: function(r){
                            var cont_id = cont_type + "-" + r['id'];
                            var display_index = 0;
                            $("#dataTree").jstree("create", selected, display_index, 
                                { "attr" : { "rel":cont_type, "id":cont_id}, "data":new_container_name }, 
                                false, true);
                            $("#dataTree").jstree("deselect_all");
                            $("#dataTree").jstree("select_node", "#"+cont_id);
                        }
                    });
                }


                $("#chgrp-form").dialog({
                    autoOpen: false,
                    resizable: true,
                    height: 310,
                    width:420,
                    modal: true,
                    buttons: {
                        "OK": function() {
                            $("#chgrp-form").submit();
                        },
                        "Cancel": function() {
                            $( this ).dialog( "close" );
                        }
                    }
                });
                // handle chgrp 
                $("#chgrp-form").submit(function(e){
                    $("#chgrp-form").dialog("close");
                    var selected = $.jstree._focused().get_selected();
                    var postData = $(this).serialize();
                    if ($(".group_option input[checked=true]", $(this)).length < 1) return false;   // no group chosen
                    var actionUrl= $(this).attr('action') + "?" + get_tree_selection(); // E.g. ?Dataset=34,56$Image=12
                    $.post(actionUrl, postData, function(data){
                        showActivities();
                        $("#dataTree").jstree('remove', selected);
                        
                    });
                    
                    return false
                });
                // chgrp form behavior
                $("#chgrp-form .group_option").click(function(){
                    $("#chgrp-form .group_option").removeClass('selected');
                    $(this).addClass('selected');
                    $("input[type='radio']", $(this)).attr('checked', true);
                });
                $("#chgrp-form .group_option :first").click();  // select first option


                var buttonsShowHide = function(selected, inst) {
                    var toolbar_config = {"addproject":false, 'adddataset':false, 'addscreen':false, 'copy':false, 'cut':false, 'unlink':false, 'delete':false, 'annotation':false, 'basket':false};
                    
                    if(selected.length > 0) {
                        if(selected.attr("rel").indexOf("locked") < 0) {
                            toolbar_config['delete'] = true;
                            if(selected.attr("id").indexOf("experimenter")>=0) {
                                toolbar_config['delete'] = false;
                                toolbar_config["addproject"] = true;
                                toolbar_config['adddataset'] = true;
                                toolbar_config['addscreen'] = true;
                                if ($.inArray(selected.attr('rel').replace("-locked", ""), ["dataset", "plate"]) > -1) {
                                    toolbar_config['copy'] = true;
                                }
                            } else if(selected.attr("id").indexOf("project")>=0) {
                                toolbar_config['adddataset'] = true;
                            } else if(selected.attr("id").indexOf("dataset")>=0) {
                                toolbar_config['copy'] = true;
                                if (selected.parent().parent().length > 0 && selected.parent().parent().attr('rel').replace("-locked", "").indexOf("experimenter") < 0) {
                                    toolbar_config["cut"] = true;
                                    toolbar_config["unlink"] = true;
                                }
                            } else if(selected.attr("id").indexOf("image")>=0) {
                                toolbar_config['basket'] = true;
                                toolbar_config['copy'] = true;
                                if (selected.parent().parent().length > 0 && selected.parent().parent().attr('rel').replace("-locked", "").indexOf("orphaned") < 0) {
                                    toolbar_config["cut"] = true;
                                    toolbar_config["unlink"] = true;
                                }
                            } else if(selected.attr("id").indexOf("plate")>=0) {
                                toolbar_config['copy'] = true;
                                if (selected.parent().parent().length > 0 && selected.parent().parent().attr('rel').replace("-locked", "").indexOf("experimenter") < 0) {
                                    toolbar_config["cut"] = true;
                                    toolbar_config["unlink"] = true;
                                }
                            } 
                        }
                        if ((inst.data.crrm.cp_nodes || inst.data.crrm.ct_nodes) && ($.inArray(selected.attr('rel').replace("-locked", ""), ["project", "dataset", "screen"]) > -1)) {
                            toolbar_config['paste'] = true;
                        }
                    } else {
                        toolbar_config = {"addproject":false, 'adddataset':false, 'addscreen':false, 'copy':false, 'cut':false, 'unlink':false, 'delete':{% if eContext.isLeader %}true{% else %}false{% endif %}, 'annotation':false, 'basket':false};
                    }
                    
                    for (var sIndex in toolbar_config) { 
                        if (toolbar_config[sIndex]){
                            $('input#'+sIndex+'Button').removeClass('button-disabled').removeAttr('disabled');
                        } else {
                            $('input#'+sIndex+'Button').addClass('button-disabled').attr('disabled', true);
                        }
                    }
                }
                
                $("#delete-dialog-form").dialog({
                    autoOpen: false,
                    resizable: true,
                    height: 210,
                    width:420,
                    modal: true,
                    buttons: {
                        "Yes": function() {
                            $("#delete-dialog-form").data("clicked_button", "Yes");
                            $( this ).dialog( "close" );
                        },
                        "No": function() {
                            $("#delete-dialog-form").data("clicked_button", "No");
                            $( this ).dialog( "close" );
                        }
                    }
                });

                var jstree = $("#dataTree").jstree({ 
                        // the list of plugins to include
                    "plugins" : [ "themes", "html_data", "ui", "crrm", "dnd", "types", "hotkeys", "contextmenu" ],
                    // Plugin configuration

                    // I usually configure the plugin that handles the data first - in this case JSON as it is most common
                    "html_data" : { 
                        // I chose an ajax enabled tree - again - as this is most common, and maybe a bit more complex
                        // All the options are the same as jQuery's except for `data` which CAN (not should) be a function
                        "ajax" : {
                            // the URL to fetch the data
                            "url" : function(n) {
                                if (n.attr) {
                                    var parent = this._get_parent(n);
                                    if ($.inArray($(parent).attr("rel").replace("-locked", ""), ["project", "screen"]) > -1) {
                                        url = "{% url load_data %}"+$(parent).attr("rel").replace("-locked", "")+"/"+$(parent).attr("id").split("-")[1]+"/"+n.attr("rel").replace("-locked", "")+"/"+n.attr("id").split("-")[1]+"/";
                                    } else {
                                        url = "{% url load_data %}"+n.attr("rel").replace("-locked", "")+"/"+n.attr("id").split("-")[1]+"/";
                                    }
                                } else {
                                    url = "{% url load_data %}";
                                }
                                return url;
                            },
                            // this function is executed in the instance's scope (this refers to the tree instance)
                            // the parameter is the node being loaded (may be -1, 0, or undefined when loading the root nodes)
                            "data" : function (n) {
                                var r = { "view" : "tree" };
                                if (n.attr && $.inArray(n.attr("rel").replace("-locked", ""), ["dataset", "orphaned"]) > -1) {
                                    if($("div#content_details").attr("rel")===n.attr("id") && $("div#content_details").has("#page").length > 0) {
                                        r["page"] = parseInt($("div#content_details").find("#page").attr("rel"));
                                    }
                                } 
                                return r;
                            }
                        }
                    },
                    // Using types - most of the time this is an overkill
                    // Still meny people use them - here is how
                    "types" : {
                        // I want only `drive` nodes to be root nodes 
                        // This will prevent moving or creating any other type as a root node
                        "max_depth" : -1,
                        "max_children" : -1,
                        "valid_children" : [ "experimenter" ],
                        "types" : {
                            "experimenter" : {
                                "valid_children" : [ "project", "project-locked", "dataset", "dataset-locked", "screen", "screen-locked", "plate", "plate-locked" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/personal16.png" %}'
                                },
                                "create_node" : true,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : false,
                                "remove" : false
                            },
                            "project" : {
                                "valid_children" : [ "dataset" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder16.png" %}'
                                },
                                "create_node" : true,
                                "start_drag" : false,
                                "move_node" : true,
                                "delete_node" : true,
                                "remove" : true
                            },
                            "project-locked" : {
                                "valid_children" : [ "dataset", "dataset-locked" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_locked16.png" %}'
                                },
                                "create_node" : true,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : {% if eContext.isLeader %}true{% else %}false{% endif %},
                                "remove" : {% if eContext.isLeader %}true{% else %}false{% endif %}
                            },
                            "dataset" : {
                                "valid_children" : [ "image", "image-locked" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_image16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : true,
                                "move_node" : true,
                                "delete_node" : true,
                                "remove" : true
                            },
                            "dataset-locked" : {
                                "valid_children" : [ "image", "image-locked" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_image_locked16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : {% if eContext.isLeader %}true{% else %}false{% endif %},
                                "remove" : {% if eContext.isLeader %}true{% else %}false{% endif %}
                            },
                            "image" : {
                                "valid_children" : "none",
                                "icon" : {
                                    "image" : '{% static "webclient/image/image16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : true,
                                "move_node" : true,
                                "delete_node" : true,
                                "remove" : true
                            },
                            "image-locked" : {
                                "valid_children" : "none",
                                "icon" : {
                                    "image" : '{% static "webclient/image/image_locked16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : {% if eContext.isLeader %}true{% else %}false{% endif %},
                                "remove" : {% if eContext.isLeader %}true{% else %}false{% endif %}
                            },
                            "screen" : {
                                "valid_children" : [ "plate", "plate-locked" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_screen16.png" %}'
                                },
                                "create_node" : true,
                                "start_drag" : false,
                                "move_node" : true,
                                "delete_node" : true,
                                "remove" : true
                            },
                            "screen-locked" : {
                                "valid_children" : [ "plate", "plate-locked" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_screen_locked16.png" %}'
                                },
                                "create_node" : true,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : {% if eContext.isLeader %}true{% else %}false{% endif %},
                                "remove" : {% if eContext.isLeader %}true{% else %}false{% endif %}
                            },
                            "plate" : {
                                "valid_children" : "acquisition",
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_plate16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : true,
                                "move_node" : true,
                                "delete_node" : true,
                                "remove" : true
                            },
                            "plate-locked" : {
                                "valid_children" : "acquisition",
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_plate_locked16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : {% if eContext.isLeader %}true{% else %}false{% endif %},
                                "remove" : {% if eContext.isLeader %}true{% else %}false{% endif %}
                            },
                            "acquisition" : {
                                "valid_children" : "none",
                                "icon" : {
                                    "image" : '{% static "webclient/image/image16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : false,
                                "remove" : false
                            },
                            "acquisition-locked" : {
                                "valid_children" : "none",
                                "icon" : {
                                    "image" : '{% static "webclient/image/image16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : false,
                                "remove" : false
                            },
                            "orphaned" : {
                                "valid_children" : [ "image", "image_locked" ],
                                "icon" : {
                                    "image" : '{% static "webclient/image/folder_yellow16.png" %}'
                                },
                                "create_node" : false,
                                "start_drag" : false,
                                "move_node" : false,
                                "delete_node" : false,
                                "remove" : false
                            }                              
                        }
                    },
                    // For UI & core - the nodes to initially select and open will be overwritten by the cookie plugin
                    // the UI plugin - it handles selecting/deselecting/hovering nodes
                    "ui" : {
                        "select_limit" : -1,
                        "select_multiple_modifier": multi_key(),
                        "selected_parent_close": "select_parent",
                        "select_prev_on_delete": false,
                        "initially_select" : [ {% if init.initially_select %}"{{ init.initially_select }}"{% else %}"experimenter-0"{% endif %}  ],
                    },
                    // the core plugin - not many options here
                    "core" : { 
                        // just open those two nodes up
                        // as this is an AJAX enabled tree, both will be downloaded from the server
                        "initially_open" : [ {% for p in init.initially_open %}"{{ p }}",{% endfor %} "experimenter-0" ]
                    },
                    "contextmenu" : {
                        "select_node":true,
                        "items" : function(obj){
                            var config = {};
                                                            
                            config["create"] = {
                                "label" : "Create new",
                                "icon"  : '{% static "webclient/image/window_new16.png" %}',
                                "submenu": {
                                    "project": {
                                        "label" : "Project",
                                        "icon"  : '{% static "webclient/image/folder16.png" %}',
                                        action: function (obj) {handleNewContainer("project"); },
                                    },
                                    "dataset": {
                                        "label" : "Dataset",
                                        "icon"  : '{% static "webclient/image/folder_image16.png" %}',
                                        action: function (obj) {handleNewContainer("dataset"); },
                                      },
                                      "screen": {
                                        "label" : "Screen",
                                        "icon"  : '{% static "webclient/image/folder_screen16.png" %}',
                                        action: function (obj) {handleNewContainer("screen"); },
                                      }
                                }
                            };
                            
                            config["ccp"] = {
                                "label"     : "Edit",
                                "action"    : false,
                                "submenu"   : {
                                    "copy"  : {
                                        "label" : "Copy",
                                        "icon"  : '{% static "webclient/image/eclipse_copy_edit16.png" %}',
                                        "action": function() {
                                            this.copy(this.get_selected());
                                        }
                                    },
                                    "cut"   :{
                                        "label" : "Cut",
                                        "icon"  : '{% static "webclient/image/cut16.png" %}',
                                        "action": function() {
                                            this.cut(this.get_selected());
                                        }
                                    },
                                    "paste": {
                                        "label" : "Paste",
                                        "icon"  : '{% static "webclient/image/eclipse_paste_edit16.png" %}',
                                        "action": function() {
                                            this.paste(this.get_selected());
                                        }
                                    },
                                    "unlink"    : {
                                        "label" : "Remove",
                                        "icon"  : '{% static "webclient/image/minus_15.png" %}',
                                        "action": function(){
                                            var tree = this;
                                            //empty clipboard
                                            tree.data.crrm.ct_nodes = false;
                                            tree.data.crrm.cp_nodes = false;
                                            var selected = tree.get_selected();
                                            remove_nodes(tree, selected);
                                        }
                                    }
                                }
                            };
                            
                            config["delete"] = {
                                "label" : "Delete",
                                "icon"  : '{% static "webclient/image/cancel16.png" %}',
                                "action": handleDelete
                            };
                            
                            config["chgrp"] = {
                                "label" : "Move to Group...",
                                "icon"  : '{% static "webclient/image/kuser16.png" %}',
                                "action": handleChgrp
                            };
                            
                            config["basket"] = {
                                "label" : "Add to Basket",
                                "icon"  : '{% static "webclient/image/basket16.png" %}',                                    
                                "action": function(){
                                    addToBasket(this.get_selected(), '{% url update_basket %}');
                                }
                            };
                            
                            if(obj.attr("rel").indexOf("locked")>=0) {
                                {% if not eContext.isLeader %}config["delete"]["_disabled"] = true;{% endif %}
                                config["ccp"]["_disabled"] = true;
                                config["create"]["_disabled"] = true;
                                config["basket"]["_disabled"] = true;
                            } else {
                                if(obj.attr("id").indexOf("orphaned")>=0) {
                                    config["delete"]["_disabled"] = true;
                                    config["ccp"]["_disabled"] = true;
                                    config["create"]["_disabled"] = true;
                                    config["basket"]["_disabled"] = true;
                                    config["chgrp"]["_disabled"] = true;
                                } else if(obj.attr("id").indexOf("experimenter")>=0) {
                                    config["delete"]["_disabled"] = true;
                                    config["ccp"]["_disabled"] = true;
                                    config["basket"]["_disabled"] = true;
                                } else if(obj.attr("id").indexOf("project")>=0) {
                                    config["ccp"]["submenu"]["cut"]["_disabled"] = true;
                                    config["ccp"]["submenu"]["copy"]["_disabled"] = true;
                                    config["ccp"]["submenu"]["unlink"]["_disabled"] = true;
                                    config["create"]["submenu"]["project"]["_disabled"] = true;
                                    config["create"]["submenu"]["screen"]["_disabled"] = true;
                                    config["basket"]["_disabled"] = true;
                                    if (!this.data.crrm.cp_nodes && !this.data.crrm.ct_nodes) {
                                        config["ccp"]["submenu"]["paste"]["_disabled"] = true;
                                    }
                                } else if(obj.attr("id").indexOf("dataset")>=0) {
                                    if (obj.parent().parent().attr('rel').indexOf('experimenter')>=0) {
                                        config["ccp"]["submenu"]["cut"]["_disabled"] = true;
                                        config["ccp"]["submenu"]["unlink"]["_disabled"] = true;
                                    }
                                    if (!this.data.crrm.cp_nodes && !this.data.crrm.ct_nodes) {
                                        config["ccp"]["submenu"]["paste"]["_disabled"] = true;
                                    }
                                    config["create"]["_disabled"] = true;
                                    config["basket"]["_disabled"] = true;
                                } else if(obj.attr("id").indexOf("image")>=0) {
                                    if (obj.parent().parent().attr('rel').indexOf('orphaned')>=0) {
                                        config["ccp"]["submenu"]["cut"]["_disabled"] = true;
                                        config["ccp"]["submenu"]["unlink"]["_disabled"] = true;
                                    }
                                    config["ccp"]["submenu"]["paste"]["_disabled"] = true;
                                    config["create"]["_disabled"] = true;
                                } else if(obj.attr("id").indexOf("screen")>=0) {
                                    config["ccp"]["submenu"]["cut"]["_disabled"] = true;
                                    config["ccp"]["submenu"]["copy"]["_disabled"] = true;
                                    config["ccp"]["submenu"]["unlink"]["_disabled"] = true;
                                    config["create"]["_disabled"] = true;
                                    config["basket"]["_disabled"] = true;
                                    if (!this.data.crrm.cp_nodes && !this.data.crrm.ct_nodes) {
                                        config["ccp"]["submenu"]["paste"]["_disabled"] = true;
                                    }
                                } else if(obj.attr("id").indexOf("plate")>=0) {
                                    if (obj.parent().parent().attr('rel').indexOf('experimenter')>=0) {
                                        config["ccp"]["submenu"]["cut"]["_disabled"] = true;
                                        config["ccp"]["submenu"]["unlink"]["_disabled"] = true;
                                    }
                                    config["create"]["_disabled"] = true;
                                    config["ccp"]["submenu"]["paste"]["_disabled"] = true;
                                    config["basket"]["_disabled"] = true;
                                } else {
                                    config["ccp"]["_disabled"] = true;
                                    config["create"]["_disabled"] = true;
                                    config["basket"]["_disabled"] = true;
                                    config["delete"]["_disabled"] = true;
                                }
                            }
                            
                            return config;
                        }
                    },

                    // default hotkeys only do 'hover' on up/down/left/right. We want to 'select'
                    // up/down just move selection, don't expand/collapse
                    // left/right expand and collapse. If right and no children, select next.
                    // space+up/down to select range.
                    "hotkeys" : {
                        "right" : function () {
                            // starting point is the last-selected...
                            var o = this.data.ui.last_selected;
                            // ...unless hover appears selected (we're in the process of rapidly traversing the tree)
                            if (this.data.ui.hovered && this.data.ui.hovered.children("a").hasClass("jstree-clicked") ) {
                                o = this.data.ui.hovered;
                            }
                            if(o && o.length) {
                                if(o.hasClass("jstree-closed")) { this.open_node(o); }
                                // if we are on a leaf and we have more siblings, select them
                                else if (this.is_leaf(o) && (o.nextAll("li").size() > 0)){
                                    var new_select = this._get_next(o);
                                    // make the 'next' node appear selected
                                    o.children("a").removeClass("jstree-clicked");
                                    new_select.children("a").addClass("jstree-clicked");
                                    this.hover_node(new_select);  // also add 'hover' as our marker
                                    var datatree = this;
                                    // our *actual* selection occurs after timeout, if selection hasn't moved yet
                                    setTimeout(function (){
                                        if (new_select.children("a").hasClass("jstree-hovered")) {
                                            datatree.data.ui.selected = $();    // clears any previous selection
                                            datatree.select_node(new_select);   // trigger selection event
                                        }
                                    }, 100);
                                }
                            }
                            return false;
                        },
                        "down" : function () {
                            // remove selection
                            this.data.ui.selected && this.data.ui.selected.children("a").removeClass("jstree-clicked");
                            // starting point is the last-selected...
                            var o = this.data.ui.last_selected;
                            // ...unless hover appears selected (we're in the process of rapidly traversing the tree)
                            if (this.data.ui.hovered && this.data.ui.hovered.children("a").hasClass("jstree-clicked") ) {
                                o = this.data.ui.hovered;
                            }
                            if(o && o.length) {
                                var new_select = this._get_next(o);
                                // make the 'next' node appear selected
                                o.children("a").removeClass("jstree-clicked");
                                new_select.children("a").addClass("jstree-clicked");
                                this.hover_node(new_select);  // also add 'hover' as our marker
                                var datatree = this;
                                // our *actual* selection occurs after timeout, if selection hasn't moved yet
                                setTimeout(function (){
                                    if (new_select.children("a").hasClass("jstree-hovered")) {
                                        datatree.data.ui.selected = $();    // clears any previous selection
                                        datatree.select_node(new_select);   // trigger selection event
                                    }
                                }, 100);
                            }
                            return false;
                        },
                        "up" : function () {
                            // remove selection
                            this.data.ui.selected && this.data.ui.selected.children("a").removeClass("jstree-clicked");
                            // starting point is the last-selected...
                            var o = this.data.ui.last_selected;
                            // ...unless hover appears selected (we're in the process of rapidly traversing the tree)
                            if (this.data.ui.hovered && this.data.ui.hovered.children("a").hasClass("jstree-clicked") ) {
                                o = this.data.ui.hovered;
                            }
                            if(o && o.length) {
                                var new_select = this._get_prev(o);
                                // make the 'previous' node appear selected
                                o.children("a").removeClass("jstree-clicked");
                                new_select.children("a").addClass("jstree-clicked");
                                this.hover_node(new_select);  // also add 'hover' as our marker
                                var datatree = this;
                                // our *actual* selection occurs after timeout, if selection hasn't moved yet
                                setTimeout(function (){
                                    if (new_select.children("a").hasClass("jstree-hovered")) {
                                        datatree.data.ui.selected = $();    // clears any previous selection
                                        datatree.select_node(new_select);   // trigger selection event
                                    }
                                }, 100);
                            }
                            return false;
                        },
                        "left" : function () {
                            var o = this.data.ui.last_selected || -1;
                            if(o && o.length) {
                                // if node is expanded, simply collapse
                                if (o.hasClass("jstree-open")) {
                                    this.close_node(o);
                                } else if (this._get_parent(o)) {
                                    var new_select = this._get_parent(o);
                                    new_select.children("a:eq(0)").click();
                                }
                            }
                            return false;
                        },
                        "shift+down" : function (e) {
                            var o = this.data.ui.selected.last();
                            if(o && o.length) {
                                var new_select = this._get_next(o);
                                this.select_node(new_select, true, e); // tree handles shift events for multi-select
                            }
                            return false;
                        },
                        "shift+up" : function (e) {
                            var o = this.data.ui.selected.first();
                            if(o && o.length) {
                                var new_select = this._get_prev(o);
                                this.select_node(new_select, true, e); // tree handles shift events for multi-select
                            }
                            return false;
                        }
                    }

                })
                .delegate("a", "click.jstree", function (e) {
                    var data = $.jstree._focused();
                    if(!data.is_open() && data.get_selected().length < 2) {
                        data.open_node(data.get_selected());
                    }
                    
                })
                .delegate("a", "dblclick", function(e) {
                    if ($(this).parent().attr('rel')=='image') {
                        openPopup("{% url web_image_viewer 0 %}".replace('0', $(this).parent().attr('id').split("-")[1]));
                    }
                })
                .bind("select_node.jstree", function (e, data) {
                    buttonsShowHide(data.inst.data.ui.last_selected, data.inst);
                    var selected = data.inst.get_selected();
                    if (selected.length > 1) {
                        multipleAnnotation(selected, null, '{% url batch_annotate %}');
                        // if any non-images are selected, clear the centre panel
                        if (selected.filter('li:not([id|=image])').length > 0) {
                            $("div#content_details").empty();
                            $("div#content_details").removeAttr('rel');
                        }
                    } else {
                        loadOtherPanels(data.inst, '{% url webindex %}');
                    }
                    syncPanels(selected);
                    
                })
                .bind("deselect_node.jstree", function (e, data) {
                    var selected = data.inst.get_selected();
                    buttonsShowHide(data.inst.data.ui.last_selected, data.inst);
                    if (selected.length === 1 && data.args[0].length > 0) {
                        data.rslt.obj = selected;
                        loadOtherPanels(data.inst, '{% url webindex %}');
                    }
                    syncPanels(selected);
                })
                .bind("open_node.jstree", function (e, data) {

                })
                .bind("move_node.jstree", function (e, data) {
                    var refresh = false;
                    data.rslt.o.each(function (i) {
                        var remove = false;
                        if (data.inst.data.crrm.cp_nodes) {
                            url = '{% url manage_action_containers "paste" %}'+$(this).attr("rel")+'/'+$(this).attr("id").split("-")[1]+'/'
                            d = {
                                "destination" : data.rslt.np.attr("rel")+'-'+data.rslt.np.attr("id").split("-")[1]
                            }
                        } else  {
                            if (data.rslt.cr.attr('rel')!="orphaned") {
                                url = '{% url manage_action_containers "move" %}'+$(this).attr("rel")+'/'+$(this).attr("id").split("-")[1]+'/';
                                d = {
                                    "parent" : data.rslt.op.attr("rel")+'-'+data.rslt.op.attr("id").split("-")[1], 
                                    "destination" : data.rslt.np.attr("rel")+'-'+data.rslt.np.attr("id").split("-")[1]
                                };
                                if (data.inst.get_container().find('#'+this.id).length > 1 ) data.inst.delete_node(this);
                            } else {
                                url = '{% url manage_action_containers "remove" %}'+$(this).attr("rel")+'/'+$(this).attr("id").split("-")[1]+'/'
                                d = {
                                    "parent" : data.rslt.op.attr("rel")+'-'+data.rslt.op.attr("id").split("-")[1]
                                };
                            }
                        }
                        $.ajax({
                            async : false,
                            url: url,
                            data : d,
                            dataType: "json",
                            type: "POST",
                            success: function(r){
                                if(eval(r.bad)) {
                                      $.jstree.rollback(data.rlbk);
                                      alert(r.errs);
                                  }
                                  else {
                                      refresh = true;
                                      if(data.rslt.cy && $(data.rslt.oc).children("UL").length) {
                                          data.inst.refresh(data.inst._get_node(data.rslt.oc));
                                      }
                                  }
                            },
                            error: function(response) {
                                $.jstree.rollback(data.rlbk);
                                alert("Internal server error. "+response);
                            }
                        });
                    });
                    if (refresh) {
                        data.inst.deselect_all();
                        // refresh source
                        if (!data.inst.is_leaf(data.rslt.op) && $.inArray(data.rslt.op.attr("rel").replace("-locked", ""), ["dataset", "orphaned"]) > -1) {
                            data.inst.refresh(data.inst._get_node('#'+data.rslt.op.attr('id')));
                        }
                        //refresh destination (will already be expanded, even if orphaned)
                        if (!data.inst.is_leaf(data.rslt.cr) && $.inArray(data.rslt.cr.attr("rel").replace("-locked", ""), ["dataset", "orphaned"]) > -1) {
                            data.inst.refresh(data.inst._get_node('#'+data.rslt.cr.attr('id')));
                        }
                        // select the destination (select source if destination is orphaned)
                        if (data.rslt.cr.attr("rel").replace("-locked", "") === "orphaned") {
                            data.inst.select_node(data.rslt.op);
                        } else {
                            data.inst.select_node(data.rslt.cr);
                        }
                        refreshCenterPanel();
                    }
                })
            });
            
    </script>
    
    <script type="text/javascript">
    
    $(function () {
        $("#buttons input").click(function () {
            switch(this.id) {
                case "addprojectButton":
                    handleNewContainer("project");
                    break;
                case "adddatasetButton":
                    handleNewContainer("dataset");
                    break;
                case "addscreenButton":
                    handleNewContainer("screen");
                    break;
                case "copyButton":
                    $("#dataTree").jstree('copy', $.jstree._focused().get_selected());
                    break;
                case "cutButton":
                    $("#dataTree").jstree('cut', $.jstree._focused().get_selected());
                    break;
                case "pasteButton":
                    $("#dataTree").jstree('paste', $.jstree._focused().get_selected());
                    break;
                case "unlinkButton":
                    var jstree = $.jstree._focused();
                    jstree.data.crrm.ct_nodes = false;
                    jstree.data.crrm.cp_nodes = false;
                    var selected = jstree.get_selected();
                    remove_nodes(jstree, selected);
                    break;
                case "deleteButton":
                        handleDelete();
                    break;
                case "basketButton":
                    addToBasket($.jstree._focused().get_selected(), '{% url update_basket %}');
                    break;
                case "refreshButton":
                    $("#dataTree").jstree("refresh");
                    refreshCenterPanel();
                    break;
                default:
                    break;
            }
        });
    });
    </script>
{% endblock %}


{% block left %}

    <div id="left_panel_tabs" class="absolute_fill">
        <ul class="tabslist">
        <li><a href="#Projects" title="Projects">{% trans "Projects+Screens" %}</a></li>
        <li><a href="{% url load_template 'usertags' %}">{% trans "Tags" %}</a></li>
        <li><a href="{% url load_template 'public' %}">{% trans "Public" %}</a></li>
        </ul>


            <!-- toolbar above tree -->
        <div id="Projects">
            <div class="toolbar">
                <div id="buttons" class="align_left">
                    <input id="refreshButton" class="button" type="image" src="{% static "webclient/image/reload16.png" %}" alt="Refresh" title="Refresh" {% comment %}onclick="document.location.href='{% url load_template nav.menu %}'"{% endcomment %}> 
                    |
                    <input id="addprojectButton" class="button button-disabled" type="image" src="{% static "webclient/image/folder16.png" %}" alt="Create new project" title="Create new Project" /> 
                    <input id="adddatasetButton" class="button button-disabled" type="image" src="{% static "webclient/image/folder_image16.png" %}" alt="Create new dataset" title="Create new Dataset" /> 
                    <input id="addscreenButton" class="button button-disabled" type="image" src="{% static "webclient/image/folder_screen16.png" %}" alt="Create new screen" title="Create new Screen" /> |
            
                    <input id="copyButton" class="button button-disabled" type="image" src="{% static "webclient/image/eclipse_copy_edit16.png" %}" alt="Copy" title="Copy" /> 
                    <input id="cutButton" class="button button-disabled" type="image" src="{% static "webclient/image/cut16.png" %}" alt="Cut" title="Cut" /> 
                    <input id="pasteButton" class="button button-disabled" type="image" src="{% static "webclient/image/eclipse_paste_edit16.png" %}" alt="Paste" title="Paste" /> 
                    <input id="unlinkButton" class="button button-disabled" type="image" src="{% static "webclient/image/minus_15.png" %}" alt="Remove" title="Remove" />
                    <input id="deleteButton" class="button button-disabled" type="image" src="{% static "webclient/image/cancel16.png" %}" alt="Delete" title="Delete" /> 
                    <input id="basketButton" class="button button-disabled" type="image" src="{% static "webclient/image/basket16.png" %}" alt="Add to basket" title="Add to basket">
                </div>
            </div>

            <div class="clear"> </div>

            <div id="tree_details">
                <div class="dataTree" id="dataTree"></div>
            </div>
        </div>

        <!-- hidden form for delete dialogs -->
        <div id="delete-dialog-form" title="Delete">
            <p>Are you sure you want to delete the selected <span id="delete_type">Images</span>?</p>
            <p>If yes:</p>
            <form>
            <fieldset style="border: 0px solid white">
                <div id="delete_contents_form"> <!-- we can hide this if we're deleting Images -->
                    <input type="checkbox" name="delete_content" id="delete_content" />
                    Also delete contents?
                    <hr style="color:#eee"/>
                </div>
                <input type="checkbox" name="delete_anns" id="delete_anns" />
                Also delete any Annotations that become 'orphans'?<br/>
            </fieldset>
            </form>
        </div>

        <!-- hidden dialog for new Container -->
        <form id="new-container-form" title="New...">
            <p>Create a new <span id="new_container_type">Container</span>...</p>
            <p>
                <label for="id_name">Name:</label>
                {{ new_container_form.name }}
            </p>
            <p>
                <label for="id_description">Description:</label><br />
                {{ new_container_form.description }}
            </p>
        </form>

        <!-- hidden form for chgrp -->
        <form id="chgrp-form" title="Move to Group" action="{% url chgrp %}">
            {% if eContext.allGroups|length_is:"1" %}
                <p>
                    You are only in a single group.<br>
                    You cannot move data to another group.
                </p>
            {% else %}
                <p>Choose group to move data</p>

                <div class="gray_border">
                {% for grp in eContext.allGroups %}
                    {% ifnotequal grp.id eContext.context.groupId %}
                        <div class='group_option'>
                            <input type="radio" name="group_id" value="{{ grp.id }}" style="display:none"/>
                            <img
                            {% if grp.getDetails.getPermissions.isGroupWrite %} src="{% static "webclient/image/nuvola_ledorange16.png" %}"
                            {% else %}
                                {% if grp.details.permissions.isGroupRead %} src="{% static "webclient/image/nuvola_ledorange_readOnly16.png" %}"
                                {% else %}
                                    src="{% static "webclient/image/nuvola_ledred16.png" %}"
                                {% endif %}
                            {% endif %} />
                            {{ grp.name }}
                        </div>
                    {% endifnotequal %}
                {% endfor %}
                </div>
            {% endif %}
        </form>

    </div>
{% endblock %}

{% block center %}

<div id="content_details"> </div>

{% endblock %}
