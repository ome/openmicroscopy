<html>
{% load i18n %}
{% load common_filters %}
{% load common_tags %}
{% comment %}
<!--
  Copyright (C) 2011-2015 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}
    <script type="text/javascript">
        
        $(document).ready(function()
            {
                var linkify = function(input) {
                    var regex = /(https?|ftp|file):\/\/[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|]/g;
                    return input.replace(regex, "<a href='$&' target='_blank'>$&</a>");
                };
                var linkify_element = function(elements) {
                    elements.each(function() { var $this = $(this); $this.html(linkify($this.html())); });
                };

                $("#comments_container").hide_if_empty();
                $("#fileanns_container").hide_if_empty();
                $("#tags_container").hide_if_empty();
                
                {% if manager.canEdit %}
                // we may have well-index, if we are editing an image within a Well
                var idx = "{{ index }}";
                if (idx.length > 0) {
                    idx = "?index=" + idx;
                }
                $( "#{{ manager.obj_type }}name-{{ manager.obj_id }} button" )      // E.g. imagename-123 button
                    .editable('{% url 'manage_action_containers' "editname" manager.obj_type manager.obj_id %}'+idx,
                        '{% url 'manage_action_containers' "savename" manager.obj_type manager.obj_id %}'+idx,
                        "{{ manager.obj_type }}name-{{ manager.obj_id }}" );
                $( "#{{ manager.obj_type }}description-{{ manager.obj_id }} button" )
                    .editable('{% url 'manage_action_containers' "editdescription" manager.obj_type manager.obj_id %}'+idx,
                        '{% url 'manage_action_containers' "savedescription" manager.obj_type manager.obj_id %}'+idx,
                        "{{ manager.obj_type }}description-{{ manager.obj_id }}", { post_save: linkify });
                linkify_element($( "#{{ manager.obj_type }}description-{{ manager.obj_id }} > p > span" ));
                {% else %}
                linkify_element($( "#image_desc" ));
                {% endif %}
                linkify_element($( ".commentText" ));

                var acquisition_load = false;
                var preview_load = false;
                var hierarchy_load = false;

                $("#custom_annotations td span").hide() // hide the tool tip source elements
                // This does not use tooltip_init because of the relative positions of the
                // tooltip_html elements being different
                $("#custom_annotations td").tooltip({
                    items: '#custom_annotations td',
                    content: function() {
                        return $("span.tooltip_html", $(this)).html();
                    },
                    track: true,
                    show: false,
                    hide: false
                });
                $(".tooltip").parent().children("span").hide(); // hide tool tip source
                $(".tooltip").tooltip_init();

                $(".show_xml").next().hide();   // hide any XML annotation blocks
                // display in a new window      
                $(".show_xml").click(function() {
                    var xml = $(this).next().html();
                    var newWindow=window.open('','','height=500,width=500,scrollbars=yes, top=50, left=100');
                    newWindow.document.write(xml);
                    newWindow.document.close();
                    return false;
                });
                
                {% if manager.image %}
                // handle loading of image hierarchy by ajax
                $("#hierarchy-link").click(function(e){
                    var hierarchy_url = $(this).attr('href');
                    $("#hierarchy-spinner").show();  // waiting...
                    $("#hierarchy-pane").load(hierarchy_url);
                    e.preventDefault();
                    return false;
                })
                {% endif %}

                // show a link to the current object
                $("#show_link_btn").click(function(){
                    $("#link_info_popup").show();
                {% if webclient_path %}
                    var lnk = "{{ webclient_path }}";
                {% else %}
                    var lnk = location.href.substring(0,location.href.length - location.search.length);
                    if (lnk.charAt( lnk.length-1 ) == "#") { lnk = lnk.substring(0, lnk.length-1)}
                {% endif %}
                    var obj_type = "{{manager.obj_type}}";
                    if (obj_type === "acquisition") {
                        obj_type = "run";
                    }
                    lnk += "?show=" + obj_type + "-{{ manager.obj_id }}";
                    var link_input = $("#link_info_popup input");
                    link_input.val(lnk);
                    link_input.get(0).focus();
                    link_input.get(0).select();
                });
                $("#link_info_popup img").click(function(){
                    $("#link_info_popup").hide();
                });

                // show original file path links for images
                var original_file_paths_url,
                    importTransfer;
                {% if manager.image %}
                original_file_paths_url = "{% url 'original_file_paths' manager.image.id %}";
                importTransfer = "{{ manager.image.getInplaceImportCmd }}";
                {% elif manager.well.getWellSample.image %}
                original_file_paths_url = "{% url 'original_file_paths' manager.well.getWellSample.image.id %}";
                importTransfer = "{{ manager.well.getWellSample.image.getInplaceImportCmd }}";
                {% endif %}

                var $toolbar_info_panel = $("#toolbar_info_panel"),
                        // $panel_textarea = $("#toolbar_info_panel textarea"),
                        $panel_title = $("#toolbar_info_panel .panel_title"),
                        $panel_div = $("#toolbar_info_panel .panel_div");


                $( "#toolbar_info_panel" ).on( "click", ".show_more", function() {
                    $(this).hide().next().show();
                    return false;
                });

                $("#show_fs_files_btn").click(function(){

                    // If we're already showing Image file info, toggle hide
                    if ($toolbar_info_panel.is(":visible") && 
                            $panel_title.text().split("Image file").length > 1) {
                        $toolbar_info_panel.hide();
                        return;
                    }
                    $("#toolbar_info_panel").show();
                    $panel_title.html("Loading...");
                    $panel_div.empty();
                    if (original_file_paths_url) {
                        $.getJSON(original_file_paths_url,
                            function(data) {
                                var repo = data.repo,
                                    client = data.client,
                                    html = "";
                                $panel_title.html(repo.length + " Image file" + (repo.length>1 ? "s:" : ":"));

                                if (importTransfer) {
                                    html += "<p>Imported with <strong>--transfer="+ importTransfer;
                                    html += "</strong></p><hr/>";
                                }

                                html += "<p>Imported from:</p>";
                                html += "<p class='pathlist'>" + client.slice(0,2).join("<br>") + "<br>";
                                if (client.length > 2) {
                                    html += "<a class='show_more' href='#'> Show more...</a>";
                                    html += "<span style='display:none'>" + client.slice(2).join("<br>");
                                    html += "</span>";
                                }
                                html += "</p><hr/>";

                                html += "<p>Paths on server:</p>";
                                html += "<p class='pathlist'>" + repo.slice(0,2).join("<br>") + "<br>";
                                if (repo.length > 2) {
                                    html += "<a class='show_more' href='#'> Show more...</a>";
                                    html += "<span style='display:none'>" + repo.slice(2).join("<br>");
                                    html += "</span>";
                                }
                                html += "</p>";
                                $panel_div.append(html);
                            });
                    }
                });

                var hierarchy_url;
                {% if manager.image %}
                hierarchy_url = "{% url 'load_metadata_hierarchy' 'image' manager.image.id %}";
                {% elif manager.well %}
                hierarchy_url = "{% url 'load_metadata_hierarchy' 'image' manager.well.getWellSample.image.id %}";
                {% endif %}
                
                // show Image hierarchy Project/Dataset tree.
                $("#show_image_hierarchy").click(function(){

                    // If we're already showing Image file info, toggle hide
                    if ($toolbar_info_panel.is(":visible") && 
                            $panel_title.text().split("contained").length > 1) {
                        $toolbar_info_panel.hide();
                        return;
                    }
                    $("#toolbar_info_panel").show();

                    $panel_title.html("Loading...");
                    $panel_div.empty();
                    if (hierarchy_url) {
                        $panel_div.load(hierarchy_url);
                        $panel_div.load(hierarchy_url,
                            function(data) {
                                $panel_title.html("Image contained in:");
                            });
                    }
                });


                $("#toolbar_info_panel img").click(function(){
                    $("#toolbar_info_panel").hide();
                });

                // handle submit of Add Comment form
                $("#add_comment_form").ajaxForm({
                    beforeSubmit: function(data) {
                        var textArea = $('#add_comment_form textarea');
                        if ($.trim(textArea.val()).length == 0) return false;
                    },
                    success: function(html) {
                        var $comment = $($.trim(html));
                        linkify_element($comment);
                        $('#comments_container').prepend( $comment ).show();
                        var textArea = $('#add_comment_form textarea');
                        textArea.val('');
                        OME.filterAnnotationsAddedBy();
                    },
                });

                // Comment field - show/hide placeholder and submit button.
                $("#add_comment_wrapper label").inFieldLabels();
                $("#id_comment")
                    .blur(function(event){
                        setTimeout(function(){
                            $("#add_comment_form input[type='submit']").hide();
                        }, 200);    // Delay allows clicking on the submit button!
                    })
                    .focus(function(){
                        $("#add_comment_form input[type='submit']").show();
                    });

                // bind removeItem to various [-] buttons
                $("#comments_container").on("click", ".removeComment", function(event){
                    var url = $(this).attr('url');
                    OME.removeItem(event, ".ann_comment_wrapper", 
                        url, $.trim($("#object-id").text()), {{ index|default:"0" }});
                    return false;
                });
                $("#tags_container").on("click", ".removeTag", function(event){
                    var url = $(this).attr('url');
                    OME.removeItem(event, ".tag_annotation_wrapper", url, 
                        $.trim($("#object-id").text()), {{ index|default:"0" }});
                    return false;
                });
                $("#fileanns_container").on("click", ".removeFile", function(event) {
                    var url = $(this).attr('href');
                    OME.removeItem(event, ".file_ann_wrapper", url, 
                        $.trim($("#object-id").text()), {{ index|default:"0" }});
                    return false;
                });
                
                $("#fileanns_container").on("click", ".deleteFile", function(event) {
                    var url = $(this).attr('href');
                    OME.deleteItem(event, "file_ann_wrapper", url, $.trim($("#object-id").text()));
                });

                // Choose to add tags...
                if ($("#add_tags_form").length === 0) {
                    $("<form id='add_tags_form' title='Tags Selection' action='{% url 'annotate_tags' %}' method='post'></form>")
                        .hide().appendTo('body');
                }
                $("#launch_tags_form").click(function(event) {
                    $("#add_tags_form").dialog("open");
                    // load form via AJAX...
                    var load_url = $(this).attr('href');
                    $("#add_tags_form").html('').load(load_url);
                    return false;
                });
                // set-up the tags form to use dialog
                $("#add_tags_form").dialog({
                    autoOpen: false,
                    resizable: false,
                    height: 520,
                    width: 780,
                    modal: true,
                    buttons: {
                        "Save": function() {
                            // simply submit the form (AJAX handling set-up above)
                            $("#add_tags_form").trigger('prepare-submit').submit();
                            $( this ).dialog( "close" );
                        },
                        "Cancel": function() {
                            $( this ).dialog( "close" );
                        },
                        "Reset": function() {
                            // discard all changes and reload the form
                            $("#add_tags_form").html('').load($("#launch_tags_form").attr('href'));
                        }
                    }
                });
                $('#add_tags_form').ajaxForm({
                    success: function(data) {
                        $("#add_tags_form").dialog( "close" );      // hide in case it was submitted via 'Enter'
                        // update the list of tags
                        var $tag = $(data.trim());
                        $("#tags_container").empty().append($tag).hide_if_empty();
                        $(".tooltip", $tag).tooltip_init();
                        OME.filterAnnotationsAddedBy();
                    }
                });


                // set-up the attachment selection form to use AJAX. (requires jquery.form.js plugin)
                if ($("#choose_attachments_form").length === 0) {
                    $("<form id='choose_attachments_form' title='Choose attachments' action='{% url 'annotate_file' %}' method='post'></form>")
                        .hide().appendTo('body');
                }
                $('#choose_attachments_form').ajaxForm({
                    beforeSubmit: function(data) {
                        $("#batch_attachments_form").dialog( "close" );
                        $("#fileann_spinner").show();
                    },
                    success: function(data) {
                        $("#fileann_spinner").hide();
                        // update the list of file annotations and bind actions
                        var $fileanns = $($.trim(data));
                        $("#fileanns_container").prepend( $fileanns ).show();
                        $(".tooltip", $fileanns).tooltip_init();
                        OME.filterAnnotationsAddedBy();
                        OME.fileAnnotationCheckboxDynamicallyAdded();
                    },
                    error: function(data){
                        $("#fileann_spinner").hide();
                        alert("Upload failed [" + data.status + " " + data.statusText + "]");
                    }
                });
                // prepare dialog for choosing file to attach...
                $("#choose_attachments_form").dialog({
                    autoOpen: false,
                    resizable: false,
                    height: 420,
                    width:360,
                    modal: true,
                    buttons: {
                        "Accept": function() {
                            // simply submit the form (AJAX handling set-up above)
                            $("#choose_attachments_form").submit();
                            $( this ).dialog( "close" );
                        },
                        "Cancel": function() {
                            $( this ).dialog( "close" );
                        }
                    }
                });
                // show dialog for choosing file to attach...
                $("#choose_file_anns").click(function() {
                    // show dialog first, then do the AJAX call to load files...
                    var $attach_form = $( "#choose_attachments_form" );
                    $attach_form.dialog( "open" );
                    // load form via AJAX...
                    var load_url = $(this).attr('href');
                    $attach_form.html("&nbsp<br><img src='{% static 'webgateway/img/spinner.gif' %}' /> Loading attachments");
                    $attach_form.load(load_url);
                    return false;
                });

                // Handle Download actions
                $("#create-ometiff").click(function(e){
                    
                    var url = $(this).attr('href');
                    $("#download_dropdown ul").css('visibility', 'hidden');// hide dropdown menu
                    var dialog_opts = ['Cancel', 'Create'];
                    $.ajax({
                        url: "{% url 'ome_tiff_info' manager.obj_id %}",
                        cache: false,
                        dataType: 'json',
                        success: function(data) {
                            var msg = "This will create an OME-TIFF file from this Image.";
                            if (data.id && data.ago) {
                                msg += "<br>Or you can Download one that was created "+ data.ago +" ago.";
                                var download_ometiff = data.download;
                                dialog_opts[1] = "Create New";
                                dialog_opts.push("Download");
                            } else {
                                msg += "<br>This will be attached to the Image and available to download.";
                            }

                            var confirm_ometiff = OME.confirm_dialog(msg,
                                function() {
                                    var btn = confirm_ometiff.data("clicked_button");
                                    switch (btn) {
                                        case "Create":   // two options for the same button
                                        case "Create New":
                                            $.post( url, function() {
                                                OME.showActivities();
                                            });
                                            break;
                                        case "Download":
                                            window.location.href = download_ometiff;
                                            break;
                                    }
                                },
                                "Create OME-TIFF?",
                                dialog_opts,
                                null, 200
                            );
                        }
                    });
                    
                    e.preventDefault();
                    return false;
                });

                // Filtering annotations added by 'me' or 'others' or 'all'
                $("#annotationFilter").change(function(){
                    OME.filterAnnotationsAddedBy();
                });

                // Channel name editing
            {% if manager.image or manager.well.getWellSample.image %}

                var $chNameForm = $("#channel_names_edit");
                // set up form with Parent
                {% if manager.well %}
                // If we're looking at a well we know parent is plate
                  var pid = "plate-{{ manager.well.plate.id.val }}";
                {% else %}
                  // For images in Datasets, we get parent from jsTree, using selected image
                  // E.g. dataset-123
                  var pid = OME.getParentId();
                {% endif %}
                if (typeof pid === "undefined") {
                    $chNameForm.find("button[name=apply]").hide();  // hide 'apply to all'
                } else {
                    var parentType = pid.split("-")[0];
                    $chNameForm.find(".ptype").text( parentType );
                    $chNameForm.find("input[name=parentId]").val(pid).attr('value', pid);
                    if (parentType === "plate") {
                        // Plate: only allow 'Apply to All' (all images linked to same Channels)
                        $chNameForm.find("button[name=save]").remove();
                    }
                }
                var resetChForm = function() {
                    $chNameForm.find(".originalButtons").show();
                    $chNameForm.find(".confirmButtons").hide();
                    $("#channel_names_display").show();
                    $("#editChannelNames").show();
                    $chNameForm.hide();
                }
                // Workflow starts by displaying the form
                $("#editChannelNames").click(function(){
                    $("#channel_names_display").hide();
                    $("#editChannelNames").hide();
                    $chNameForm.show();
                });
                // Handling of all form buttons. NB: save & apply_confirm buttons submit
                $chNameForm.find("button").click(function(event){
                    var name = $(this).attr('name');
                    if (name === "apply") {
                        // Ask users to confirm:
                        $chNameForm.find(".originalButtons").hide();
                        $chNameForm.find(".confirmButtons").show();
                        event.preventDefault(); // prevent form submission etc
                        return false;
                    } else if (name === "cancel") {
                        // cancel - hide and don't submit
                        resetChForm();
                    }
                });
                // Form handled by AJAX
                $chNameForm.ajaxForm({
                    dataType:  'json',
                    success: function(data) {
                        var cnames = data.channelNames;
                        // update the channel names, and ititial values in form
                        $("#channel_names_display span").each(function(i){
                            if (cnames.hasOwnProperty("channel"+i)) {
                                $(this).text(cnames["channel"+i]);
                            }
                        });
                        $chNameForm.find("input").each(function(i){
                            if (cnames.hasOwnProperty( $(this).attr('name') )) {
                                $(this).attr('value', cnames["channel"+i]);
                            }
                        });
                        resetChForm();
                    }
                });

            {% endif %}

                // --- Rating ----
                $("#add_rating").click(function(){
                    $(".myRating").toggle();
                });

                $("#rating_annotations").on("click", ".myRating img", function(event){
                    var $rating = $(this),
                        clickX = event.pageX - $rating.offset().left;
                    var r = (clickX/ $rating.width()) * 5;
                    r = parseInt(Math.ceil(r));
                    setRating(r, $rating);
                });

                $("#rating_annotations").on("click", ".removeRating", function(event){
                    var $liMyRating = $(this).parent(),
                        $ratingimg = $liMyRating.find('img');
                    $liMyRating.hide();
                    setRating(0, $ratingimg);
                });

                var setRating = function(rating, $rating) {
                    // update rating
                    if ($rating) {
                        var rating_src = "{% static 'webclient/image/rating0.png' %}".replace("0.png", rating+".png");
                        $rating.attr('src', rating_src);
                    }
                    // hide the [+] button if we have set a rating
                    if (rating > 0) {
                        $("#add_rating").hide()
                    } else {
                        $("#add_rating").show()
                    }
                    // update rating annotation
                    var rating_url = "{% url 'annotate_rating' %}?{{manager.obj_type}}={{ manager.obj_id }}&index={{ index }}"
                    rating_url += "&rating=" + rating;
                    $.post(rating_url, function(data) {
                        // update summary
                        $("#ratingsAverage").text(data.average);
                        $("#ratingsCount").text(data.count);
                        if (data.count > 0) {
                            $("#ratingsSummary").show();
                        } else {
                            $("#ratingsSummary").hide();
                        }
                    });
                }

                // Handle click on collapsible panes
                $('#metadata_general .can-collapse').click(function () {
                    $(this).toggleClass('closed').next().slideToggle();
                    // remember which panes are expanded
                    var open = [];
                    $('#metadata_general .can-collapse').each(function(){
                        var $this = $(this);
                        if (!$this.hasClass('closed') && $this.attr('data-name')) {
                            open.push($this.attr('data-name'));
                        }
                    });
                    $("#metadata_general").data('open_panes', open);
                });
                // Expand any previously opened panes
                var open_panes = $("#metadata_general").data('open_panes');
                if (open_panes === undefined) {
                    open_panes = ["details"];     // by default, just 'details' is open
                }

                open_panes.forEach(function(name) {
                    // remove 'defclose' flag from open panes
                    $('#metadata_general .can-collapse[data-name="' + name + '"]').removeClass('defclose');
                });
                // Any panes that still have 'defclose' flag, we close
                $('.can-collapse.defclose').removeClass('defclose').addClass('closed').next().hide();



                // For wells, we try to load Bulk table annotations attached to parent Screen / Plate
                // loading just the row we need for the current well.
                {% if manager.well %}
                    var wellsUrl = "{% url 'webgateway_object_table_query' 'Screen.plateLinks.child.wells' manager.well.id %}";
                        linksUrl = "{% url 'webgateway_object_table_query' 'Plate.wells' manager.well.id %}",
                        wellId = {{ manager.well.id }};

                    var showBulkAnnTooltip = function(data) {
                        var bulkAnnTooltip = "<span class='tooltip_html' style='display:none'>" +
                            "Data from tables file:<br />" +
                            "<b>File ID:</b> " + data.id + "<br />" +
                            "<b>Owner:</b> " + data.owner + " <br />" +
                            "<b>Annotation ID:</b> " + data.annId + "<br />" +
                            "<b>Linked to:</b> " + data.parentType + " " + data.parentId + "<br />" +
                            "<b>Linked by:</b> " + data.addedBy + " <br />" +
                            "<b>On:</b> " + OME.formatDate(data.addedOn) + "</span>";
                        $("#bulk-annotations").append(bulkAnnTooltip);
                        $("#bulk-annotations").parent().tooltip({
                                items: '.bulk_annotation',
                                content: function() {
                                    return $("span.tooltip_html", this).html();
                                },
                                track: true,
                                show: false,
                                hide: false
                            });
                    }
                    // Load tables if tables tab is open
                    if (open_panes.indexOf("tables") > -1) {
                        loadBulkAnnotations(wellsUrl, wellId, showBulkAnnTooltip);
                        loadBulkAnnotations(linksUrl, wellId, showBulkAnnTooltip);
                    }

                    // If user opens tables tab, also load tables
                    $('.can-collapse.closed[data-name="tables"]').click(function(){
                        loadBulkAnnotations(wellsUrl, wellId, showBulkAnnTooltip);
                        loadBulkAnnotations(linksUrl, wellId, showBulkAnnTooltip);
                    });
                {% endif %}
            });
            
    </script>


        <!-- This is used by AJAX loading the right panel, to check it matches current selection -->
        <div id='object-id' style="display:none">{{manager.obj_type}}-{{ manager.obj_id }}</div>


        {% if not manager.tag %}
        
        
        <!-- ANNOTATIONS "General" -->
        <div id="general_tab" class="right_tab_inner" >
           
            {% if manager.image %}            

            {% with image=manager.image canDownload=manager.image.canDownload %}
                {% include "webclient/annotations/includes/toolbar.html" %}
            {% endwith %}


            <!-- panel for extra info shown by toolbar buttons if needed - Duplicated under well below -->
            <div id="toolbar_info_panel" style="display:none; background: #fff; border: solid 1px #ddd; margin:5px 0">
                <img title="Close" src="{% static 'webgateway/img/close.gif' %}" style="float:right; margin:3px"/>
                <div class="panel_title" style="margin: 4px">
                    <!-- text loaded here -->
                </div>
                <div class="panel_div"></div>
                <div style="clear:both"></div>
            </div>

            <div id="link_info_popup" class="info_popup" style="right:0px; top:30px; padding:4px; display:none">
                <input type="text" size="30">
                <img title="Close" src="{% static 'webgateway/img/close.gif' %}" />
            </div>

            <!-- Image Name, ID, owner -->
            {% with obj=manager.image nameText=manager.image.name %}
                {% include "webclient/annotations/includes/name.html" %}
            {% endwith %}
                  
            <h1 class="can-collapse defclose" data-name="details">
                Image Details
            </h1>
            <div> 
                  
            <!-- Image Description -->      
            {% with obj=manager.image %}
                {% include "webclient/annotations/includes/description.html" %}
            {% endwith %}
            
            
            
            
            
            
            
            
            
            <!-- Include table of core metadata, Owner, SizeX,Y,Z, Channels etc -->
            {% with image=manager.image parent=manager.image.getParent %}
                {% include "webclient/annotations/includes/core_metadata.html" %}
            {% endwith %}

            </div>


            {% else %}
                {% if manager.dataset %}

                {% include "webclient/annotations/includes/toolbar.html" %}

                <!-- Dataset Name, ID, Owner -->
                {% with obj=manager.dataset nameText=manager.dataset.name %}
                    {% include "webclient/annotations/includes/name.html" %}
                {% endwith %}

                
                <!-- Dataset Description -->
                <h1 class="can-collapse defclose" data-name="details">
                    Dataset Details
                </h1>
                <div> 
                {% with obj=manager.dataset %}
                    {% include "webclient/annotations/includes/description.html" %}
                {% endwith %}
                
                <table>
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.dataset.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>                    
                </table>
                </div>
                {% else %}
                    {% if manager.project %}

                    {% include "webclient/annotations/includes/toolbar.html" %}

                    <!-- Project Name, ID, Owner -->
                    {% with obj=manager.project nameText=manager.project.name %}
                        {% include "webclient/annotations/includes/name.html" %}
                    {% endwith %}

                    
                    <!--Project Description -->
                    <h1 class="can-collapse defclose" data-name="details">
                        Project Details
                    </h1>
                    <div>
                    {% with obj=manager.project %}
                        {% include "webclient/annotations/includes/description.html" %}
                    {% endwith %}
                    
                    <table>
                        <tr>
                            <th>Creation Date:</th>
                            <td id='creation_date'>{{ manager.project.getDate|date:"Y-m-d H:i:s" }}</td>
                        </tr>
                    </table>
                    </div>
                    {% endif %}
                {% endif %}
            {% endif %}
            
            {% if manager.well %}            
            {% with image=manager.well.getWellSample.image %}

            {% with canDownload=manager.well.canDownload omeTiffDisabled=True %}
                {% include "webclient/annotations/includes/toolbar.html" %}
            {% endwith %}


            <!-- panel for extra info shown by toolbar buttons if needed - Duplicated under image above -->
            <div id="toolbar_info_panel" style="display:none; background: #fff; border: solid 1px #ddd; margin:5px 0">
                <img title="Close" src="{% static 'webgateway/img/close.gif' %}" style="float:right; margin:3px"/>
                <div class="panel_title" style="margin: 4px">
                    <!-- text loaded here -->
                </div>
                <div class="panel_div"></div>
                <div style="clear:both"></div>
            </div>

            <!-- Image (in WellSample) Name, ID, Owner -->
            {% with obj=image nameText=image.name wellImageId=image.id %}
                {% include "webclient/annotations/includes/name.html" %}
            {% endwith %}

            
            <!-- Image (in WellSample) Description -->
            <h1 class="can-collapse defclose" data-name="details">
                Well Details
            </h1>
            <div>
            {% with obj=image %}
                {% include "webclient/annotations/includes/description.html" %}
            {% endwith %}

            <!-- Include table of core metadata, Owner, SizeX,Y,Z, Channels etc -->
            {% include "webclient/annotations/includes/core_metadata.html" %}
            </div>
            {% endwith %}{# "image=manager.well.getWellSample.image" #}

            {% else %}
                {% if manager.acquisition %}

                {% include "webclient/annotations/includes/toolbar.html" %}

                <!-- Acquisition Name -->
                {% with obj=manager.acquisition nameText=manager.acquisition.name %}
                    {% include "webclient/annotations/includes/name.html" %}
                {% endwith %}

                
                <!-- Acquisition Description -->
                <h1 class="can-collapse defclose" data-name="details">
                    Run Details
                </h1>
                <div>
                {% with obj=manager.acquisition %}
                    {% include "webclient/annotations/includes/description.html" %}
                {% endwith %}
                
                <table>
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.acquisition.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                </table>
                </div>

                {% else %}
                    {% if manager.plate %}

                    {% include "webclient/annotations/includes/toolbar.html" %}

                    <!-- Plate Name, ID, Owner -->
                    {% with obj=manager.plate nameText=manager.plate.name %}
                        {% include "webclient/annotations/includes/name.html" %}
                    {% endwith %}
                    
                    
                    <!-- Plate Description -->
                    <h1 class="can-collapse defclose" data-name="details">
                        Plate Details
                    </h1>
                    <div>
                    {% with obj=manager.plate %}
                        {% include "webclient/annotations/includes/description.html" %}
                    {% endwith %}


                    <table>
                        <tr>
                            <th>Creation Date:</th>
                            <td id='creation_date'>{{ manager.plate.getDate|date:"Y-m-d H:i:s" }}</td>
                        </tr>
                        <!--{% comment %}
                        <tr>
                            <th>Well Count:</th>
                            <td id='child_count'>{{ manager.plate.countChildren }} {% plural manager.plate.countChildren 'well' 'Wells' %}</td>
                        </tr>
                        {% endcomment %}-->
                    </table>
                    </div>
                    {% else %}
                        {% if manager.screen %}

                        {% include "webclient/annotations/includes/toolbar.html" %}

                        <!-- Screen Name, ID, Owner -->
                        {% with obj=manager.screen nameText=manager.screen.name %}
                            {% include "webclient/annotations/includes/name.html" %}
                        {% endwith %}
                            
                            

                        <!-- Screen Description -->
                        <h1 class="can-collapse defclose" data-name="details">
                            Screen Details
                        </h1>
                        <div>
                        {% with obj=manager.screen %}
                            {% include "webclient/annotations/includes/description.html" %}
                        {% endwith %}

                        <table>
                            <tr>
                                <th>Creation Date:</th>
                                <td id='creation_date'>{{ manager.screen.getDate|date:"Y-m-d H:i:s" }}</td>
                            </tr>                    
                            <tr>
                                <th>Plate Count:</th>
                                <td id='child_count'>{{ manager.screen.countChildren }} {% plural manager.screen.countChildren 'plate' 'plates' %}</td>
                            </tr>
                        </table>
                        </div>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endif %}
            
            
            
            
        
        
    <!-- ANNOTATIONS -->


            <!-- TAGS -->               
            <h1 class="can-collapse defclose" data-name="tags">
                Tags
            </h1>
            <div class="annotations_section">
                
                {% if manager.canAnnotate %}
                    <div>
                        <a id="launch_tags_form" href="{% url 'annotate_tags' %}?{{manager.obj_type}}={{ manager.obj_id }}&index={{ index }}" class="btn silver btn_add"><span></span></a>
                    </div>
                {% endif %}

                <!-- display existing Tags -->
                <div id="tags_container" class="lntags">
                    {% with tags=manager.tag_annotations %}
                        {% include "webclient/annotations/tags.html" %}
                    {% endwith %}
                </div>
 
            </div>



            <!-- MAP ANNOTATIONS -->
            <h1 class="can-collapse defclose" data-name="keyvaluepairs">
                Key-Value Pairs
            </h1>
            <div class="annotations_section">

                {% include "webclient/annotations/mapannotations.html" %}

            </div>



            <!-- TABLES -->
            {% if manager.well %}
            <h1 class="can-collapse defclose" data-name="tables">
                Tables
            </h1>
            <div class="annotations_section">

                <h2 id="bulk-annotations" class="bulk_annotation" style="display: none;">Info</h2>
                <div style="display: none;">
                    <table id="bulk_annotations_table">
                    </table>
                </div>
                <div style="clear:both; margin:8px"></div>
            </div>
            {% endif %}


            <!-- FILES -->
            <h1 class="can-collapse defclose" data-name="attachments">
                Attachments
            </h1>
            <div class="annotations_section">

                    {% if manager.canAnnotate %}
                        <a id="choose_file_anns" href="{% url 'annotate_file' %}?{{manager.obj_type}}={{ manager.obj_id }}&index={{ index }}" class="btn silver btn_add">
                            <span></span>
                        </a>
                        <div class="toolbar">
                            <input type="button" title="Select Files for Scripts"
                                class="btn silver btn_script_dark">
                            <!-- Class "scriptButton" also on <span> as that
                                 is actually what we're clicking on.
                            -->
                        </div>
                        <script type="text/javascript">
                            $(".annotations_section .scriptButton").click(
                                {webindex: "{% url 'webindex' %}"},
                                OME.showScriptList
                            );
                        </script>
                    {% endif %}
                    <img id='fileann_spinner' src="{% static "webgateway/img/spinner.gif" %}" style="display:none"/>

                <div style="clear:both"></div>
                <!-- display existing file annotations -->

                    <ul id="fileanns_container" class="lnfiles">
                        {% with fileanns=manager.file_annotations %}
                            {% include "webclient/annotations/fileanns.html" %}
                        {% endwith %}
                    </ul>
                    <script type="text/javascript">
                        $(".annotations_section .toolbar input[type=button]").click(
                            OME.toggleFileAnnotationCheckboxes
                        );
                        $("#fileanns_container").on(
                            "change", "li input[type=checkbox]",
                            OME.fileAnnotationCheckboxChanged
                        );
                    </script>
            </div>

<!-- >>>>>>> origin/develop -->

            <!-- RATING -->
            <h1 class="can-collapse defclose" data-name="ratings">
                Ratings
            </h1>
            <div class="annotations_section">

                {% with ratings=manager.getGroupedRatings %}

                {% if manager.canAnnotate %}
                    <div>
                        <a id="add_rating" href="#" class="btn silver btn_add"
                            {% if ratings.myRating %}style="display: none"{% endif %}
                        ><span></span></a>
                    </div>
                {% endif %}

                <div style="clear:both"></div>

                <ul id="rating_annotations" class="lnfiles">

                    <li class="rating myRating" style="position: relative {% if not ratings.myRating %}; display:none{% endif %}">
                        <a><img
                        {% if ratings.myRating %}
                        {% ifequal ratings.myRating 1 %} src="{% static "webclient/image/rating1.png" %}"{% endifequal %}
                        {% ifequal ratings.myRating 2 %} src="{% static "webclient/image/rating2.png" %}"{% endifequal %}
                        {% ifequal ratings.myRating 3 %} src="{% static "webclient/image/rating3.png" %}"{% endifequal %}
                        {% ifequal ratings.myRating 4 %} src="{% static "webclient/image/rating4.png" %}"{% endifequal %}
                        {% ifequal ratings.myRating 5 %} src="{% static "webclient/image/rating5.png" %}"{% endifequal %}

                        {% else %}
                            src="{% static "webclient/image/rating0.png" %}"
                        {% endif %}
                        />
                        </a>
                        <a href="#" class="removeRating removeTag" title="Delete rating">X</a>
                    </li>
                </ul>
                <div id="ratingsSummary" {% if not ratings.average %}style="display:none"{% endif %}>
                    (avg:
                    <span id="ratingsAverage">{{ ratings.average }}</span>
                    / <span id="ratingsCount">{{ ratings.count }}</span>
                    votes)
                </div>
                {% endwith %}
             </div>


            
            <!-- COMMENTS -->
            <h1 class="can-collapse defclose" data-name="comments">
                Comments
            </h1>
            <div class="annotations_section">

                    {% if manager.canAnnotate %}
                    <form id="add_comment_form" action="{% url 'annotate_comment' %}" method="post">{% csrf_token %}
                    <table>
                        <tr class="hiddenField"><td>{{ form_comment.image }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.dataset }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.project }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.screen }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.plate }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.acquisition }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.well }}</td></tr>
                        <tr>
                            <td>
                                <div id="add_comment_wrapper" style="position: relative">
                                    <label class="inline_label" for="id_comment">Add Comment:</label>
                                    {{ form_comment.comment }}
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><input type="submit" value="{% trans 'Add Comment' %}" style="display:none" /></td>
                        </tr>
                    </table>
                    </form>
                    {% endif %}

                    <div id="comments_container" class="lncomments">
                        {% for tann in manager.text_annotations %}
                            {% with added_by=tann.link.getDetails.getOwner.id %}
                                {% include "webclient/annotations/comment.html" %}
                            {% endwith %}
                        {% endfor %}
                    </div>
            </div>
            <div class="clear"></div>          
            


            <!-- 'OTHER' ANNOTATIONS -->
            {% if manager.xml_annotations or manager.boolean_annotations or manager.double_annotations or manager.long_annotations or manager.term_annotations or manager.time_annotations %}
            <h1 class="can-collapse defclose" data-name="others">
                Others
            </h1>
            <div class="annotations_section">
                <h2>{% trans "Others" %}:</h2>

                    <!-- tool tips for each <td> is contained in child <span>, which are also hidden -->
                    <table id="custom_annotations">
                        {% for ann in manager.xml_annotations %}
                        <tr data-added-by="{{ ann.link.getDetails.getOwner.id }}">
                            <th>XML:</th>
                            <td>
                                <div>{{ ann.getValue|escape|slice:"0:30" }}...</div>
                                <div class="show_xml">Open in window</div><div>{{ ann.getValue }}</div>
                                {% include "webclient/annotations/custom_ann_tooltip.html" %}
                            </td>
                        </tr>
                        {% endfor %}

                        {% for ann in manager.boolean_annotations %}
                        <tr data-added-by="{{ ann.link.getDetails.getOwner.id }}">
                            <th>Boolean:</th>
                            <td>
                                {{ ann.getValue }}
                                {% include "webclient/annotations/custom_ann_tooltip.html" %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.double_annotations %}
                        <tr data-added-by="{{ ann.link.getDetails.getOwner.id }}">
                            <th>Double:</th>
                            <td>
                                {{ ann.getValue }}
                                {% include "webclient/annotations/custom_ann_tooltip.html" %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.long_annotations %}
                        <tr data-added-by="{{ ann.link.getDetails.getOwner.id }}">
                            <th>Long:</th>
                            <td>
                                {{ ann.getValue }}
                                {% include "webclient/annotations/custom_ann_tooltip.html" %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.term_annotations %}
                        <tr data-added-by="{{ ann.link.getDetails.getOwner.id }}">
                            <th>Term:</th>
                            <td>
                                {{ ann.getValue }}
                                {% include "webclient/annotations/custom_ann_tooltip.html" %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.time_annotations %}
                        <tr data-added-by="{{ ann.link.getDetails.getOwner.id }}">
                            <th>Time:</th>
                            <td>
                                {{ ann.getValue }}
                                {% include "webclient/annotations/custom_ann_tooltip.html" %}
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
            </div>
            {% endif %}

        </div>
        {% endif %}





        {% if manager.tag %}

        <div id="general_tab" class="right_tab_inner" >

            <!-- Toolbar at the top -->
            {% include "webclient/annotations/includes/toolbar.html" %}


                <!-- Tag TextValue, ID, Owner -->
                {% with obj=manager.tag nameText=manager.tag.getValue %}
                    {% include "webclient/annotations/includes/name.html" %}
                {% endwith %}

                <hr/>

                <!-- Tag Description -->
                {% with obj=manager.tag %}
                    {% include "webclient/annotations/includes/description.html" %}
                {% endwith %}
        
                <table>
                    {% if manager.tag.getNs %}
                    {% ifnotequal manager.tag.getNs insight_ns %}
                    <tr>
                        <th>Name space:</th>
                        <td id='namespace'>{{ manager.tag.getNs }}</td>
                    </tr>
                    {% endifnotequal %}
                    {% endif %}
                    <tr>
                        <th>Owner:</th>
                        <td id='owner_fullname'>{{ manager.tag.getOwner.getFullName }}</td>
                    </tr>
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.tag.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                    <tr>
                        <th>Image Count:</th>
                        {% if False %}
                        <td id='child_count'>{{ manager.tag.countChildren }} {% plural manager.tag.countChildren 'tag' 'tags' %}</td>
                        {% endif %}
                    </tr>
                </table>
        </div>
        {% endif %}
</html>
