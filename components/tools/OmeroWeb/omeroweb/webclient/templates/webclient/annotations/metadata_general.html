

{% load i18n %}
{% load common_filters %}
{% load common_tags %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

    <script type="text/javascript">
        
        $(document).ready(function()
            {
                jQuery.fn.tooltip_init = function() {
                    $(this).tooltip({
                        bodyHandler: function() {
                                return $(this).parent().children("span.tooltip_html").html();
                            },
                        track: true,
                        delay: 0,
                        showURL: false,
                        fixPNG: true,
                        showBody: " - ",
                        top: 10,
                        left: -100
                    });
                  return this;
                };

                $("#comments_container").hide_if_empty();
                $("#fileanns_container").hide_if_empty();
                $("#tags_container").hide_if_empty();
                
                {% if manager.canEdit %}
                $( "#{{ manager.obj_type }}name-{{ manager.obj_id }} button" )      // E.g. imagename-123 button
                    .editable('{% url manage_action_containers "editname" manager.obj_type manager.obj_id %}',
                        '{% url manage_action_containers "savename" manager.obj_type manager.obj_id %}',
                        "{{ manager.obj_type }}name-{{ manager.obj_id }}" );
                $( "#{{ manager.obj_type }}description-{{ manager.obj_id }} button" )
                    .editable('{% url manage_action_containers "editdescription" manager.obj_type manager.obj_id %}',
                        '{% url manage_action_containers "savedescription" manager.obj_type manager.obj_id %}',
                        "{{ manager.obj_type }}description-{{ manager.obj_id }}" );
                {% endif %}

                var acquisition_load = false;
                var preview_load = false;
                var hierarchy_load = false;

                
                $("{% for t in manager.tag_annotations %}#tagdesc{{ t.id }}, {% endfor %}#tag").tooltip({ 
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    opacity: 1, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: -15, 
                    left: 5 
                }); 
                
                $("#custom_annotations td span").hide() // hide the tool tip source elements
                $("#custom_annotations td").tooltip({ 
                    bodyHandler: function() { 
                            return $("span.tooltip_html", $(this)).html(); 
                        },
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: 10, 
                    left: -100 
                });
                $(".tooltip").parent().children("span").hide(); // hide tool tip source
                $(".tooltip").tooltip_init();

                $(".show_xml").next().hide();   // hide any XML annotation blocks
                // display in a new window      
                $(".show_xml").click(function() {
                    var xml = $(this).next().html();
                    var newWindow=window.open('','','height=500,width=500,scrollbars=yes, top=50, left=100');
                    newWindow.document.write(xml);
                    newWindow.document.close();
                    return false;
                });
                
                {% if manager.image %}
                // handle loading of image hierarchy by ajax
                $("#hierarchy-link").click(function(e){
                    var hierarchy_url = $(this).attr('href');
                    $("#hierarchy-spinner").show();  // waiting...
                    $("#hierarchy-pane").load(hierarchy_url);
                    e.preventDefault();
                    return false;
                })
                {% endif %}

                // show a link to the current object
                $("#show_link_btn").click(function(){
                    $("#link_info_popup").show();
                    var lnk = location.href.substring(0,location.href.length - location.search.length);
                    lnk += "?show={{manager.obj_type}}-{{ manager.obj_id }}";
                    var link_input = $("#link_info_popup input");
                    link_input.val(lnk);
                    link_input.get(0).focus();
                    link_input.get(0).select();
                });
                $("#link_info_popup img").click(function(){
                    $("#link_info_popup").hide();
                });


                // handle deleting of Tag, File, Comment
                // on successful delete via AJAX, the parent .domClass is hidden
                var removeItem = function(event, domClass) {
                    var removeId = $(event.target).attr('id');
                    var dType = removeId.split("-")[1]; // E.g. 461-comment
                    var annId = parseInt(removeId);
                    // /webclient/action/remove/comment/461/?parent=image-257
                    var parentId = $.trim($("#parent-id").text());
                    var url = '{% url manage_action_containers "remove" %}'+ dType +'/'+ annId +'/';
                    var $parent = $(event.target).parents("."+domClass);
                    var $annContainer = $parent.parent();
                    var confirm_remove = confirm_dialog('Remove '+ dType + '?',
                        function() {
                            if(confirm_remove.data("clicked_button") == "OK") {
                                $.ajax({
                                    type: "POST",
                                    url: url,
                                    data: {'parent':parentId},
									contentType: 'application/javascript',
                                    dataType: 'json',
                                    success: function(r){
                                        if(eval(r.bad)) {
                                            alert(r.errs);
                                        } else {
                                            // simply remove the item (parent class div)
                                            //console.log("Success function");
                                            $parent.remove();
                                            $annContainer.hide_if_empty();
                                        }
                                    }
                                });
                            }
                        }
                    );
                    return false;
                }

                // handle submit of Add Comment form
                $("#add_comment_form").ajaxForm({
                    beforeSubmit: function(data) {
                        var textArea = $('#add_comment_form textarea');
                        if ($.trim(textArea.val()).length == 0) return false;
                    },
                    success: function(html) {
                        var $comment = $(html)
                        $('#comments_container').prepend( $comment ).show();
                        $(".removeComment", $comment).click(function(event) {
                            removeItem(event, "ann_comment_wrapper");
                        });
                        var textArea = $('#add_comment_form textarea');
                        textArea.val('');
                    },
                });

                // bind removeItem to various [-] buttons
                $(".removeComment").click(function(event) {
                    removeItem(event, "ann_comment_wrapper");
                    return false;
                });
                $(".removeTag").click(function(event) {
                    removeItem(event, "tag_annotation_wrapper");
                    return false;
                });
                $(".removeFile").click(function(event) {
                    removeItem(event, "file_ann_wrapper");
                    return false;
                });
                
                var deleteItem = function(event, domClass) {
                    var deleteId = $(event.target).attr('id');
                    var dType = deleteId.split("-")[1]; // E.g. 461-comment
                    var annId = parseInt(deleteId);
                    // /webclient/action/remove/comment/461/?parent=image-257
                    var parentId = $.trim($("#parent-id").text());
                    var url = '{% url manage_action_containers "delete" %}'+ dType +'/'+ annId +'/';
                    var $parent = $(event.target).parents("."+domClass);
                    var $annContainer = $parent.parent();
                    var confirm_remove = confirm_dialog('Delete '+ dType + '?',
                        function() {
                            if(confirm_remove.data("clicked_button") == "OK") {
                                $.ajax({
                                    type: "POST",
                                    url: url,
                                    contentType: 'application/javascript',
									dataType:'json',
                                    success: function(r){
                                        if(eval(r.bad)) {
                                            alert(r.errs);
                                        } else {
                                            // simply remove the item (parent class div)
                                            $parent.remove();
                                            $annContainer.hide_if_empty();
                                            window.parent.refreshActivities();
                                        }
                                    }
                                });
                            }
                        }
                    );
                    return false;
                }
                
                $(".deleteFile").click(function(event) {
                    deleteItem(event, "file_ann_wrapper");
                });
                
                $(".dropdown_menu .menu_launch").click(function(e){
                    $(this).parent().find('ul').css('visibility', 'visible');
                    $(this).parent().find('.dropdown_menu_options').show();
                    return false;
                });
                // on hover-out of the menu itself, hide drop-down menus
                $(".dropdown_menu_options").hover(function(){}, function(){
                    $(this).css('visibility', 'hidden');
                }).hide();


                // Choose to add tags...
                $("#launch_tags_form").click(function(event) {
                    $("#add_tags_form").dialog("open");
                    // load form via AJAX...
                    var load_url = $(this).attr('href');
                    $("#add_tags_form").load(load_url);
                    return false;
                });
                // set-up the tags form to use dialog
                $("#add_tags_form").dialog({
                    autoOpen: false,
                    resizable: false,
                    height: 450,
                    width:420,
                    modal: true,
                    buttons: {
                        "Accept": function() {
                            // simply submit the form (AJAX handling set-up above)
                            $("#add_tags_form").submit();
                            $( this ).dialog( "close" );
                        },
                        "Cancel": function() {
                            $( this ).dialog( "close" );
                        }
                    }
                });
                $('#add_tags_form').ajaxForm({
                    success: function(data) {
                        $("#add_tags_form").dialog( "close" );      // hide in case it was submitted via 'Enter'
                        // update the list of tags
                        var $tag = $(data);
                        $("#tags_container").prepend($tag).hide_if_empty();
                        $(".removeTag", $tag).click(function(event) {
                            removeItem(event, "tag_annotation_wrapper");
                        });
                        $(".tooltip", $tag).tooltip_init();
                    }
                });


                // set-up the attachment selection form to use AJAX. (requires jquery.form.js plugin)
                $('#choose_attachments_form').ajaxForm({
                    beforeSubmit: function(data) {
                        $("#batch_attachments_form").dialog( "close" );
                        $("#fileann_spinner").show();
                    },
                    success: function(data) {
                        $("#fileann_spinner").hide();
                        // update the list of file annotations and bind actions
                        var $fileanns = $(data)
                        $("#fileanns_container").prepend( $fileanns ).show();
                        $(".deleteFile", $fileanns).click(function(event) {
                            deleteItem(event, "file_ann_wrapper");
                        });
                        $(".removeFile", $fileanns).click(function(event) {
                            removeItem(event, "file_ann_wrapper");
                        });
                        $(".tooltip", $fileanns).tooltip_init();
                    },
                    error: function(data){
                        $("#fileann_spinner").hide();
                        alert(data.response);
                    }
                });
                // prepare dialog for choosing file to attach...
                $("#choose_attachments_form").dialog({
                    autoOpen: false,
                    resizable: false,
                    height: 420,
                    width:360,
                    modal: true,
                    buttons: {
                        "Accept": function() {
                            // simply submit the form (AJAX handling set-up above)
                            $("#choose_attachments_form").submit();
                            $( this ).dialog( "close" );
                        },
                        "Cancel": function() {
                            $( this ).dialog( "close" );
                        }
                    }
                });
                // show dialog for choosing file to attach...
                $("#choose_file_anns").click(function() {
                    // show dialog first, then do the AJAX call to load files...
                    var attach_form = $( "#choose_attachments_form" );
                    attach_form.dialog( "open" );
                    // load form via AJAX...
                    var load_url = $(this).attr('href');
                    attach_form.load(load_url);
                    return false;
                });

            });
            
    </script>



        
        <div id='parent-id' style="display:none">
            {% if manager.image %}image-{{ manager.image.id}}{% else %}
                {% if manager.dataset %}dataset-{{ manager.dataset.id}}{% else %}
                    {% if manager.project %}project-{{ manager.project.id }}{% endif %}
                {% endif %}
            {% endif %}
            {% if manager.well %}image-{{ manager.well.getWellSample.image.id }}{% else %}
                {% if manager.acquisition %}acquisition-{{ manager.acquisition.id}}{% else %}
                    {% if manager.plate %}plate-{{ manager.plate.id}}{% else %}
                        {% if manager.screen %}screen-{{ manager.screen.id}}{% endif %}
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>


        {% if not manager.tag %}
        
		
		<!-- ANNOTATIONS "General" -->
        <div id="general_tab" class="right_tab_inner" >
           
		    {% if manager.image %}            
            {% if manager.image.canEdit %}
				<div class="data_heading" id="imagename-{{ manager.image.id }}">
					<h1>
						<span id="imagename-{{ manager.image.id }}-name" style="word-wrap: break-word;">{{ manager.image.name }}</span>
					</h1>
					<button class="btn silver btn_edit" alt="e" title="edit">
						<span></span>
					</button>
						
					{% comment %}
					<img src="{% static "webclient/image/color_line12.png" %}" /> 
					{% endcomment %}
					
				</div>{% else %}
				
				<h1 style="word-wrap: break-word;">{{ manager.image.name }}</h1>{% endif %}
            
                
            	<h2 class="data_heading_id" id='image_id'>
            	    Image ID: <strong>{{ manager.image.id }}</strong>
            	    <!-- open-image link -->
                    <button id="show_link_btn" class="btn silver btn_link" title="Link to this Image">
    					<span></span>
    				</button>
    				<div id="link_info_popup" class="info_popup" style="right:0px; top:30px; padding:4px; display:none">
    				    <input type="text" size="30">
    				    <img title="Close" src="{% static 'webgateway/img/close.gif' %}" />
    				</div>
            	</h2>
            	
				
            <div style="padding-bottom:6px; position:relative">
                
                {% if manager.image.countArchivedFiles %}
                    <div style="float:right; top:30px; padding:4px">
                        <a href="{% url archived_files manager.image.id %}">
                        <img src="{% static "webclient/image/nuvola_download_manager16.png" %}"
                            title="Download {{ manager.image.countArchivedFiles }} Archived file{{ manager.image.countArchivedFiles|pluralize:'s (zip)' }}"/>
                        </a>
                    </div>
                {% endif %}
				
				<button class="btn silver btn_text" href="#" onclick="return openPopup('{% url web_image_viewer manager.image.id %}')"
				        title="Open full image viewer in new window">
					<span>
	                {% trans "Launch full viewer" %} 
					</span>
				</button>
				
                {% if manager.openAstexViewerCompatible %}
                
                <button class="btn silver btn_text" href="#" onclick="return openPopup('{% url open_astex_viewer 'image_8bit' manager.image.id %}')"
                        title="Open with Open Astex Viewer">
					<span>
	                {% trans "Volume viewer" %} 
					</span>
				</button>
                {% endif %}
				
            </div>
                  
				  
				  
				  
				  
			
			<hr/><!-- Temporary Solution. Not the right way to add borders to elements! -->
				  
				  
				  
				  
			<!-- Image Description -->	    
            <div class="description">
                {% if manager.image.canEdit %}
					<div class="data_heading" id="imagedescription-{{ manager.image.id }}">
						<p>
						<span id="imagedescription-{{ manager.image.id }}-description">{{ manager.image.description|default:"Add Description"|linebreaksbr}}</span>
						<button class="btn silver btn_edit" alt="e" title="edit">
							<span></span>
						</button>
						</p>
					</div>
					
					{% else %}
					<span id='image_desc'>{{ manager.image.description|default:""|linebreaksbr }} </span>{% endif %}
            </div>
			
			
			
			
			
			
			
			
			
            <table class="metadata_details">
                <tr>
                    <th>Owner:</th>
                    <td id='owner_fullname'>{{ manager.image.getOwner.getFullName }}</td>
                </tr>
                <tr>
                    <th>Acquisition Date:</th>
                    <td id='acqu_date'>{{ manager.image.getDate|date:"Y-m-d H:i:s" }}</td> <!-- TODO: Insight is m/d/yy h:min AM/PM -->
                </tr>
                <tr>
                    <th>Imported Date:</th>
                    <td id='import_date'>{{ manager.image.creationEventDate|date:"Y-m-d H:i:s" }}</td>
                </tr>
                <tr>
                    <th>Dimensions (XY):</th>
                    <td id='dims_xy'>{{ manager.image.getSizeX }} x {{ manager.image.getSizeY }}</td>
                </tr>
                <tr>
                    <th>Pixels Type:</th>
                    <td id='pixels_type'>{{ manager.image.getPixelsType }}</td>
                </tr>
                {% if manager.image.getPixelSizeX or manager.image.getPixelSizeY or manager.image.getPixelSizeZ %}
                <tr>
                    <th>Pixels Size (XY{% if manager.image.getPixelSizeZ %}Z{% endif %}) (&#181m):</th>
                    <td id='pixels_size'>
                        <div class='tooltip'>{{ manager.image.getPixelSizeX|floatformat:4 }} x {{ manager.image.getPixelSizeY|floatformat:4 }} 
                            {% if manager.image.getPixelSizeZ %} x {{ manager.image.getPixelSizeZ|floatformat:4 }} {% endif %}
                        </div>
                        <span class="tooltip_html" style='display:none'>{{ manager.image.getPixelSizeX }} x {{ manager.image.getPixelSizeY }}
                            {% if manager.image.getPixelSizeZ %} x {{ manager.image.getPixelSizeZ }} {% endif %}
                        </span>
                    </td>
                </tr>
                {% endif %}
                <tr>
                    <th>Z-sections/Timepoints:</th>
                    <td id='dims_zt'>{{ manager.image.getSizeZ }} x {{ manager.image.getSizeT }}</td>
                </tr>
                <tr>
                    <th>Channels:</th>
                    <td id='channel_names'>
                    {% if manager.image.getChannels %}{% for c in manager.image.getChannels %}{% if not forloop.first %}, {% endif %}{{ c.getLabel }}{% endfor %}{% else %}<span class="error">No channel specified</span>{% endif %}
                    </td>
                </tr>
            </table>
            {% else %}
                {% if manager.dataset %}
                {% if manager.dataset.canEdit %}

				<!-- Dataset Name - Dataset Level -->
				<div class="data_heading" id="datasetname-{{ manager.dataset.id }}">
					
					<h1>
						<p id="datasetname-{{ manager.dataset.id }}-name" style="word-wrap: break-word;">{{ manager.dataset.name }}</p>
					</h1>
					
					<button class="btn silver btn_edit" alt="e" title="edit">
						<span></span>
					</button>
					
				</div>
				
				{% else %}
					
					<h1 style="word-wrap: break-word;">
						{{ manager.dataset.name }}
					</h1>
					
					
					
					{% endif %}

                <h2 class="data_heading_id">
                    Dataset ID: <strong>{{ manager.dataset.id }}</strong>
                    <!-- open-dataset link -->
                    <button id="show_link_btn" class="btn silver btn_link" title="Link to this Dataset">
    					<span></span>
    				</button>
    				<div id="link_info_popup" class="info_popup" style="right:0px; top:30px; padding:4px; display:none">
    				    <input type="text" size="30">
    				    <img title="Close" src="{% static 'webgateway/img/close.gif' %}" />
    				</div>
                </h2>    
                
				<hr/>
				
				<!-- Dataset Description -->
                <div class="description">
                    {% if manager.dataset.canEdit %}
					<div class="data_heading" id="datasetdescription-{{ manager.dataset.id }}">
						<p>
							<span id="datasetdescription-{{ manager.dataset.id }}-description">{{ manager.dataset.description|default:"Add a Description"|linebreaksbr}}</span>
						    <button class="btn silver btn_edit" alt="e" title="edit">
    							<span></span>
    						</button>
						</p>

					</div>
					{% else %}
					<span id='dataset_desc'>{{ manager.dataset.description|default:""|linebreaksbr }}</span>
					{% endif %}
                </div>
                
                <table>
                    <tr>
                        <th>Owner:</th>
                        <td id='owner_fullname'>{{ manager.dataset.getOwner.getFullName }}</td>
                    </tr>
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.dataset.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>                    
                    <tr>
                        <th>Image Count:</th>
                        <td id='child_count'>{{ manager.dataset.countChildren }} {% plural manager.dataset.countChildren 'image' 'images' %}</td>
                    </tr>
                </table>
                {% else %}
                    {% if manager.project %}
                    {% if manager.project.canEdit %}
					
					
					<!-- Project Name - Project Level -->
					<div id="projectname-{{ manager.project.id }}" class="data_heading">
						<h1>
							<p id="projectname-{{ manager.project.id }}-name" style="word-wrap: break-word;">{{ manager.project.name }}</p>
						</h1>
						
						<button class="btn silver btn_edit" alt="e" title="edit">
							<span></span>
						</button>
					</div>
					{% else %}
					
					<h1 style="word-wrap: break-word;">{{ manager.project.name }}</h1>{% endif %}
                    
                    <h2 class="data_heading_id">
                        Project ID: <strong>{{ manager.project.id }}</strong>
                        <!-- open link -->
                        <button id="show_link_btn" class="btn silver btn_link" title="Link to this Project">
        					<span></span>
        				</button>
        				<div id="link_info_popup" class="info_popup" style="right:0px; top:30px; padding:4px; display:none">
        				    <input type="text" size="30">
        				    <img title="Close" src="{% static 'webgateway/img/close.gif' %}" />
        				</div>
        			</h2>
					<hr/>
					
					<!--Project Description -->
					<div class="description">
                        {% if manager.project.canEdit %}
						<div class="data_heading" id="projectdescription-{{ manager.project.id }}">
						    <p>                          
						        <span id="projectdescription-{{ manager.project.id }}-description">{{ manager.project.description|default:"Add a Description"|linebreaksbr}}
						        </span>
						        <button class="btn silver btn_edit" alt="e" title="edit">
        							<span></span>
        						</button>
						    </p>
						</div>
					    {% else %}
					    
					    <span id='project_desc'>{{ manager.project.description|default:""|linebreaksbr }}</span>
					    {% endif %}
                    </div>
                    
                    <table>
                        <tr>
                            <th>Owner:</th>
                            <td id='owner_fullname'>{{ manager.project.getOwner.getFullName }}</td>
                        </tr>
                        <tr>
                            <th>Creation Date:</th>
                            <td id='creation_date'>{{ manager.project.getDate|date:"Y-m-d H:i:s" }}</td>
                        </tr>
                        <tr>
                            <th>Dataset Count:</th>
                            <td id='child_count'>{{ manager.project.countChildren }} {% plural manager.project.countChildren 'dataset' 'datasets' %}</td>
                        </tr>
                    </table>
                    {% endif %}
                {% endif %}
            {% endif %}
            
            {% if manager.well %}            
            {% if manager.well.getWellSample.image.canEdit %}
			
			<div id="wellname-{{ manager.well.getWellSample.image.id }}" class="data_heading">
				<h1>
					<p id="wellname-{{ manager.well.getWellSample.image.id }}-name" style="word-wrap: break-word;">{{ manager.well.getWellSample.image.name }}</p>
				</h1>
				<button class="btn silver btn_edit" alt="e" title="edit">
					<span></span>
				</button>
			</div>
			{% else %}
			
			<h1 style="word-wrap: break-word;">{{ manager.well.getWellSample.image.name }}</h1>{% endif %}
                   
            <h2 class="data_heading_id">Image ID: <strong>{{ manager.well.getWellSample.image.id }}</strong> Well ID: <strong>{{ manager.well.id }}</strong></h2>
            
			<button class="btn silver btn_text" href="#" onclick="return openPopup('{% url web_image_viewer manager.well.getWellSample.image.id %}')" alt="View" title="Open full viewer">
				<span>
                {% trans "Launch full viewer" %} 
				</span>
			</button>
			
			<hr/>
			
            <div class="description">
                {% if manager.well.getWellSample.image.canEdit %}
                <div class="data_heading" id="welldescription-{{ manager.well.getWellSample.image.id }}">
                    <p>
                        <span id="welldescription-{{ manager.well.getWellSample.image.id }}-description">{{ manager.well.getWellSample.image.description|default:"Add A Description"|linebreaksbr}}</span>
                        <button class="btn silver btn_edit" alt="e" title="edit">
							<span></span>
						</button>
                    </p>
                </div>
                {% else %}
                
                <span id='well_desc'>{{ manager.well.getWellSample.image.description|default:""|linebreaksbr }}</span>
                {% endif %}
            </div>
            
            <table>
                <tr>
                    <th>Owner:</th>
                    <td id='owner_fullname'>{{ manager.well.getWellSample.image.getOwner.getFullName }}</td>
                </tr>
                <tr>
                    <th>Acquisition Date:</th>
                    <td id='acqu_date'>{{ manager.well.getWellSample.image.getDate|date:"Y-m-d H:i:s" }}</td> <!-- TODO: Insight is m/d/yy h:min AM/PM -->
                </tr>
                <tr>
                    <th>Imported Date:</th>
                    <td id='import_date'>{{ manager.well.getWellSample.image.creationEventDate|date:"Y-m-d H:i:s" }}</td>
                </tr>
                <tr>
                    <th>Dimensions (XY):</th>
                    <td id='dims_xy'>{{ manager.well.getWellSample.image.getSizeX }} x {{ manager.well.getWellSample.image.getSizeY }}</td>
                </tr>
                <tr>
                    <th>Pixels Type:</th>
                    <td id='pixels_type'>{{ manager.well.getWellSample.image.getPixelsType }}</td>
                </tr>
                <tr>
                    <th>Pixels Size (XYZ) (&#181m):</th>
                    <td id='pixels_size'>
                        <div class='tooltip'>{{ manager.well.getWellSample.image.getPixelSizeX|floatformat:4 }} x {{ manager.well.getWellSample.image.getPixelSizeY|floatformat:4 }} 
                            {% if manager.well.getWellSample.image.getPixelSizeZ %} x {{ manager.well.getWellSample.image.getPixelSizeZ|floatformat:4 }} {% endif %}
                        </div>
                        <span class="tooltip_html" style='display:none'>{{ manager.well.getWellSample.image.getPixelSizeX }} x {{ manager.well.getWellSample.image.getPixelSizeY }}
                            {% if manager.well.getWellSample.image.getPixelSizeZ %} x {{ manager.well.getWellSample.image.getPixelSizeZ }} {% endif %}
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>Z-sections/Timepoints:</th>
                    <td id='dims_zt'>{{ manager.well.getWellSample.image.getSizeZ }} x {{ manager.well.getWellSample.image.getSizeT }}</td>
                </tr>
                <tr>
                    <th>Channels:</th>
                    <td id='channel_names'>
                    {% if manager.well.getWellSample.image.getChannels %}{% for c in manager.well.getWellSample.image.getChannels %}{% if not forloop.first %}, {% endif %}{{ c.getLabel }}{% endfor %}{% else %}<span class="error">No channel specified</span>{% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td id='well_status'>
                        {{ manager.well.status|default:"None" }}
                    </td>
                </tr>
            </table>
            {% else %}
                {% if manager.acquisition %}
                {% if manager.acquisition.canEdit %}
				<div id="acquisitionname-{{ manager.acquisition.id }}" class="data_heading">
					<h1>
						<p id="acquisitionname-{{ manager.acquisition.id }}-name" style="word-wrap: break-word;">{{ manager.acquisition.name }}</p>
					</h1>
					<button class="btn silver btn_edit" alt="e" title="edit">
						<span></span>
					</button>
				</div>
				{% else %}
				
				<h1 style="word-wrap: break-word;">{{ manager.acquisition.name }}</h1>{% endif %}
                
                <h2 class="data_heading_id">Plate acquisition ID: <strong>{{ manager.acquisition.id }}</strong></h2>
                
				<hr/>
				
                <div class="description">
                    {% if manager.acquisition.canEdit %}
                    <div class="data_heading" id="acquisitiondescription-{{ manager.acquisition.id }}">
                        <p>
                            <span id="acquisitiondescription-{{ manager.acquisition.id }}-description">{{ manager.acquisition.description|default:" Add a Description"|linebreaksbr}}</span>
                            <button class="btn silver btn_edit" alt="e" title="edit">
    							<span></span>
    						</button>
                        </p>
                        
                    </div>
                {% else %}
                
                    <span id='acquisition_desc'>{{ manager.acquisition.description|default:""|linebreaksbr }}</span>
                {% endif %}
                </div>
                
                <table>
                    <tr>
                        <th>Owner:</th>
                        <td id='owner_fullname'>{{ manager.acquisition.getOwner.getFullName }}</td>
                    </tr>
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.acquisition.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                    <!--{% comment %}
                    <tr>
                        <th>Well Count:</th>
                        <td id='child_count'>{{ manager.acquisition.countChildren }} {% plural manager.acquisition.countChildren 'well' 'Wells' %}</td>
                    </tr>
                    {% endcomment %}-->
                </table>
                {% else %}
                    {% if manager.plate %}
                    {% if manager.plate.canEdit %}<div class="data_heading" id="platename-{{ manager.plate.id }}">
						<h1>
							<p id="platename-{{ manager.plate.id }}-name" style="word-wrap: break-word;">{{ manager.plate.name }}</p>
						</h1>
						<button class="btn silver btn_edit" alt="e" title="edit">
							<span></span>
						</button>
						</div>
						{% else %}
						
						<h1 style="word-wrap: break-word;">{{ manager.plate.name }}</h1>{% endif %}
              
			  		  
			  
                    <h2 class="data_heading_id">
                        Plate ID: <strong>{{ manager.plate.id }}</strong>
                        <!-- open link -->
                        <button id="show_link_btn" class="btn silver btn_link" title="Link to this Plate">
        					<span></span>
        				</button>
        				<div id="link_info_popup" class="info_popup" style="right:0px; top:30px; padding:4px; display:none">
        				    <input type="text" size="30">
        				    <img title="Close" src="{% static 'webgateway/img/close.gif' %}" />
        				</div>
                    </h2>
					
					<hr/>
					
                    <div class="description">
                        {% if manager.plate.canEdit %}
                        <div class="data_heading" id="platedescription-{{ manager.plate.id }}">
                            <p>
                                <span id="platedescription-{{ manager.plate.id }}-description">{{ manager.plate.description|default:"Add a Description"|linebreaksbr}}</span>
                                <button class="btn silver btn_edit" alt="e" title="edit">
        							<span></span>
        						</button>
                                
                            </p>
                            
                    </div>
                    {% else %}
                    
                    <span id='plate_desc'>{{ manager.plate.description|default:""|linebreaksbr }}</span>{% endif %}
                    </div>
                    <table>
                        <tr>
                            <th>Owner:</th>
                            <td id='owner_fullname'>{{ manager.plate.getOwner.getFullName }}</td>
                        </tr>
                        <tr>
                            <th>Creation Date:</th>
                            <td id='creation_date'>{{ manager.plate.getDate|date:"Y-m-d H:i:s" }}</td>
                        </tr>
                        <!--{% comment %}
                        <tr>
                            <th>Well Count:</th>
                            <td id='child_count'>{{ manager.plate.countChildren }} {% plural manager.plate.countChildren 'well' 'Wells' %}</td>
                        </tr>
                        {% endcomment %}-->
                    </table>
                    {% else %}
                        {% if manager.screen %}
                        {% if manager.screen.canEdit %}
						<div class="data_heading" id="screenname-{{ manager.screen.id }}">
							<h1>
								<p id="screenname-{{ manager.screen.id }}-name" style="word-wrap: break-word;">{{ manager.screen.name }}</p>
							</h1>	
							<button class="btn silver btn_edit" alt="e" title="edit">
								<span></span>
							</button>
						</div>
						{% else %}
						
						<h1 style="word-wrap: break-word;">{{ manager.screen.name }}</h1>{% endif %}
            
                        <h2 class="data_heading_id">
                            Screen ID: <strong>{{ manager.screen.id }}</strong>
                            <!-- open link -->
                            <button id="show_link_btn" class="btn silver btn_link" title="Link to this Screen">
            					<span></span>
            				</button>
            				<div id="link_info_popup" class="info_popup" style="right:0px; top:30px; padding:4px; display:none">
            				    <input type="text" size="30">
            				    <img title="Close" src="{% static 'webgateway/img/close.gif' %}" />
            				</div>
                        </h2>
							
						<hr/>	
							
  						 <div class="description">
                            {% if manager.screen.canEdit %}
                            
                            <div class="data_heading" id="screendescription-{{ manager.screen.id }}">
                                <p>
                                    <span id="screendescription-{{ manager.screen.id }}-description">{{ manager.screen.description|default:"Add a Description"|linebreaksbr}}</span>
                                    <button class="btn silver btn_edit" alt="e" title="edit">
            							<span></span>
            						</button>
                                </p>
                                
                            </div>
                            {% else %}
                            
                            <span id='screen_desc'>{{ manager.screen.description|default:""|linebreaksbr }}</span>
                            {% endif %}
                            
                        </div>
                        <table>
                            <tr>
                                <th>Owner:</th>
                                <td id='owner_fullname'>{{ manager.screen.getOwner.getFullName }}</td>
                            </tr>
                            <tr>
                                <th>Creation Date:</th>
                                <td id='creation_date'>{{ manager.screen.getDate|date:"Y-m-d H:i:s" }}</td>
                            </tr>                    
                            <tr>
                                <th>Screen Count:</th>
                                <td id='child_count'>{{ manager.screen.countChildren }} {% plural manager.screen.countChildren 'screen' 'screens' %}</td>
                            </tr>
                        </table>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endif %}
        
        
		
			
			
			
			<hr/><!-- Temporary Solution. Not the right way to add borders to elements! -->
			
			
			
			
			
			
		
		
    <!-- ANNOTATIONS -->
    <!--<h1>{% trans "Annotations" %}</h1>-->
            
			<div class="annotations_section">
            <!-- RATING -->
      
			      	<h2>{% trans "Rating" %}</h2>
                    <div style="clear:both"></div>
                    {% if manager.rating_annotations %}
                    <div class="lntags">
                
                    {% for rating in manager.rating_annotations %}
                
                        {% ifequal rating.getValue 0 %}<img src="{% static "webclient/image/rating0.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 1 %}<img src="{% static "webclient/image/rating1.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 2 %}<img src="{% static "webclient/image/rating2.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 3 %}<img src="{% static "webclient/image/rating3.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 4 %}<img src="{% static "webclient/image/rating4.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 5 %}<img src="{% static "webclient/image/rating5.png" %}">{% endifequal %}
                       
					   
                        {{ rating.getDetails.getOwner.getNameWithInitial }}
                        
                    {% endfor %}
                       
                    </div>
                    {% else %}
                        {% trans "No ratings" %}
                    {% endif %}
             
			 </div>
			
			
			<hr/><!-- Temporary Solution. Not the right way to add borders to elements! -->
			
			
            <!-- TAGS -->               
            <div class="annotations_section">
                
				<h2>{% trans "Tags" %}</h2>
                
				
				
                {% if manager.canAnnotate %}
					<div>
						<a id="launch_tags_form" href="{% url annotate_tags %}?{{manager.obj_type}}={{ manager.obj_id }}" class="btn silver btn_add"><span></span></a>
					</div>
                {% endif %}
                
				<!-- hidden form for choosing new or existing Tags in dialog - load form via AJAX when we show dialog -->
                <form id='add_tags_form' title="Tags Selection" action="{% url annotate_tags %}" method="post" style="display:none">
                </form>
				
                <!-- display existing Tags -->
                <div id="tags_container" class="lntags">
                {% for tag in manager.tag_annotations %}
                    {% include "webclient/annotations/tag.html" %}
                {% endfor %}
                </div>
 
            </div>
			
			
			<hr/><!-- Temporary Solution. Not the right way to add borders to elements! -->
			
			
			
            <!-- FILES -->
            <div class="annotations_section">
                <h2>{% trans "Attachments" %}</h2>

                    {% if manager.canAnnotate %}
                        <a id="choose_file_anns" href="{% url annotate_file %}?{{manager.obj_type}}={{ manager.obj_id }}" class="btn silver btn_add">
                            <span></span>
                        </a>
                    {% endif %}
                    <img id='fileann_spinner' src="{% static "webgateway/img/spinner.gif" %}" style="display:none"/>
                    
                    <!-- hidden form for choosing files in dialog - load form via AJAX when we show dialog -->
                    <form id="choose_attachments_form" style="display:none" title="Choose Attachments" action="{% url annotate_file %}" method="post">
                    </form>
                    

                <!-- display existing file annotations -->

                    <ul id="fileanns_container" class="lnfiles">
                        {% for fileann in manager.file_annotations %}
                            {% include "webclient/annotations/fileann.html" %}
                        {% endfor %}
                    </ul>

			</div>


			<hr/><!-- Temporary Solution. Not the right way to add borders to elements! -->


            <!-- CUSTOM ANNOTATIONS -->
            <div class="annotations_section">
                <h2>{% trans "Others" %}:</h2>
				
                    <!-- tool tips for each <td> is contained in child <span>, which are also hidden -->
                    <table id="custom_annotations">
                        {% for ann in manager.xml_annotations %}
                        <tr><th>XML:</th>
                            <td>
                                <div>{{ ann.getValue|escape|slice:"0:30" }}...</div>
                                <div class="show_xml">Open in window</div><div>{{ ann.getValue }}</div>
                                <span class="tooltip_html" style='display:none'>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% for ann in manager.boolean_annotations %}
                        <tr><th>Boolean:</th>
                            <td>
                                {{ ann.getValue }}
                                <span class="tooltip_html" style='display:none'>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.double_annotations %}
                        <tr><th>Double:</th>
                            <td>
                                {{ ann.getValue }}
                                <span class="tooltip_html" style='display:none'>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.long_annotations %}
                        <tr><th>Long:</th>
                            <td>
                                {{ ann.getValue }}
                                <span class="tooltip_html" style='display:none'>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.term_annotations %}
                        <tr><th>Term:</th>
                            <td>
                                {{ ann.getValue }}
                                <span class="tooltip_html" style='display:none'>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.time_annotations %}
                        <tr><th>Time:</th>
                            <td>
                                {{ ann.getValue }}
                                <span class="tooltip_html" style='display:none'>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
            </div>
                    
					
					
			<hr/><!-- Temporary Solution. Not the right way to add borders to elements! -->

			
			
			<!-- COMMENTS -->
            <div class="annotations_section">
				<h2>{% trans "Comment:" %}</h2>
				
                    {% if manager.canAnnotate %}
                    <form id="add_comment_form" action="{% url annotate_comment %}" method="post">
                    <table>
                        <tr class="hiddenField"><td>{{ form_comment.image }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.dataset }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.project }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.screen }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.plate }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.acquisition }}</td></tr>
                        <tr class="hiddenField"><td>{{ form_comment.well }}</td></tr>
                        <tr>
                            <td>{{ form_comment.comment }}</td>
                        </tr>
                        <tr>
                            <td><input type="submit" value="{% trans 'Add Comment' %}" /></td>
                        </tr>
                    </table>
                    </form>
                    {% endif %}                        
                
					<div id="comments_container" class="lncomments">
                        {% for tann in manager.text_annotations %}
                            {% include "webclient/annotations/comment.html" %}
                        {% endfor %}
                    </div>
           
            <div class="clear"></div>          






			<div class="annotations_section">
	            {% if manager.image %}
	            <!-- HIERARCHY - Contained In -->
	            <h2>Contained in Datasets</h2>
	            <div id="hierarchy-pane">
	                <!-- content is loaded by ajax when this tab is first displayed -->
	                <a id="hierarchy-link" href="{% url load_metadata_hierarchy 'image' manager.image.id %}">Load hierarchy...</a>
	                <img id="hierarchy-spinner" style="display:none" src="{% static "webgateway/img/spinner.gif" %}" />
	            </div>
	            {% endif %}
			</div>
            
        </div>
        {% endif %}





        {% if manager.tag %}
            <div id="general_tab" class="right_tab_inner" >
                {% if manager.tag.canEdit %}
				<div class="data_heading" id="tagname-{{ manager.tag.id }}">
					<h1>
						<p id="tagname-{{ manager.tag.id }}-name" style="word-wrap: break-word;">{{ manager.tag.getValue }}</p>
					</h1>
					<button class="btn silver btn_edit" alt="e" title="edit">
						<span></span>
					</button>
				</div>{% else %}<p style="word-wrap: break-word;">{{ manager.tag.getValue }}</p>{% endif %}
        
                <h2 class="data_heading_id">Tag ID: <strong>{{ manager.tag.id }}</strong></h2>   

				<hr/>

                <div class="description">
                    {% if manager.tag.canEdit %}
                    <div class="data_heading" id="tagdescription-{{ manager.tag.id }}">
                        <p>
                            <span id="tagdescription-{{ manager.tag.id }}-description">{{ manager.tag.description|default:"Add a Description"|linebreaksbr}}</span>
                            <button class="btn silver btn_edit" alt="e" title="edit">
    							<span></span>
    						</button>
                        </p>
                    </div>
                    
                    {% else %}
                    
                    <span id='tag_desc'>{{ manager.tag.description|default:""|linebreaksbr }}</span>{% endif %}
                </div>
        
                <table>
                    <tr>
                        <th>Owner:</th>
                        <td id='owner_fullname'>{{ manager.tag.getOwner.getFullName }}</td>
                    </tr>
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.tag.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                    <tr>
                        <th>Image Count:</th>
                        {% if False %}
                        <td id='child_count'>{{ manager.tag.countChildren }} {% plural manager.tag.countChildren 'tag' 'tags' %}</td>
                        {% endif %}
                    </tr>
                </table>
            </div>
        {% endif %}
    
    

