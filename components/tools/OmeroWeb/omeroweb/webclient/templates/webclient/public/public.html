{% extends "webclient/base/base_container.html" %}
{% load i18n %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% block link %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "webgateway/css/ome.jstree_theme.css" %}" type="text/css" />
{% endblock %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "3rdparty/jquery.jstree/jstree.js" %}"></script>
    <script type="text/javascript" src="{% static "webclient/javascript/jquery.jstree.locate_plugin.js" %}"></script>
    <script type="text/javascript" src="{% static "webclient/javascript/jquery.jstree.conditionalselect_plugin.js" %}"></script>
    <script type="text/javascript" src="{% static "webclient/javascript/jquery.jstree.ometools_plugin.js" %}"></script>

    <script type="text/javascript">

        $(document).ready(function() 
        {

            // Disable the groups/users dropdown menu.
            $("#groupsUsersButton")
                .css('background-image', 'url()')
                .attr('title', 'Use "Scope" in form below to search within specific Groups / Users');
            setTimeout(function(){
                // make sure we remove click handler AFTER it's been added
                $("#groupsUsersButton").off('click');
            },500);
        });

    </script>

    <!-- set-up jsTree, toolbar etc -->
    <script type="text/javascript">
        $(function()
            {
                var buttonsShowHide = function(selected) {
                    var toolbar_config = new Object();
                    if(selected.length > 0) {
                        if((typeof selected.attr("rel") === 'undefined') ||
                                (selected.attr("rel").indexOf("locked")>=0)) {
                            toolbar_config = {"adddiscussion":false, 'removecontent':false};
                        } else {
                            if(selected.attr("id").indexOf("experimenter")>=0) {
                                toolbar_config = {"adddiscussion":true, 'removecontent':false};
                            } else if(selected.attr("id").indexOf("share")>=0) {
                                toolbar_config = {"adddiscussion":false, 'removecontent':false};
                            } else if(selected.attr("id").indexOf("discussion")>=0) {
                               toolbar_config = {"adddiscussion":false, 'removecontent':false};
                            } else if(selected.attr("id").indexOf("image")>=0) {
                               toolbar_config = {"adddiscussion":false, 'removecontent':true};
                            }
                        }
                    }

                    if (selected.length > 1) toolbar_config['annotation'] = true;
                    for (var sIndex in toolbar_config) { 
                        if (toolbar_config[sIndex]){
                            $('input#'+sIndex+'Button').removeClass('button-disabled').prop('disabled', false);
                        } else {
                            $('input#'+sIndex+'Button').addClass('button-disabled').prop('disabled', true);
                        }
                    }
                }

                    // Select jstree and then cascade handle events and setup the tree.
                    var jstree = $("#dataTree")
                    .on('changed.jstree', function (e, data) {
                        var inst = data.instance;

                        // buttonsShowHide(inst.get_selected(true), inst);
                        OME.tree_selection_changed(data, e);
                    })
                    .on("dblclick.jstree", ".jstree-anchor", function (e) {
                        e.preventDefault();
                        var datatree = $.jstree.reference($('#dataTree'));
                        var node = datatree.get_node(this);
                        if (node) {
                            if (node.type === 'image') {
                                //Open the image viewer for this image
                                OME.openPopup("{% url 'web_image_viewer' 0 %}".replace('0', node.data.obj.id ));
                            }
                        }
                    })
                    // TODO Possibly there is a path which can lead here so this will be needed
                    // .on('loaded.jstree', function(e, data) {
                    //     /**
                    //     * Fired when the tree is loaded and ready for action
                    //     */

                    //     // If it isn't present
                    //     if (window.location.search.length == 0) {
                    //         return false;
                    //     }

                    //     // Introspect the URL to get the show parameter
                    //     var param = getURLParameter('show');

                    //     if (param) {
                    //         var inst = data.instance;

                    //         // Gather data for request
                    //         var paramSplit = param.split('-');

                    //         var payload = {};
                    //         payload[paramSplit[0]] = paramSplit[1];

                    //         // AJAX Query to get the path of the item we wish to 'show'
                    //         $.ajax({
                    //             url: '{% url 'api_paths_to_object' %}',
                    //             data : payload,
                    //             dataType: "json",
                    //             type: "GET",
                    //             success: function(json) {
                    //                 data = json.paths;
                    //                 // Use the open_node callback mechanism to facilitate loading the tree to the
                    //                 // point indicated by the path, starting from the top, 'experimenter'.
                    //                 var path = data[0];
                    //                 console.log(path);
                    //                 var lastIndex = path.length - 1;

                    //                 var traverse = function(index, parentNode) {
                    //                     // Get this path component
                    //                     var comp = path[index];
                    //                     // Get the node for this path component
                    //                     var node = inst.locate_node(comp.type + '-' + comp.id, parentNode)[0];

                    //                     // If at any point the node doesn't exist, simply give up as the path has
                    //                     // become invalid
                    //                     if (node === false) {
                    //                         return;
                    //                     }

                    //                     // If this is not the final path component, open it and
                    //                     // traverse in the callback
                    //                      if (index < lastIndex) {
                    //                         inst.open_node(node, function() {
                    //                             traverse(index += 1, node);
                    //                         })

                    //                     // Otherwise select it
                    //                      } else {
                    //                         // TODO Centre view on this selection
                    //                         inst.select_node(node);
                    //                      }
                    //                 };

                    //                 // Start traversing at the start of the path with no parent node
                    //                 traverse(0, undefined);
                    //             },
                    //             error: function(json) {
                    //                 console.log('failure');
                    //             }
                    //         });
                    //     }

                    //     // Update the URL to remove the parameters as they serve to preload data this one
                    //     // time only
                    //     // TODO Test on an old browser
                    //     history.pushState({}, '', window.location.pathname);
                    // })

                    // Setup jstree
                    .jstree({
                        'plugins': ['types', 'sort', 'locate', 'ometools', 'conditionalselect'],
                        // The jstree core
                        'core' : {
                            'themes': {
                                'dots': false,
                                'variant': 'ome'
                            },
                            'data' : {
                                // Configure URL for request
                                'url' : function(node) {
                                    //TODO
                                    // Get the type of the node being expanded
                                    // Figure out what type of children it should have
                                    // Request the list of children from that url, adding any relevant filters
                                    if (node.type === 'experimenter') {
                                        return '{% url 'api_shares' %}'
                                    } else if (node.type === 'share') {
                                        return '{% url 'api_images' %}'
                                    } else if (node.id === '#') {
                                        return '{% url 'api_experimenter' active_user.id %}'
                                    }
                                },
                                // Gather data for request
                                'data' : function(node) {

                                    var payload = {};

                                    // Get the data for this query, special case for experimenter as this
                                    // data is being passed as 'experimenter_id' below and the tag interface
                                    // is expecting either a tagset_id or nothing as the 'id'
                                    if (node.hasOwnProperty('data') && node.type != 'experimenter') {
                                        if (node.data.hasOwnProperty('obj')) {
                                            // Listing images for a share needs to be special cased, because 'id'
                                            // in 'api_list' is dataset. 'share_id' needs to be provided
                                            if (node.type === 'share') {
                                                payload['share_id'] = node.data.obj.id;
                                            } else {
                                                payload['id'] = node.data.obj.id;
                                            }
                                        }
                                    }

                                    if (node.hasOwnProperty('data') && node.type === 'experimenter') {
                                        payload['member_id'] = node.data.obj.id
                                    }

                                    return payload;
                                },
                                'cache': false,
                                // Converter is required because the JSON format being returned is not
                                // jstree specific.
                                'converters' : {
                                    "text json": function (json) {
                                        var data = JSON.parse(json);
                                        var jstree_data = [];

                                        // Add experimenter to the jstree data structure
                                        if (data.hasOwnProperty('experimenter')) {
                                            var value = data.experimenter;
                                            var node = {
                                                'data': {'id': value.id, 'obj': value},
                                                'text': value.firstName + ' ' + value.lastName,
                                                'children': true,
                                                'type': 'experimenter',
                                                'state': {
                                                },
                                                'li_attr': {
                                                    // 'class': 'experimenter',
                                                    'data-id': value.id
                                                }
                                            };

                                            // Add 'state' opened for the current user by default
                                            {% if active_user %}
                                                if (value.id == {{ active_user.getId }}) {
                                                    node.state['opened'] = true;
                                                }
                                            {% endif %}

                                            jstree_data.push(node);

                                        }

                                        // Add images to the jstree data structure
                                        if (data.hasOwnProperty('shares')) {
                                            $.each(data.shares, function(index, value) {
                                                var node = {
                                                    'data': {'id': value.id, 'obj': value},
                                                    'text': value.id.toString(),
                                                    'children': value.childCount > 0 ? true : false,
                                                    'type': 'share',
                                                    'li_attr': {
                                                        // 'class': 'share',
                                                        'data-id': value.id
                                                    }
                                                };
                                                jstree_data.push(node);
                                            });
                                        }

                                        // Add images to the jstree data structure
                                        if (data.hasOwnProperty('discussions')) {
                                            $.each(data.discussions, function(index, value) {
                                                var node = {
                                                    'data': {'id': value.id, 'obj': value},
                                                    'text': value.id.toString(),
                                                    'children': false,
                                                    'type': 'discussion',
                                                    'li_attr': {
                                                        // 'class': 'discussion',
                                                        'data-id': value.id
                                                    }
                                                };
                                                jstree_data.push(node);
                                            });
                                        }

                                        // Add images to the jstree data structure
                                        if (data.hasOwnProperty('images')) {
                                            $.each(data.images, function(index, value) {
                                                if (value.hasOwnProperty('deleted')){
                                                    var node = {
                                                        'data': {'id': value.id, 'obj': value},
                                                        'text': 'Object Deleted',
                                                        'children': false,
                                                        'type': 'deleted',
                                                        'li_attr': {
                                                            // 'class': 'deleted',
                                                            'data-id': value.id
                                                        }
                                                    };
                                                } else {
                                                    var node = {
                                                        'data': {'id': value.id, 'obj': value},
                                                        'text': value.name,
                                                        'children': false,
                                                        'type': 'image',
                                                        'li_attr': {
                                                            // 'class': 'image',
                                                            'data-id': value.id
                                                        }
                                                    };
                                                }
                                                jstree_data.push(node);
                                            });
                                        }

                                        return jstree_data;
                                    }

                                }
                            }
                        },
                        'types' : {
                            '#' : {
                                'valid_children': ['experimenter']
                            },
                            'default': {
                                'draggable': false
                            },
                            'experimenter': {
                                'icon' : '{% static "webclient/image/icon_user.png" %}',
                                'valid_children': ['share', 'discussion']
                            },
                            'share': {
                                'icon' : '{% static "webclient/image/left_sidebar_icon_public.png" %}',
                                'valid_children': ['image']
                            },
                            'discussion': {
                                'icon' : '{% static "webclient/image/wp_protocol16.png" %}'
                            },
                            'image': {
                                'icon': '{% static "webclient/image/image16.png" %}',
                            },
                            'deleted': {
                                'icon': false
                            }

                        },
                        // TODO Performance of sort may not be realistic. The tree is mostly ordered correctly
                        // already, only insertions need to be corrected manually.
                        'sort': function(nodeId1, nodeId2) {
                            var inst = this;
                            var node1 = inst.get_node(nodeId1);
                            var node2 = inst.get_node(nodeId2);
                            // If the nodes are the same type then just compare lexicographically
                            if (node1.type === node2.type && node1.text != undefined && node2.text != undefined) {
                                // Unless they are experimenters and one of them is the current user.
                                if(node1.type === 'experimenter') {
                                    if (node1.data.obj.id === {{ ome.user_id }}) {
                                        return -1;
                                    } else if (node2.data.obj.id === {{ ome.user_id}}) {
                                        return 1;
                                    }
                                }
                                return node1.text.toLowerCase() <= node2.text.toLowerCase() ? -1 : 1;
                            // Otherwise explicitly order the type that might be siblings
                            } else {

                                function getRanking(node) {
                                    if (node.type === 'tagset') {
                                        return 1;
                                    } else if (node.type === 'tag') {
                                        return 2;
                                    }
                                }

                                var ranking1 = getRanking(node1);
                                var ranking2 = getRanking(node2);
                                return ranking1 <= ranking2 ? -1 : 1;
                            }
                        },
                        'locate' : {
                            // Returns a key for this node
                            'locate_function': function(node) {
                                // In some cases, this function is called before the data attribute exists
                                // These should be ignored, this will be called again later when it is
                                // populated.
                                if (!node.hasOwnProperty('data') ||
                                    node.data === undefined ||
                                    node.data === null) {
                                    return false;
                                }
                                return node.type + '-' + node.data.obj.id;
                            }
                        },
                        'conditionalselect' : {
                            // Checks if a selection should be allowed
                            'conditionalselect_function': function(node) {
                                // Disable deleted object nodes
                                if (node.type === 'deleted') {
                                    return false;
                                }

                                // Disable multi-type selection
                                var inst = this;
                                var selected = inst.get_selected(true);
                                // As this function will previously have prevented cross-select, just
                                // check the first selection instead.
                                if (selected.length > 0 && selected[0].type !== node.type) {
                                    return false;
                                }
                                return true;
                            }
                        },
                    });
            });
    </script>

    <!-- handle toolbar clicks -->
    <script type="text/javascript">
    $(function () {
        $(".toolbar input").click(function () {
            switch(this.id) {
                case "removecontentButton":
                    var confirm_remove = OME.confirm_dialog('Remove Image?',
                        function() {
                            if(confirm_remove.data("clicked_button") == "OK") {
                                var inst = $.jstree.reference('#dataTree');
                                inst.delete_node(inst.get_selected);
                            }
                        }
                    );
                    break;
                case "refreshButton":
                    $("#dataTree").jstree("refresh");
                    break;
                default:
                    break;
            }
        });
    });
    </script>

    <!-- include code to handle middle panel selection -->
    {% include "webclient/data/includes/center_plugin.thumbs.js.html" %}


{% endblock %}


{% block left %}

<div id="left_panel_tabs" class="absolute_fill ui-tabs">
    <ul id="left_panel_tab_list" class="ui-tabs-nav">
        <li id="explore_tab" class="ui-state-default"><a href="{% url 'load_template' 'userdata' %}" class="ui-tabs-anchor" title="Explore">{% trans "Explore" %}</a></li>
        <li id="tags_tab" class="ui-state-default"><a href="{% url 'load_template' 'usertags' %}" class="ui-tabs-anchor">{% trans "Tags" %}</a></li>
        <li id="public_tab" class="ui-state-default ui-tabs-active"><a class="ui-tabs-anchor">{% trans "Public" %}</a></li>
    </ul>

    <div id="Public">
        <div class="toolbar">
            <ul id="buttons">

                <li>
                    <input id="removecontentButton" class="button button-disabled" type="image" src="{% static "webclient/image/icon_toolbar_delete.png" %}" alt="Remove content" title="Remove content" /> 
                </li>

                <li class=seperator></li>

                <li>
                <input id="refreshButton" class="button" type="image" src="{% static "webclient/image/icon_toolbar_refresh.png" %}" alt="Refresh" title="Refresh"> 
                </li>

            </ul>
        </div>

        <div id="tree_details" class="left_panel_inner">
            <div class="datashareTree" id="dataTree"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block center %}

<!--<div id="content_action"></div>
<div class="clear"> </div>-->

<div id="content_details"> </div>

{% endblock %}


{% block right %}
<div>
    <div id="annotation_tabs" class="absolute_fill">
        <ul id="annotation_tabs_list">
            <li><a href="#metadata_general">{% trans "General" %}</a></li>
            <!-- include right tabs, as configured in settings.py under "omero.web.ui.right_tabs" -->
            {% for rt in ome.right_plugins %}
                <li><a href="#{{ rt.plugin_id }}">{{ rt.label }}</a></li>
            {% endfor %}
        </ul>
        <div id="metadata_general" class="right_tab_content" ></div>
        <!-- include right tab bodies, as configured in settings.py under "omero.web.ui.right_tabs" -->
        {% for rt in ome.right_plugins %}
            <div id="{{ rt.plugin_id }}" class="right_tab_content"></div>
        {% endfor %}
    </div>
</div>
{% endblock %}
