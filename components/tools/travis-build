#!/bin/sh
# This script is used for testing the build, primarily for use
# with travis, but may be used by hand as well.

set -e

if [ -z "$ICE_HOME" ]; then
  export ICE_HOME=/usr/share/Ice
fi

fold()
{
    printf "travis_fold:$1:$NAME.$2\n"
}

# Clean up
clean()
{
    ant clean
}

get_ice()
{
  ice=Ice-3.5.1-b1-ubuntu1204-amd64.tar.xz
  if [ ! -f "download/$ice" ]; then
    mkdir -p download
    cd download
    wget "http://downloads.openmicroscopy.org/ice/experimental/$ice"
    cd ..
  fi
  tar -xvf "download/$ice"
  ICE_HOME="$(pwd)/Ice-3.5.1-b1-ubuntu1204-amd64"
  export SLICEPATH="${ICE_HOME}/slice"
  export PATH="${ICE_HOME}/bin:$PATH"
  export LD_LIBRARY_PATH="${ICE_HOME}/lib:$LD_LIBRARY_PATH"
  export PYTHONPATH="${ICE_HOME}/python:$PYTHONPATH"
}

java_build()
{
    get_ice
    NAME=java_build
    fold start default
        TEST="-p" ant build-default -Dpackage-extra=false
    fold end default
    fold start tests
        TEST="-p" ant test-compile
    fold end tests
}

java_test()
{
    get_ice
    NAME=java_test
    for dir in dsl model common rendering server blitz
    do
        fold start $dir
        ant -f components/$dir/build.xml test -Dtest.with.fail=true -Dtestng.useDefaultListeners=true
        fold end $dir
    done

    # make sure that the current db script has no code-generated
    # foreign key names in it
    dist/bin/omero db script "" "" ome -f- | grep -LiE "fk[a-z]*[0-9]+[a-z0-9]{5}" && {
        echo generated FKs found
        exit 2
    } || {
        echo SQL clean
    }
}

py_flake8()
{
    flake8 .
}

py_build()
{
    get_ice
    NAME=py_build
    fold start default
        ant build-default -Dpackage-extra=false
    fold end default
}

py_test()
{
    get_ice
    NAME=py_test
    for dir in OmeroPy OmeroFS OmeroWeb
    do
        fold start $dir
        ant -f components/tools/$dir/build.xml test -Dtest.with.fail=true
        fold end $dir
    done

    fold start modules
    # make sure all OmeroWeb Python modules can be imported
    # (this will find invalid imports that flake8 does not check for)
    echo Checking OmeroWeb Python imports
    export PYTHONPATH=$PYTHONPATH:../target/lib/python
    ! ( cd components/tools/OmeroWeb ;
        find omeroweb -name "*.py" |
        cut -d "." -f -1 |
        grep -v __init__ |
        tr / . |
        xargs -n 1 echo import |
        tee /dev/stderr |
        python omeroweb/manage.py shell 2>&1 >/dev/null |
        grep -B2 ImportError
      )
    test $? = 0
    fold end modules
}

build_cpp()
{
    get_ice
    (
        cd components/tools/OmeroCpp
        mkdir build
        cd build
        (
            mkdir gtest
            cd gtest
            cmake /usr/src/gtest
            make
        )
        GTEST_ROOT=$(pwd)/gtest cmake ..
        make
#        make test
        make DESTDIR=../install install
#        make doc
    )
}

if [ $# -eq 0 ]
then
    get_ice
    clean
    build_java
    build_python
fi

for arg in "$@"
do
    case $arg in
        clean)
            clean ;;
        build-cpp)
            build_cpp ;;
        build-java)
            java_build && java_test ;;
        build-python)
            py_flake8 && py_build && py_test ;;
        java-build)
            java_build ;;
        java-test)
            java_test ;;
        py-flake8)
            py_flake8;;
        py-build)
            py_build ;;
        py-test)
            py_test ;;
        all)
            py_flake8 java_build java_test py_test ;;
        *)
            echo "Invalid argument: \"$arg\"" >&2
            exit 1
            ;;
    esac
done

exit 0
