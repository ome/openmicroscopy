<?xml version="1.0" encoding="utf-8"?>
<project name="OmeroImporter" default="install" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
#
# Copyright 2008 Glencoe Software, Inc. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
#
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore, josh at glencoesoftware.com
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-->
    <description>
        Build framework for the OmeroImporter GUI code. The shipped application
        is primarily built through the Eclipse .project and .classpath files,
        but this build is here to allow continuous integration testing.
    </description>

    <property name="main.class" value="ome.formats.importer.Main"/>

    <dirname property="up-two" file="${basedir}"/>
    <dirname property="up-one" file="${up-two}"/>
    <property name="import.dir"       value="${up-one}/antlib/resources"/>
	<property name="product.name" value="OMERO.importer"/>
    <import file="${import.dir}/global.xml"/>
    <import file="${import.dir}/lifecycle.xml"/>

    <import file="../common.xml"/>

	<path id="jarbundler.classpath">
		<fileset dir="${omero.home}/lib/repository" includes="jarbundler*.jar"/>
	</path>
	<taskdef name="jarbundler"
		classpathref="jarbundler.classpath"
		classname="net.sourceforge.jarbundler.JarBundler"/>

    <target name="package" depends="lifecycle.package">
        <copy todir="${target.dir}">
            <fileset dir="${basedir}" includes="config/**/*,importer-*"/>
        </copy>
        <chmod perm="a+x">
            <fileset dir="${target.dir}" includes="importer-*"/>
        </chmod>
        <jar destfile="${target.dir}/${ivy.module}.jar" update="true">
            <fileset dir="${resrc.dir}" includes="*.icns"/>
            <fileset dir="${src.dir}" includes="**/*.png"/>
        </jar>
    </target>
	
	<target name="release-zip" depends="package,install"
		description="Zip the OMERO.importer releases up">
	  <zip destfile="target/${product.name}-${omero.version}.zip">
		  <zipfileset dir="${basedir}" prefix="${product.name}-${omero.version}"
			  includes="config/**/*"/>
		  <zipfileset dir="${target.dir}" prefix="${product.name}-${omero.version}"
			  includes="libs/**/*,${ivy.module}.jar"/>
		  <zipfileset dir="${basedir}" prefix="${product.name}-${omero.version}"
			  includes="importer-*" filemode="755"/>
      </zip>
	</target>

	<target name="release-osx" depends="package,install"
		description="Create a MacOS X executable bundle">
		<jarbundler dir="${basedir}"
			name="OMERO.importer"
			mainclass="ome.formats.importer.Main"
			version="${omero.version}"
			infostring="OMERO.importer Java Client, ${omero.version}"
			aboutmenuname="OMERO.importer"
			screenmenu="true"
			icon="${basedir}/resources/omeroImporterLogo.icns"
			stubfile="${basedir}/JavaApplicationStub"
			jvmversion="1.5+"
			vmoptions="-Xmx512M">
			<jarfileset dir="${target.dir}/libs" includes="**"/>
			<jarfileset dir="${target.dir}" includes="${ivy.module}.jar"/>
		</jarbundler>
	</target>

	<target name="release-osx-zip" depends="release-osx"
		description="Zip up the OMERO.importer release for MacOS X">
	  <zip destfile="target/${product.name}-${omero.version}-mac.zip">
		  <zipfileset dir="${basedir}" prefix="${product.name}-${omero.version}"
			  includes="config/**/*,OMERO.importer.app/**/*"
			  excludes="**/JavaApplicationStub"/>
		  <zipfileset file="${basedir}/JavaApplicationStub" 
			  fullpath="${product.name}-${omero.version}/OMERO.importer.app/Contents/MacOS/JavaApplicationStub"
			  filemode="755"/> 
      </zip>
	</target>

    <target name="tools-init"/>

    <target name="tools-build" depends="tools-init,install" description="Creates all artifacts for tools/target"/>

    <target name="tools-dist" depends="tools-build,release-zip" description="Copied artifacts to tools/target" unless="skip.compile"/>

    <target name="tools-clean" depends="clean"/>

    <target name="retrieve-client-libs" description="Utility target for getting client libs">
        <installIvy/>
        <ivy:resolve file="${basedir}/ivy.xml" type="jar" conf="client" settingsRef="ivy.${ant.project.name}" log="quiet"/>
        <ivy:retrieve conf="client" pattern="${target.dir}/client-libs/[module]-[revision].[ext]" sync="true" log="quiet" settingsRef="ivy.${ant.project.name}"/>
    </target>

</project>
