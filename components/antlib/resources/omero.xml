<?xml version="1.0" encoding="utf-8"?>
<project name="omero" default="usage" basedir="."  xmlns:ivy="antlib:org.apache.ivy.ant">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
# 
# Copyright 2006 University of Dundee. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
# 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
  DOCUMENTATION:
  ==============================================================================
  This is the main build script for binary distributions and replaces the 
  main build script (OMERO_HOME/build.xml) in the OMERO_HOME/dist directories. 

  Several of these tasks are used by the components to prevent duplication.

-->

        <!-- Reproducing dependencies.xml locally -->
        <target name="deps-configure"> <ivy:resolve file="${basedir}/omero.ivy" type="jar" conf="server"/> </target>
        <target name="deps-buildlist"> <ivy:buildlist> <fileset dir="${basedir}" includes="build.xml"/> </ivy:buildlist> </target>
        <target name="deps-retrieve"> <!-- noop --> </target>
        <target name="deps-publish-local"> <!-- noop --> </target>
        <path id="omero.classpath">
          <fileset dir="${basedir}/lib/repository" includes="**/*.jar"/>
        </path>

	<property name="import.dir"       value="${basedir}/components/antlib/resources/"/>
	<property name="ivy.dep.file"  value="${basedir}/omero.ivy"/>
	<property name="ivy.buildlist.ivyfilepath"  value="${basedir}/omero.ivy"/>
	<import file="${import.dir}/global.xml"/>
	<import file="${import.dir}/setup.xml"/>
	<import file="${import.dir}/lifecycle.xml"/>
	<property file="${basedir}/etc/omero.properties"/>

	<!-- Patterns that will be saved -->
	<patternset id="etc.files">
		<include name="local.properties"/>
		<include name="local.properties.example"/>
		<include name="omero.properties"/>
		<include name="hibernate.properties"/>
		<include name="log4j.properties"/>
		<include name="c3p0.properties"/>
	</patternset>

	<target name="usage"
		description="Usage information">
		<concat>
			<filelist dir="${import.dir}" files="usage-omero.txt"/>
		</concat>
	</target>

	<target name="update">
		<fail>etc/local.properties does not exist. Try calling "setup"<condition>
		<not><available file="${basedir}/etc/local.properties"/></not></condition></fail>

		<!-- Touching the etc files to force update in the case that 
		the timezone or similar on a system has changed. Please refer to #779 

		This implies that the date on the files could also be the last time 
		of "ant update" rather than the last editing. -->
		<touch>
			<fileset dir="${basedir}/etc">
				<patternset refid="etc.files"/>
			</fileset>
		</touch>
		<jar update="true"
		  destfile="${product.final.name}">
			<fileset dir="${basedir}/etc">
				<patternset refid="etc.files"/>
			</fileset>
		</jar>
		<delete dir="${temp.dir}"/>

		<available file="${basedir}/blitz/blitz.jar" property="update.blitz"/>
                <antcall target="update-blitz" inheritAll="true" inheritRefs="true"/>
	</target>

	<target name="update-blitz" if="update.blitz">
		<jar update="true"
		  destfile="blitz/blitz.jar">
			<fileset dir="${basedir}/etc">
				<patternset refid="etc.files"/>
			</fileset>
		</jar>

	</target>

	<target name="earfiles">
		<fileset dir="${omero.home}" includes="*.ear" id="ear.files"/>
	</target>

	<target name="deploy" depends="update" description="Copy *.ear to JBOSS_HOME/server/default/deploy">
                <fail unless="env.JBOSS_HOME"/>
		<property name="jboss.deploy.dir" value="${env.JBOSS_HOME}/server/default/deploy"/>
		<property name="jboss.deploy.dir" value="${env.JBOSS_HOME}/server/default/deploy"/>
		<copy todir="${jboss.deploy.dir}">
			<fileset dir="${basedir}" includes="*.ear,*.war"/>
		</copy>
	</target>

</project>

