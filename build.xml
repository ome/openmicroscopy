<?xml version="1.0" encoding="utf-8"?>
<project name="main" default="usage" basedir="."  xmlns:ivy="antlib:org.apache.ivy.ant">
<!--
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
# $Id$
# 
# Copyright 2006 University of Dundee. All rights reserved.
# Use is subject to license terms supplied in LICENSE.txt
# 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Written by:  Josh Moore <josh.moore@gmx.de>
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    
  DOCUMENTATION:
  =================================================

  To use this script you need only have downloaded
  the source code (either from subversion or as
  distribution). The build system can be used by 
  calling:

    java omero <arguments>

  from within the OMERO_HOME directory (this is 
  what you checked out of subversion and where this
  file is located).

-->

	<property name="import.dir" value="${basedir}/components/antlib/resources"/>
	<import file="${import.dir}/global.xml"/>
	<import file="${import.dir}/setup.xml"/>
	<import file="${import.dir}/dependencies.xml"/>
	<import file="${import.dir}/multiproject.xml"/>

	<target name="help" depends="usage"/>
	<target name="usage"
		description="Usage information">
		<concat>
			<filelist dir="${import.dir}" files="usage-ant.txt"/>
		</concat>
	</target>
	<target name="all-help"
		description="Print all help targets">
		<echo>
		  help                  -- Simple build help
		  help-deps             -- Help on dependency management
		  help-life             -- Help on lifecycle targets (compile, test, ...)
		  help-setup            -- Help on setup targets
		  help-server           -- Help on server management
		  help-release          -- Help on release process
		</echo>
	</target>
	

<!-- 	===============================================
		BUILD
==================================================  -->
	<target name="fullbuild" depends="check-system,clean,build,reload-db"
		description="Extensive build which checks and cleans the build environment, builds, and setups the database"/>

	<target name="build" depends="install"
		description="A simple build that will install all artifacts to ${omero.repo.local}"/>

	<target name="deploy" depends="check-system">
		<iterate buildpathref="app.buildpath" target="deploy"/>
	</target>

	<target name="fulldeploy" depends="fullbuild,deploy"/>

	<target name="clean" depends="multiproject"
		description="Lifecycle target: calls 'clean' on all components">
		<iterate target="clean"/>
		<delete dir="${dist.dir}"/>
		<delete dir="${lib.dir}/cache"/>
	</target>

	<target name="withtools"
		description="Calls build and dist on the tools component, copying over dist/">
		<iterate buildpathref="tools.buildpath" target="build"/>
		<iterate buildpathref="tools.buildpath" target="dist"/>
	</target>

	<target name="cleantools"
		description="Calls cleans on the tools component and removes tools/target">
		<iterate buildpathref="tools.buildpath" target="clean"/>
	</target>

	<target name="zip">
		<zip destfile="${product.name}-${omero.version}.zip">
			<zipfileset dir="${dist.dir}" prefix="${product.name}-${omero.version}"
                            excludes="bin/omero"/>
			<zipfileset dir="${dist.dir}" prefix="${product.name}-${omero.version}"
                            includes="bin/omero"
                            filemode="755"/>
		</zip>
	</target>

	<target name="tar">
		<tar destfile="${product.name}-${omero.version}.tar.bz2" compress="bzip2">
			<zipfileset dir="${dist.dir}" prefix="${product.name}-${omero.version}"/>
		</tar>
	</target>

<!-- 	===============================================
		Mgmt Targets
	==================================================  -->

	<target name="reload-db">
		<iterate buildpathref="server.buildpath" target="reload-db"/>
	</target>

	<target name="addgroup">
		<iterate buildpathref="client.buildpath" target="addgroup"/>
	</target>

	<target name="adduser">
		<iterate buildpathref="client.buildpath" target="adduser"/>
	</target>

	<target name="dist" depends="multiproject,_dist">
		<iterate target="dist"/>
                <mkdir dir="${dist.dir}/bin"/>
                <chmod perm="a+x">
                        <fileset dir="${dist.dir}/bin" includes="omero"/>
                        <fileset dir="${dist.dir}/lib" includes="**/*.py"/>
                </chmod>
	</target>

	<target name="_dist" depends="deps-configure">
		<mkdir dir="${dist.dir}"/>
		<!-- 
			etc/
			========================================================
			Copies example property files to the ${dist.dir}
			for use by the user to configure the install.
		-->
		<copy todir="${dist.dir}/etc" overwrite="true">
			<fileset dir="${omero.home}/etc">
				<exclude name="local.properties"/>
			</fileset>
		</copy>

		<!-- 
			Copies ...
		-->
		<copy todir="${dist.dir}">
			<fileset dir="${omero.home}">
				<include name="omero.class"/>
				<include name="components/antlib/**"/>
				<include name="sql/**"/>
				<include name="lib/tools/**"/>
			</fileset>
		</copy>

		<mkdir dir="${dist.dir}/client"/>
		<ivy:resolve file="${import.dir}/omero.ivy" type="jar" conf="client" transitive="false"/>
		<ivy:retrieve conf="client" pattern="${dist.dir}/client/[module]-[revision].[ext]" sync="true"/>
		<mkdir dir="${dist.dir}/lib/repository"/>
		<ivy:resolve file="${import.dir}/omero.ivy" type="jar" conf="server" transitive="true"/>
		<ivy:retrieve conf="server" pattern="${dist.dir}/lib/repository/[module]-[revision].[ext]" sync="true"/>

		<!-- Copy new build.xml to ${dist.dir} -->
                <copy
                        file="${import.dir}/omero.xml"
                        tofile="${dist.dir}/build.xml"
                        overwrite="true"
                />
                <copy
                        file="${import.dir}/omero.ivy"
                        tofile="${dist.dir}/omero.ivy"
                        overwrite="true"
                />

	</target>

	<target name="get-libs">
		<property name="deps.build.dir" value="${omero.home}"/>
		<antcall target="deps-retrieve" inheritAll="true" inheritRefs="true"/>
	</target>

	 <target name="findbugs" depends="multiproject" description="Generates findbugs.xml and checkstyle.xml for all components">
		<iterate target="findbugs"/>
		<iterate buildpathref="tools.buildpath" target="findbugs"/>
	 </target>

	 <target name="coverage" depends="get-libs"
		description="Merge code coverage reports into single top-level report">
		<taskdef resource="emma_ant.properties" classpathref="omero.classpath" />
		<emma>
			<merge outfile="${target.dir}/coverage.es" >
				<fileset dir="components" includes="**/target/coverage.emma,**/target/metadata.emma"/>
			</merge>
			<report sourcepath="${src.dir}" >
				<fileset dir="${target.dir}" includes="coverage.es"/>
				<html outfile="${target.dir}/coverage.html" />
				<xml outfile="${target.dir}/coverage.xml" />
			</report>
		</emma>
	 </target>

</project>
